<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>初窺ARM平坦化還原 | NgIokWeng's Blog</title><meta name="keywords" content="ollvm,Android逆向"><meta name="author" content="NgIokWeng"><meta name="copyright" content="NgIokWeng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="初窺ARM平坦化還原">
<meta property="og:type" content="article">
<meta property="og:title" content="初窺ARM平坦化還原">
<meta property="og:url" content="https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/index.html">
<meta property="og:site_name" content="NgIokWeng&#39;s Blog">
<meta property="og:description" content="初窺ARM平坦化還原">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png">
<meta property="article:published_time" content="2024-06-08T06:44:17.000Z">
<meta property="article:modified_time" content="2024-06-08T06:44:17.740Z">
<meta property="article:author" content="NgIokWeng">
<meta property="article:tag" content="ollvm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png"><link rel="shortcut icon" href="/myImg/blogIcon.png"><link rel="canonical" href="https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="google-site-verification" content="iO5LJpaf7bluC9CxlRdPhowI-XL-OzJ-X6ixOkO3cuk"/><meta name="baidu-site-verification" content="code-ZZyU1mBcxX"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '初窺ARM平坦化還原',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-08 14:44:17'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/myCustom.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">載入中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/myImg/blogIcon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">NgIokWeng's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">初窺ARM平坦化還原</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2024-06-08T06:44:17.000Z" title="發表於 2024-06-08 14:44:17">2024-06-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2024-06-08T06:44:17.740Z" title="更新於 2024-06-08 14:44:17">2024-06-08</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E9%80%86%E5%90%91/">Android逆向</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="初窺ARM平坦化還原"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上周在看DASCTF的題發現難得有一道安卓( 題目名：RealeazyRealeazy )，興致勃勃地打開IDA卻發現了這可悲的控制流平坦化，當場直接自閉…</p>
<p>之後分析了下發現這ollvm應該算是比較簡單的那類( 只有間接跳轉 + 最普通的平坦化，貌似沒有虛假分支/虛假塊 )，於是決定好好地學習下怎麼還原。</p>
<p>一開始是想按「<a target="_blank" rel="noopener" href="https://missking.cc/2021/05/14/ollvm3/">使用unidbg还原标准ollvm的fla控制流程平坦化</a>」一樣使用Unidbg來還原，後面發現分支的情況用Unidbg不太好處理。</p>
<p>最後還是決定用Unicorn的模擬執行來還原，具體思路&amp;實現完全參考「<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-252321.htm">[原创]ARM64 OLLVM反混淆</a>」。</p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png" alt="Untitled"></p>
<h2 id="還原思路"><a href="#還原思路" class="headerlink" title="還原思路"></a>還原思路</h2><p>利用Unicorn來模擬執行，從而獲取程序的執行流程，主要有以下步驟：</p>
<ol>
<li>識別&amp;保存函數所有的真實塊，有兩種識別思路，要麼通過真實塊的特徵，要麼通過非真實塊的特徵，看哪種特徵比較明顯，對本例來說真實塊有個明顯的特徵就是<code>mov pc, r0</code>這樣的間接跳轉。</li>
<li>模擬執行並保存執行路徑，遇到分支時就手動修改寄存器的值來遍歷( 本例沒有虛假分支，不用考慮太多，直接2條分支都執行就可以 )。<br>模擬執行過程中遇到<code>bl</code>、<code>blx</code>這樣的函數調用時可以直接跳過( 通過修改<code>PC</code>來實現 )，因為我們關注的只有執行流程，同理遇到一些Unicorn無法解析的指令時也是直接跳過就可以( 只要不是真實塊的頭/尾指令就可以 )</li>
<li>根據上述得出的執行流來patch。</li>
</ol>
<h2 id="具體實現"><a href="#具體實現" class="headerlink" title="具體實現"></a>具體實現</h2><h3 id="collect-blocks"><a href="#collect-blocks" class="headerlink" title="collect_blocks"></a><code>collect_blocks</code></h3><p>首先是收集各種塊的邏輯，通過<code>capstone</code>來遍歷so文件，<code>offset</code>和<code>end</code>分別是某函數的起始、結束地址，<code>block_list</code>用來保存所有塊( 以塊的起始地址作為鍵，而值是包含當前塊各種信息的<code>block_item</code> )。</p>
<p>如何判斷塊的結尾？通過觀察so文件可以知道，一個塊要麼以<code>mov pc, r0</code>結束，要麼以<code>b XXX</code>結束，而前者更是真實塊的特徵。</p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled1.png" alt="Untitled"></p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled2.png" alt="Untitled"></p>
<p>除了真實塊外，預處理塊也是以<code>mov pc,r0</code>結尾，顯然需要將其排除在外，不能讓其保存在<code>real_blocks</code>中。這裡我使用了IDA Python來提前找出所有預處理器的起始地址，實現思路是遍歷找出那些入度為<code>n</code>且出度為<code>1</code> 的塊( 很簡單但對本例很有效 )。</p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled3.png" alt="Untitled"></p>
<ul>
<li>IDA Python script for finding preprocessor  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_xref</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_segment</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_cref_to</span>(<span class="params">addr</span>):</span><br><span class="line">    all_xref = []</span><br><span class="line">    ref = ida_xref.get_first_cref_to(addr)</span><br><span class="line">    <span class="keyword">while</span> ref != <span class="number">0xffffffff</span>:</span><br><span class="line">        all_xref.append(ref)</span><br><span class="line">        ref = ida_xref.get_next_cref_to(addr, ref)</span><br><span class="line">    <span class="keyword">return</span> all_xref</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_cref_from</span>(<span class="params">addr</span>):</span><br><span class="line">    all_xref = []</span><br><span class="line">    ref = ida_xref.get_first_cref_from(addr)</span><br><span class="line">    <span class="keyword">while</span> ref != <span class="number">0xffffffff</span>:</span><br><span class="line">        all_xref.append(ref)</span><br><span class="line">        ref = ida_xref.get_next_cref_from(addr, ref)</span><br><span class="line">    <span class="keyword">return</span> all_xref</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_preproc</span>(<span class="params">addr</span>):</span><br><span class="line">    all_xref_to = get_all_cref_to(addr)</span><br><span class="line">    all_xref_from = get_all_cref_from(addr)</span><br><span class="line">    <span class="comment"># 多個入度(具體取值要看情況) &amp;&amp; 一個出度</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(all_xref_to) &gt; <span class="number">5</span> <span class="keyword">and</span> <span class="built_in">len</span>(all_xref_from) == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">preproc_addr_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_preprocessor</span>(<span class="params">seg</span>):</span><br><span class="line">    <span class="keyword">global</span> preproc_addr_list</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;====================================&quot;</span>)</span><br><span class="line">    addr = seg.start_ea</span><br><span class="line">    end_addr = seg.end_ea</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> addr &lt; end_addr:</span><br><span class="line">        <span class="keyword">if</span> is_preproc(addr):</span><br><span class="line">            preproc_addr_list.append(addr)</span><br><span class="line">        addr = idc.next_head(addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    get_preprocessor(ida_segment.get_segm_by_name(<span class="string">&#x27;.mytext&#x27;</span>))</span><br><span class="line">    get_preprocessor(ida_segment.get_segm_by_name(<span class="string">&#x27;.text&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(preproc_addr_list)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具體實現代碼如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">collect_blocks</span>(<span class="params">offset, end, ret_addr</span>):</span><br><span class="line">    <span class="keyword">global</span> block_list <span class="comment"># 保存所有塊</span></span><br><span class="line">    <span class="keyword">global</span> real_blocks <span class="comment"># 保存真實塊</span></span><br><span class="line">    <span class="keyword">global</span> ret_blocks <span class="comment"># 保存ret 塊</span></span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line"></span><br><span class="line">    block_list = &#123;&#125;</span><br><span class="line">    real_blocks = []</span><br><span class="line">    ret_blocks = []</span><br><span class="line"></span><br><span class="line">    md = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    md.detail = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    preproc_flag = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ins_str = <span class="string">&quot;&quot;</span></span><br><span class="line">    is_new = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> dasm <span class="keyword">in</span> md.disasm(sodata[offset:end], offset):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 這裡是數據, 不用保存為block</span></span><br><span class="line">        <span class="keyword">if</span> dasm.address &gt;= <span class="number">0x612E</span> <span class="keyword">and</span> dasm.address &lt; <span class="number">0x617C</span>:</span><br><span class="line">            <span class="keyword">continue</span> </span><br><span class="line"></span><br><span class="line">        ins_str += <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(dasm.address)&#125;</span>:\t<span class="subst">&#123;dasm.mnemonic&#125;</span>\t<span class="subst">&#123;dasm.op_str&#125;</span>\n&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在塊的起如地址保存對應信息</span></span><br><span class="line">        <span class="keyword">if</span> is_new:</span><br><span class="line">            is_new = <span class="literal">False</span></span><br><span class="line">            block_item = &#123;&#125;</span><br><span class="line">            block_item[<span class="string">&quot;start_addr&quot;</span>] = dasm.address</span><br><span class="line">            block_item[<span class="string">&quot;capstone&quot;</span>] = dasm</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判斷當前地址是否預處理器的起始地址</span></span><br><span class="line">        <span class="keyword">if</span> is_preproc(dasm.address):</span><br><span class="line">            preproc_flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_block_end(dasm):</span><br><span class="line">            is_new = <span class="literal">True</span></span><br><span class="line">            block_item[<span class="string">&quot;end_addr&quot;</span>] = dasm.address</span><br><span class="line">            block_item[<span class="string">&quot;ins_str&quot;</span>] = ins_str</span><br><span class="line">            ins_str = <span class="string">&quot;&quot;</span></span><br><span class="line">            block_list[block_item[<span class="string">&quot;start_addr&quot;</span>]] = block_item</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 初步獲取real_blocks, 這個特徵僅針對本例</span></span><br><span class="line">            <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> dasm.op_str == <span class="string">&quot;pc, r0&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> preproc_flag:</span><br><span class="line">                    preproc_flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    real_blocks.append(block_item[<span class="string">&quot;start_addr&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 手動添加arm的ret block (從IDA裡找出度為0的那塊)</span></span><br><span class="line">    ret_blocks.append(ret_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_block_end</span>(<span class="params">dasm</span>):</span><br><span class="line">    <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> dasm.op_str == <span class="string">&quot;pc, r0&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;b&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_preproc</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="comment"># 由IDA Python得出</span></span><br><span class="line">    preprocessor_addrs = [<span class="number">27514</span>, <span class="number">3200</span>, <span class="number">5784</span>, <span class="number">10490</span>, <span class="number">15456</span>, <span class="number">17002</span>, <span class="number">19836</span>, <span class="number">20578</span>, <span class="number">22440</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr <span class="keyword">in</span> preprocessor_addrs</span><br></pre></td></tr></table></figure>

<h3 id="init-unicorn"><a href="#init-unicorn" class="headerlink" title="init_unicorn"></a><code>init_unicorn</code></h3><p>初始化Unicorn的模擬執行環境，這裡我們不需要考慮傳參之類的東西。<code>hook_code</code>是指令hook的回調函數，也是最關鍵的邏輯所在，後面會重點介紹。<code>hook_mem_access</code>是內存訪問異常時的回調，對本例的用處不大。</p>
<p>這裡設置<code>.data</code>節是因為程序的間接條跳依賴於其中的數據，若不添加程序將無法執行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">init_unicorn</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(sodata, <span class="built_in">bytearray</span>):</span><br><span class="line">        sodata = <span class="built_in">bytes</span>(sodata)</span><br><span class="line"></span><br><span class="line">    mu = Uc(UC_ARCH_ARM, UC_MODE_THUMB)</span><br><span class="line">    mu.mem_map(<span class="number">0x80000000</span>, <span class="number">0x1000</span> * <span class="number">8</span>) <span class="comment"># 初始化stack</span></span><br><span class="line">    mu.mem_map(<span class="number">0</span>, <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    mu.mem_write(<span class="number">0</span>, sodata)</span><br><span class="line">    mu.reg_write(UC_ARM_REG_SP, <span class="number">0x80000000</span> + <span class="number">0x1000</span> * <span class="number">4</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_UNMAPPED, hook_mem_access)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 設置.data節</span></span><br><span class="line">    data_section = get_section(filename, <span class="string">&#x27;.data&#x27;</span>)</span><br><span class="line">    DATA_MEM_OFFSET = data_section.header[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">    DATA_FILE_OFFSET = data_section.header[<span class="string">&quot;sh_offset&quot;</span>]</span><br><span class="line">    DATA_SIZE = data_section.header[<span class="string">&quot;sh_size&quot;</span>]</span><br><span class="line">    mu.mem_write(DATA_MEM_OFFSET, sodata[DATA_FILE_OFFSET:DATA_FILE_OFFSET+DATA_SIZE])</span><br></pre></td></tr></table></figure>

<h3 id="start-emu"><a href="#start-emu" class="headerlink" title="start_emu"></a><code>start_emu</code></h3><p>正式開始模擬執行，會模擬執行若干次，每次會從某真實塊出發，直到找到另一個真實塊/結束塊為至。</p>
<p>用<code>queue</code>來保存模擬執行的順序以及對應的上下文，保存上下文是因為分支要走兩條路，當走完一條分支時通過恢復上下文來達到一種回溯的效果，從而繼續走第二條分支。通過這種方法就能遍歷完所有可能的真實塊，但對於有虛假分支的情況，這樣做可能會導致死循環，但反過來想也是一種檢測虛假分支的思路。</p>
<p><code>itt</code>是本例的真實塊裡的分支指令，具體處理的邏輯在<code>hook_code</code>中，這裡提前判斷的目的是為了手動控制分支的走向。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_emu</span>(<span class="params">offset</span>):</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line">    <span class="keyword">global</span> flow</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> offset <span class="keyword">in</span> real_blocks:</span><br><span class="line">        real_blocks.remove(offset)</span><br><span class="line"></span><br><span class="line">    queue = [(offset, <span class="literal">None</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存執行流, 最終patch就是靠它</span></span><br><span class="line">    flow = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    is_success = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(queue) != <span class="number">0</span>:</span><br><span class="line">        env = queue.pop()</span><br><span class="line">        pc = env[<span class="number">0</span>]</span><br><span class="line">        set_context(env[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        item = block_list[pc]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 代表對應的路徑已被記錄, 無需重複</span></span><br><span class="line">        <span class="keyword">if</span> pc <span class="keyword">in</span> flow:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        flow[pc] = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分支, 例如 0x62D6, 0x5FA2</span></span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;ins_str&quot;</span>].find(<span class="string">&quot;itt&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">            ctx = get_context()</span><br><span class="line"></span><br><span class="line">            p1 = find_path(pc, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> p1 != <span class="literal">None</span>:</span><br><span class="line">                queue.append((p1, get_context()))</span><br><span class="line">                flow[pc].append(p1)</span><br><span class="line">            set_context(ctx)</span><br><span class="line">            p2 = find_path(pc, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> p1 != p2:</span><br><span class="line">                queue.append((p2, get_context()))</span><br><span class="line">                flow[pc].append(p2)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = find_path(pc)</span><br><span class="line">            <span class="keyword">if</span> p != <span class="literal">None</span>:</span><br><span class="line">                queue.append((p, get_context()))</span><br><span class="line"></span><br><span class="line">            flow[pc].append(p)</span><br></pre></td></tr></table></figure>

<h3 id="find-path"><a href="#find-path" class="headerlink" title="find_path"></a><code>find_path</code></h3><p><code>find_path</code>的返回值是某真實塊的起始地址( 通過<code>block_list</code>能獲取該塊的所有信息 )。</p>
<p>在報錯時直接跳過導致報錯的指令( 通常是由於Unicorn不兼容某些指令所導致的報錯 )，可以直接跳過的原因是我們只關注會影響執行流的指令，其他無需理會。</p>
<p>要特別注意的是，本例是Thumb Mode，因此模擬執行的地址必須<code>|1</code>，否則會導致一連串奇怪的事情( 一開始沒留意被坑了很久…… )。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">start_addr, branch = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> real_blocks</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> g_start_addr</span><br><span class="line">    <span class="keyword">global</span> branch_control</span><br><span class="line">    <span class="keyword">global</span> list_trace</span><br><span class="line">    <span class="keyword">global</span> dst_addr</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line"></span><br><span class="line">    branch_control = branch</span><br><span class="line">    g_start_addr = start_addr</span><br><span class="line">    list_trace = &#123;&#125;</span><br><span class="line">    dst_addr = <span class="number">0</span></span><br><span class="line">    is_success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(start_addr | <span class="number">1</span>, start_addr + <span class="number">0x10000</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;============= emu end =============&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        pc = mu.reg_read(UC_ARM_REG_PC)</span><br><span class="line">        <span class="keyword">if</span> pc != <span class="number">0</span>:</span><br><span class="line">            <span class="comment">#mu.reg_write(UC_ARM64_REG_PC, pc + 4)</span></span><br><span class="line">            <span class="comment"># Thumb指令, 長度可能是2/4, 因此要動態獲取</span></span><br><span class="line">            _size = get_ins_size(pc)</span><br><span class="line">            <span class="keyword">return</span> find_path(pc + _size, branch)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ERROR: %s  pc:%x&quot;</span> % (e,pc))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_success:</span><br><span class="line">        <span class="keyword">return</span> dst_addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="hook-code"><a href="#hook-code" class="headerlink" title="hook_code"></a><code>hook_code</code></h3><p>最關鍵的邏輯，主要分成以下幾部分：</p>
<ol>
<li>判斷當前地址是否屬於<code>real_blocks</code>或<code>ret_blocks</code>，是則將該地址保存到<code>dst_addr</code>然後停止本次模擬執行。</li>
<li>判斷當前指令是否函數調用，是則修改PC的值以此跳過該函數調用，記得要<code>|1</code>，這點特別坑！！！</li>
<li>判斷<code>branch_control</code>是否有值，是則代表需要處理分支的情況，當<code>branch_control</code>為<code>0</code>時執行False分支( 根據條件修改對應寄存器 )，以下圖為例，False分支是不執行紅框部分的那條分支，這點在最後的patch時會用到。</li>
</ol>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled4.png" alt="Untitled"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> branch_control</span><br><span class="line">    <span class="keyword">global</span> g_start_addr</span><br><span class="line">    <span class="keyword">global</span> list_trace</span><br><span class="line">    <span class="keyword">global</span> dst_addr</span><br><span class="line">    <span class="keyword">global</span> end</span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_success <span class="keyword">or</span> address &gt; end:</span><br><span class="line">        mu.emu_stop()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    ban_ins = [<span class="string">&quot;bl&quot;</span>, <span class="string">&quot;blx&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> address <span class="keyword">in</span> [<span class="number">0x5ED6</span>]:</span><br><span class="line">        <span class="comment"># for debug</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;debug addr: &quot;</span>, <span class="built_in">hex</span>(address))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> md.disasm(sodata[address:address+size], address):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x&quot;</span> % (address, size))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; 0x%x:\t%s\t%s\t%d&quot;</span> % (ins.address, ins.mnemonic, ins.op_str, ins.size))</span><br><span class="line">        </span><br><span class="line">        print_regs()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">in</span> real_blocks:</span><br><span class="line">            <span class="keyword">if</span> address <span class="keyword">in</span> list_trace:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;have fake block?&quot;</span>)</span><br><span class="line">                uc.emu_stop()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                list_trace[address] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> address != g_start_addr:</span><br><span class="line">                is_success = <span class="literal">True</span></span><br><span class="line">                dst_addr = address</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;find: <span class="subst">&#123;<span class="built_in">hex</span>(address)&#125;</span>&quot;</span>)</span><br><span class="line">                uc.emu_stop()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">in</span> ret_blocks:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;end_block: <span class="subst">&#123;<span class="built_in">hex</span>(address)&#125;</span> &quot;</span>)</span><br><span class="line">            mu.emu_stop()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        flag_pass = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> ban_ins:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic.find(b) != -<span class="number">1</span>:</span><br><span class="line">                flag_pass = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 內存操作 (對本例用處不大)</span></span><br><span class="line">        <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># R7是棧底寄存器, 通常用來取局部變量</span></span><br><span class="line">            <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[r7&quot;</span>) != -<span class="number">1</span> <span class="keyword">and</span> ins.op_str.find(<span class="string">&quot;0xf4&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[sp&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                flag_pass = <span class="literal">True</span>         </span><br><span class="line">                <span class="keyword">for</span> op <span class="keyword">in</span> ins.operands:</span><br><span class="line">                    <span class="keyword">if</span> op.<span class="built_in">type</span> == ARM_OP_MEM:</span><br><span class="line">                        reg_name = ins.reg_name(op.value.base)</span><br><span class="line">                        addr = mu.reg_read(reg_ctou(reg_name))</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> addr &gt;= <span class="number">0x80000000</span> <span class="keyword">and</span> addr &lt; <span class="number">0x80000000</span> +  <span class="number">0x10000</span> * <span class="number">8</span>:</span><br><span class="line">                            flag_pass = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> flag_pass:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[pass] addr: <span class="subst">&#123;<span class="built_in">hex</span>(ins.address)&#125;</span> size: <span class="subst">&#123;ins.size&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 關鍵點: 要 |1</span></span><br><span class="line">            uc.reg_write(UC_ARM_REG_PC, (ins.address + ins.size) | <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># uc.reg_write(UC_ARM_REG_PC, address + size)</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> branch_control == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ollvm 分支</span></span><br><span class="line">        <span class="comment"># branch_control == 1代表條件成立, 如 cmp r1,r2、beq XXX -&gt; r1 == r2 (目的是方便後續的patch)</span></span><br><span class="line">        next_dasm = get_dasm(ins.address + ins.size, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">if</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;ne&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startsWith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(ops[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> ins.mnemonic == <span class="string">&quot;tst&quot;</span>: <span class="comment"># tst r2, r3  ---&gt; r2 &amp; r3 , 改變z標誌</span></span><br><span class="line">                regs = [reg_ctou(x) <span class="keyword">for</span> x <span class="keyword">in</span> ins.op_str.split(<span class="string">&quot;, &quot;</span>)]</span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(regs[<span class="number">0</span>], <span class="number">0</span>)</span><br><span class="line">                    mu.reg_write(regs[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(regs[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">                    mu.reg_write(regs[<span class="number">1</span>], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 例: cmp r2, r3, cmp是r2 - r3, 當結果&lt;0時, blt、bmi都會執行</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;lt&quot;</span> <span class="keyword">or</span> \</span><br><span class="line">            next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;mi&quot;</span> <span class="keyword">or</span> \</span><br><span class="line">            next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;lo&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># gt 是大於</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;gt&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># eq 是等於</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;eq&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;ollvm branch new type&quot;</span>)</span><br><span class="line">                 </span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<h3 id="start-patch"><a href="#start-patch" class="headerlink" title="start_patch"></a><code>start_patch</code></h3><p><code>start_emu</code>結束後的<code>flow</code>如下圖所示，很容易可以看到其中的規律，利用BFS來遍歷簡直再合適不過。</p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled5.png" alt="Untitled"></p>
<p>對於無分支的真實塊，可以直接通過<code>b</code>指令來跳轉，也可像我這樣修改<code>r0</code>來跳轉，因為本例本身就是將<code>r0</code>賦給<code>pc</code>來實現間接跳轉的，同時需要將一些字節patch為<code>nop</code>以防被干擾。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_patch</span>(<span class="params">flow, start_addr</span>):</span><br><span class="line">    <span class="keyword">global</span> block_list</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    sodata = <span class="built_in">bytearray</span>(sodata)</span><br><span class="line"></span><br><span class="line">    visited = &#123;&#125;</span><br><span class="line">    queue = [start_addr]</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(queue) != <span class="number">0</span>:</span><br><span class="line">        current_addr = queue.pop()</span><br><span class="line">        <span class="keyword">if</span> current_addr <span class="keyword">in</span> visited <span class="keyword">or</span> current_addr == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        visited[current_addr] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        next_blocks = flow[current_addr]</span><br><span class="line"></span><br><span class="line">        rb_end_addr = block_list[current_addr][<span class="string">&quot;end_addr&quot;</span>]</span><br><span class="line">        rb_start_addr = block_list[current_addr][<span class="string">&quot;start_addr&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 無分支的情況</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(next_blocks) == <span class="number">1</span>:</span><br><span class="line">            queue.append(next_blocks[<span class="number">0</span>])</span><br><span class="line">            <span class="comment"># 對本例, patch地址固定為真實塊最後指令地址 - 10</span></span><br><span class="line">            patch_addr = rb_end_addr - <span class="number">10</span></span><br><span class="line"></span><br><span class="line">            next_start_addr = queue[-<span class="number">1</span>]</span><br><span class="line">            patch_nop(patch_addr, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> next_start_addr != <span class="literal">None</span>:</span><br><span class="line">                asm_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;mov r0, #<span class="subst">&#123;<span class="built_in">hex</span>(next_start_addr)&#125;</span>&quot;</span>)</span><br><span class="line">                patch_bytes(patch_addr, asm_bytes)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;  <span class="subst">&#123;<span class="built_in">hex</span>(next_start_addr)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                ret_block_addr = ret_blocks[<span class="number">0</span>]</span><br><span class="line">                asm_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;mov r0, #<span class="subst">&#123;<span class="built_in">hex</span>(ret_block_addr)&#125;</span>&quot;</span>)</span><br><span class="line">                patch_bytes(patch_addr, asm_bytes)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;  ret block: <span class="subst">&#123;<span class="built_in">hex</span>(ret_block_addr)&#125;</span>&quot;</span>)</span><br><span class="line">                </span><br><span class="line">        <span class="comment"># 2. 有分支的情況</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queue.append(next_blocks[<span class="number">0</span>])</span><br><span class="line">            queue.append(next_blocks[<span class="number">1</span>])</span><br><span class="line">            b0 = next_blocks[<span class="number">0</span>] <span class="comment"># branch_control為0的分支, False分支</span></span><br><span class="line">            b1 = next_blocks[<span class="number">1</span>] <span class="comment"># branch_control為1的分支, True分支</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># patch_addr = rb_end_addr - 28</span></span><br><span class="line">            patch_addr = get_branch_pa(rb_start_addr) <span class="comment"># find &quot;itt&quot; addr</span></span><br><span class="line">            patch_branch(patch_addr, b0, b1)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;\n\t1. <span class="subst">&#123;<span class="built_in">hex</span>(b0)&#125;</span>\n\t2. <span class="subst">&#123;<span class="built_in">hex</span>(b1)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分支是像<code>cmp r0,0; itt ne</code>這樣的組合，只需將<code>itt ne</code>patch成<code>bne addr1; b addr2</code>就可以。傳入的<code>addr</code>就是<code>itt ne</code>的地址。</p>
<p>對於條件跳轉如<code>beq</code>、<code>bne</code>等，其<code>跳轉的地址 = 目標地址 - 當前地址 - 4</code>；而無條件跳轉直接跳到對應的絕對地址就可以。</p>
<p>條件跳轉後面跟的地址是<code>b1_addr</code>，這是True分支的真實塊的地址，這樣的處理是為了對應上述<code>hook_code</code>對分支的處理，兩者是有聯系的，不能隨便來。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">patch_branch</span>(<span class="params">addr, b0, b1</span>):</span><br><span class="line">    dasm = get_dasm(addr, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">assert</span> dasm.mnemonic == <span class="string">&quot;itt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>:\t<span class="subst">&#123;dasm.mnemonic&#125;</span>\t<span class="subst">&#123;dasm.op_str&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    patch_nop(addr, <span class="number">28</span> + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    b1_addr = b1 - addr - <span class="number">4</span></span><br><span class="line">    b0_addr = b0</span><br><span class="line"></span><br><span class="line">    branch_true_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;b<span class="subst">&#123;dasm.op_str&#125;</span> #<span class="subst">&#123;<span class="built_in">hex</span>(b1_addr)&#125;</span>&quot;</span>, addr)</span><br><span class="line">    branch_false_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;b <span class="subst">&#123;<span class="built_in">hex</span>(b0_addr)&#125;</span>&quot;</span>, addr + <span class="built_in">len</span>(branch_true_bytes))</span><br><span class="line"></span><br><span class="line">    patch_bytes(addr, branch_true_bytes)</span><br><span class="line">    patch_bytes(addr + <span class="built_in">len</span>(branch_true_bytes), branch_false_bytes)</span><br></pre></td></tr></table></figure>

<h2 id="完整腳本"><a href="#完整腳本" class="headerlink" title="完整腳本"></a>完整腳本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone.arm <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.arm_const <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> elftools.elf.elffile <span class="keyword">import</span> ELFFile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_section</span>(<span class="params">filename, sectionName</span>):</span><br><span class="line">    file = <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    elf_file = ELFFile(file)</span><br><span class="line">    <span class="keyword">for</span> section <span class="keyword">in</span> elf_file.iter_sections():</span><br><span class="line">        <span class="keyword">if</span> section.name == sectionName:</span><br><span class="line">            <span class="keyword">return</span> section</span><br><span class="line"></span><br><span class="line"><span class="comment"># capstone寄存器 -&gt; unicorn寄存器</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reg_ctou</span>(<span class="params">reg_name</span>):<span class="comment">#</span></span><br><span class="line">    <span class="keyword">if</span> reg_name == <span class="string">&quot;sp&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> UC_ARM_REG_SP</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> reg_name == <span class="string">&quot;pc&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> UC_ARM_REG_PC</span><br><span class="line"></span><br><span class="line">    reg_idx = <span class="built_in">int</span>(reg_name[<span class="number">1</span>:])</span><br><span class="line">    <span class="keyword">if</span> reg_idx &gt;= <span class="number">0</span> <span class="keyword">and</span> reg_idx &lt;= <span class="number">12</span>:</span><br><span class="line">        <span class="keyword">return</span> UC_ARM_REG_R0 + reg_idx</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;reg_ctou: have new type?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_block_end</span>(<span class="params">dasm</span>):</span><br><span class="line">    <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> dasm.op_str == <span class="string">&quot;pc, r0&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;b&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_mem_access</span>(<span class="params">uc, <span class="built_in">type</span>, address,size,value,userdata</span>):</span><br><span class="line">    pc = uc.reg_read(UC_ARM_REG_PC)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;pc:%x type:%d addr:%x size:%x&#x27;</span> % (pc, <span class="built_in">type</span>, address, size))</span><br><span class="line">    <span class="comment">#uc.emu_stop()</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_preproc</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="comment"># 由IDA Python得出</span></span><br><span class="line">    preprocessor_addrs = [<span class="number">27514</span>, <span class="number">3200</span>, <span class="number">5784</span>, <span class="number">10490</span>, <span class="number">15456</span>, <span class="number">17002</span>, <span class="number">19836</span>, <span class="number">20578</span>, <span class="number">22440</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addr <span class="keyword">in</span> preprocessor_addrs</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_context</span>():</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mu.context_save()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_context</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">if</span> context == <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    mu.context_restore(context)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_regs</span>():</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    msg = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        msg += <span class="string">f&quot;r<span class="subst">&#123;i&#125;</span>:<span class="subst">&#123;<span class="built_in">hex</span>(mu.reg_read(UC_ARM_REG_R0 + i))&#125;</span>\t&quot;</span></span><br><span class="line">    msg += <span class="string">f&quot;sp:<span class="subst">&#123;<span class="built_in">hex</span>(mu.reg_read(UC_ARM_REG_SP))&#125;</span>\tpc:<span class="subst">&#123;<span class="built_in">hex</span>(mu.reg_read(UC_ARM_REG_PC))&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ins_size</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> md.disasm(sodata[addr:addr+<span class="number">4</span>], addr):</span><br><span class="line">        <span class="keyword">return</span> ins.size</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_dasm</span>(<span class="params">addr, size</span>):</span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> dasm <span class="keyword">in</span> md.disasm(sodata[addr:addr+size], addr):</span><br><span class="line">        <span class="keyword">return</span> dasm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">uc, address, size, user_data</span>):</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> branch_control</span><br><span class="line">    <span class="keyword">global</span> g_start_addr</span><br><span class="line">    <span class="keyword">global</span> list_trace</span><br><span class="line">    <span class="keyword">global</span> dst_addr</span><br><span class="line">    <span class="keyword">global</span> end</span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_success <span class="keyword">or</span> address &gt; end:</span><br><span class="line">        mu.emu_stop()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    ban_ins = [<span class="string">&quot;bl&quot;</span>, <span class="string">&quot;blx&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> address <span class="keyword">in</span> [<span class="number">0x5ED6</span>]:</span><br><span class="line">        <span class="comment"># for debug</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;debug addr: &quot;</span>, <span class="built_in">hex</span>(address))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> md.disasm(sodata[address:address+size], address):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x&quot;</span> % (address, size))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&gt;&gt;&gt; 0x%x:\t%s\t%s\t%d&quot;</span> % (ins.address, ins.mnemonic, ins.op_str, ins.size))</span><br><span class="line">        </span><br><span class="line">        print_regs()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">in</span> real_blocks:</span><br><span class="line">            <span class="keyword">if</span> address <span class="keyword">in</span> list_trace:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;have fake block?&quot;</span>)</span><br><span class="line">                uc.emu_stop()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                list_trace[address] = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> address != g_start_addr:</span><br><span class="line">                is_success = <span class="literal">True</span></span><br><span class="line">                dst_addr = address</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;find: <span class="subst">&#123;<span class="built_in">hex</span>(address)&#125;</span>&quot;</span>)</span><br><span class="line">                uc.emu_stop()</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> address <span class="keyword">in</span> ret_blocks:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;end_block: <span class="subst">&#123;<span class="built_in">hex</span>(address)&#125;</span> &quot;</span>)</span><br><span class="line">            mu.emu_stop()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        flag_pass = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> ban_ins:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic.find(b) != -<span class="number">1</span>:</span><br><span class="line">                flag_pass = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 內存操作 (對本例用處不大)</span></span><br><span class="line">        <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># R7是棧底寄存器, 通常用來取局部變量</span></span><br><span class="line">            <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[r7&quot;</span>) != -<span class="number">1</span> <span class="keyword">and</span> ins.op_str.find(<span class="string">&quot;0xf4&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ins.op_str.find(<span class="string">&quot;[sp&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">                flag_pass = <span class="literal">True</span>         </span><br><span class="line">                <span class="keyword">for</span> op <span class="keyword">in</span> ins.operands:</span><br><span class="line">                    <span class="keyword">if</span> op.<span class="built_in">type</span> == ARM_OP_MEM:</span><br><span class="line">                        reg_name = ins.reg_name(op.value.base)</span><br><span class="line">                        addr = mu.reg_read(reg_ctou(reg_name))</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> addr &gt;= <span class="number">0x80000000</span> <span class="keyword">and</span> addr &lt; <span class="number">0x80000000</span> +  <span class="number">0x10000</span> * <span class="number">8</span>:</span><br><span class="line">                            flag_pass = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> flag_pass:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[pass] addr: <span class="subst">&#123;<span class="built_in">hex</span>(ins.address)&#125;</span> size: <span class="subst">&#123;ins.size&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># 關鍵點: 要 |1</span></span><br><span class="line">            uc.reg_write(UC_ARM_REG_PC, (ins.address + ins.size) | <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># uc.reg_write(UC_ARM_REG_PC, address + size)</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> branch_control == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ollvm 分支</span></span><br><span class="line">        <span class="comment"># branch_control == 1代表條件成立, 如 cmp r1,r2、beq XXX -&gt; r1 == r2 (目的是方便後續的patch)</span></span><br><span class="line">        next_dasm = get_dasm(ins.address + ins.size, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">if</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;ne&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startsWith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(ops[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> ins.mnemonic == <span class="string">&quot;tst&quot;</span>: <span class="comment"># tst r2, r3  ---&gt; r2 &amp; r3 , 改變z標誌</span></span><br><span class="line">                regs = [reg_ctou(x) <span class="keyword">for</span> x <span class="keyword">in</span> ins.op_str.split(<span class="string">&quot;, &quot;</span>)]</span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(regs[<span class="number">0</span>], <span class="number">0</span>)</span><br><span class="line">                    mu.reg_write(regs[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(regs[<span class="number">0</span>], <span class="number">1</span>)</span><br><span class="line">                    mu.reg_write(regs[<span class="number">1</span>], <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 例: cmp r2, r3, cmp是r2 - r3, 當結果&lt;0時, blt、bmi都會執行</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;lt&quot;</span> <span class="keyword">or</span> \</span><br><span class="line">            next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;mi&quot;</span> <span class="keyword">or</span> \</span><br><span class="line">            next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;lo&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># gt 是大於</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;gt&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num + <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># eq 是等於</span></span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span> <span class="keyword">and</span> next_dasm.op_str == <span class="string">&quot;eq&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> ins.mnemonic == <span class="string">&quot;cmp&quot;</span>:</span><br><span class="line">                ops = ins.op_str.split(<span class="string">&quot;, &quot;</span>)</span><br><span class="line">                reg = reg_ctou(ops[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;#&quot;</span>):</span><br><span class="line">                    cmp_num = <span class="built_in">int</span>(ops[<span class="number">1</span>][<span class="number">1</span>:], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">assert</span> ops[<span class="number">1</span>].startswith(<span class="string">&quot;r&quot;</span>)</span><br><span class="line">                    cmp_num = mu.reg_read(reg_ctou(ops[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> branch_control == <span class="number">0</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    mu.reg_write(reg, cmp_num)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elif</span> next_dasm.mnemonic == <span class="string">&quot;itt&quot;</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;ollvm branch new type&quot;</span>)</span><br><span class="line">                 </span><br><span class="line">            </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">start_addr, branch = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> real_blocks</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> g_start_addr</span><br><span class="line">    <span class="keyword">global</span> branch_control</span><br><span class="line">    <span class="keyword">global</span> list_trace</span><br><span class="line">    <span class="keyword">global</span> dst_addr</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line"></span><br><span class="line">    branch_control = branch</span><br><span class="line">    g_start_addr = start_addr</span><br><span class="line">    list_trace = &#123;&#125;</span><br><span class="line">    dst_addr = <span class="number">0</span></span><br><span class="line">    is_success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        mu.emu_start(start_addr | <span class="number">1</span>, start_addr + <span class="number">0x10000</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;============= emu end =============&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        pc = mu.reg_read(UC_ARM_REG_PC)</span><br><span class="line">        <span class="keyword">if</span> pc != <span class="number">0</span>:</span><br><span class="line">            <span class="comment">#mu.reg_write(UC_ARM64_REG_PC, pc + 4)</span></span><br><span class="line">            <span class="comment"># Thumb指令, 長度可能是2/4, 因此要動態獲取</span></span><br><span class="line">            _size = get_ins_size(pc)</span><br><span class="line">            <span class="keyword">return</span> find_path(pc + _size, branch)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;ERROR: %s  pc:%x&quot;</span> % (e,pc))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_success:</span><br><span class="line">        <span class="keyword">return</span> dst_addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_nop</span>(<span class="params">addr, size</span>):</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line">    nop_bytes = <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x00\xbf&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        sodata[addr + i] = nop_bytes[i % <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_bytes</span>(<span class="params">addr, <span class="built_in">bytes</span>: <span class="built_in">bytearray</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(<span class="built_in">bytes</span>)):</span><br><span class="line">        sodata[addr + i] = <span class="built_in">bytes</span>[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ks_asm</span>(<span class="params">arch, mode, code, addr = <span class="number">0</span></span>):</span><br><span class="line">    ks = Ks(arch, mode)</span><br><span class="line"></span><br><span class="line">    encoding, count = ks.asm(code, addr)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_branch</span>(<span class="params">addr, b0, b1</span>):</span><br><span class="line">    dasm = get_dasm(addr, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">assert</span> dasm.mnemonic == <span class="string">&quot;itt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>:\t<span class="subst">&#123;dasm.mnemonic&#125;</span>\t<span class="subst">&#123;dasm.op_str&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    patch_nop(addr, <span class="number">28</span> + <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    b1_addr = b1 - addr - <span class="number">4</span></span><br><span class="line">    b0_addr = b0</span><br><span class="line"></span><br><span class="line">    branch_true_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;b<span class="subst">&#123;dasm.op_str&#125;</span> #<span class="subst">&#123;<span class="built_in">hex</span>(b1_addr)&#125;</span>&quot;</span>, addr)</span><br><span class="line">    branch_false_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;b <span class="subst">&#123;<span class="built_in">hex</span>(b0_addr)&#125;</span>&quot;</span>, addr + <span class="built_in">len</span>(branch_true_bytes))</span><br><span class="line"></span><br><span class="line">    patch_bytes(addr, branch_true_bytes)</span><br><span class="line">    patch_bytes(addr + <span class="built_in">len</span>(branch_true_bytes), branch_false_bytes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 獲取分支的patch address (從addr向下查找, 直到itt指令)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_branch_pa</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> dasm <span class="keyword">in</span> md.disasm(sodata[addr:end], addr):</span><br><span class="line">        <span class="comment"># print(f&quot;&#123;hex(addr)&#125;:\t&#123;dasm.mnemonic&#125;\t&#123;dasm.op_str&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;itt&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> dasm.address</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;cant find itt????&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_patch</span>(<span class="params">flow, start_addr</span>):</span><br><span class="line">    <span class="keyword">global</span> block_list</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    sodata = <span class="built_in">bytearray</span>(sodata)</span><br><span class="line"></span><br><span class="line">    visited = &#123;&#125;</span><br><span class="line">    queue = [start_addr]</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(queue) != <span class="number">0</span>:</span><br><span class="line">        current_addr = queue.pop()</span><br><span class="line">        <span class="keyword">if</span> current_addr <span class="keyword">in</span> visited <span class="keyword">or</span> current_addr == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        visited[current_addr] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        next_blocks = flow[current_addr]</span><br><span class="line"></span><br><span class="line">        rb_end_addr = block_list[current_addr][<span class="string">&quot;end_addr&quot;</span>]</span><br><span class="line">        rb_start_addr = block_list[current_addr][<span class="string">&quot;start_addr&quot;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 無分支的情況</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(next_blocks) == <span class="number">1</span>:</span><br><span class="line">            queue.append(next_blocks[<span class="number">0</span>])</span><br><span class="line">            <span class="comment"># 對本例, patch地址固定為真實塊最後指令地址 - 10</span></span><br><span class="line">            patch_addr = rb_end_addr - <span class="number">10</span></span><br><span class="line"></span><br><span class="line">            next_start_addr = queue[-<span class="number">1</span>]</span><br><span class="line">            patch_nop(patch_addr, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> next_start_addr != <span class="literal">None</span>:</span><br><span class="line">                asm_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;mov r0, #<span class="subst">&#123;<span class="built_in">hex</span>(next_start_addr)&#125;</span>&quot;</span>)</span><br><span class="line">                patch_bytes(patch_addr, asm_bytes)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;  <span class="subst">&#123;<span class="built_in">hex</span>(next_start_addr)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">                ret_block_addr = ret_blocks[<span class="number">0</span>]</span><br><span class="line">                asm_bytes = ks_asm(KS_ARCH_ARM, KS_MODE_THUMB, <span class="string">f&quot;mov r0, #<span class="subst">&#123;<span class="built_in">hex</span>(ret_block_addr)&#125;</span>&quot;</span>)</span><br><span class="line">                patch_bytes(patch_addr, asm_bytes)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;  ret block: <span class="subst">&#123;<span class="built_in">hex</span>(ret_block_addr)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># 2. 有分支的情況</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            queue.append(next_blocks[<span class="number">0</span>])</span><br><span class="line">            queue.append(next_blocks[<span class="number">1</span>])</span><br><span class="line">            b0 = next_blocks[<span class="number">0</span>] <span class="comment"># branch_control為0的分支, False分支</span></span><br><span class="line">            b1 = next_blocks[<span class="number">1</span>] <span class="comment"># branch_control為1的分支, True分支</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># patch_addr = rb_end_addr - 28</span></span><br><span class="line">            patch_addr = get_branch_pa(rb_start_addr)</span><br><span class="line">            patch_branch(patch_addr, b0, b1)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(patch_addr)&#125;</span>  ---&gt;\n\t1. <span class="subst">&#123;<span class="built_in">hex</span>(b0)&#125;</span>\n\t2. <span class="subst">&#123;<span class="built_in">hex</span>(b1)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, mode = <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        sodata = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, mode=<span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(sodata)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">collect_blocks</span>(<span class="params">offset, end, ret_addr</span>):</span><br><span class="line">    <span class="keyword">global</span> block_list <span class="comment"># 保存所有塊</span></span><br><span class="line">    <span class="keyword">global</span> real_blocks <span class="comment"># 保存真實塊</span></span><br><span class="line">    <span class="keyword">global</span> ret_blocks <span class="comment"># 保存ret 塊</span></span><br><span class="line">    <span class="keyword">global</span> md</span><br><span class="line"></span><br><span class="line">    block_list = &#123;&#125;</span><br><span class="line">    real_blocks = []</span><br><span class="line">    ret_blocks = []</span><br><span class="line"></span><br><span class="line">    md = Cs(CS_ARCH_ARM, CS_MODE_THUMB)</span><br><span class="line">    md.detail = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    preproc_flag = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    ins_str = <span class="string">&quot;&quot;</span></span><br><span class="line">    is_new = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> dasm <span class="keyword">in</span> md.disasm(sodata[offset:end], offset):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 這裡是數據, 不用保存為block</span></span><br><span class="line">        <span class="keyword">if</span> dasm.address &gt;= <span class="number">0x612E</span> <span class="keyword">and</span> dasm.address &lt; <span class="number">0x617C</span>:</span><br><span class="line">            <span class="keyword">continue</span> </span><br><span class="line"></span><br><span class="line">        ins_str += <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(dasm.address)&#125;</span>:\t<span class="subst">&#123;dasm.mnemonic&#125;</span>\t<span class="subst">&#123;dasm.op_str&#125;</span>\n&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 在塊的起如地址保存對應信息</span></span><br><span class="line">        <span class="keyword">if</span> is_new:</span><br><span class="line">            is_new = <span class="literal">False</span></span><br><span class="line">            block_item = &#123;&#125;</span><br><span class="line">            block_item[<span class="string">&quot;start_addr&quot;</span>] = dasm.address</span><br><span class="line">            block_item[<span class="string">&quot;capstone&quot;</span>] = dasm</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 判斷當前地址是否預處理器的起始地址</span></span><br><span class="line">        <span class="keyword">if</span> is_preproc(dasm.address):</span><br><span class="line">            preproc_flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_block_end(dasm):</span><br><span class="line">            is_new = <span class="literal">True</span></span><br><span class="line">            block_item[<span class="string">&quot;end_addr&quot;</span>] = dasm.address</span><br><span class="line">            block_item[<span class="string">&quot;ins_str&quot;</span>] = ins_str</span><br><span class="line">            ins_str = <span class="string">&quot;&quot;</span></span><br><span class="line">            block_list[block_item[<span class="string">&quot;start_addr&quot;</span>]] = block_item</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 初步獲取real_blocks, 這個特徵僅針對本例</span></span><br><span class="line">            <span class="keyword">if</span> dasm.mnemonic == <span class="string">&quot;mov&quot;</span> <span class="keyword">and</span> dasm.op_str == <span class="string">&quot;pc, r0&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> preproc_flag:</span><br><span class="line">                    preproc_flag = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    real_blocks.append(block_item[<span class="string">&quot;start_addr&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 手動添加arm的ret block (從IDA裡找出度為0的那塊)</span></span><br><span class="line">    ret_blocks.append(ret_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_unicorn</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">global</span> mu</span><br><span class="line">    <span class="keyword">global</span> sodata</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(sodata, <span class="built_in">bytearray</span>):</span><br><span class="line">        sodata = <span class="built_in">bytes</span>(sodata)</span><br><span class="line"></span><br><span class="line">    mu = Uc(UC_ARCH_ARM, UC_MODE_THUMB)</span><br><span class="line">    mu.mem_map(<span class="number">0x80000000</span>, <span class="number">0x1000</span> * <span class="number">8</span>) <span class="comment"># 初始化stack</span></span><br><span class="line">    mu.mem_map(<span class="number">0</span>, <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    mu.mem_write(<span class="number">0</span>, sodata)</span><br><span class="line">    mu.reg_write(UC_ARM_REG_SP, <span class="number">0x80000000</span> + <span class="number">0x1000</span> * <span class="number">4</span>)</span><br><span class="line">    mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">    mu.hook_add(UC_HOOK_MEM_UNMAPPED, hook_mem_access)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 設置.data節</span></span><br><span class="line">    data_section = get_section(filename, <span class="string">&#x27;.data&#x27;</span>)</span><br><span class="line">    DATA_MEM_OFFSET = data_section.header[<span class="string">&quot;sh_addr&quot;</span>]</span><br><span class="line">    DATA_FILE_OFFSET = data_section.header[<span class="string">&quot;sh_offset&quot;</span>]</span><br><span class="line">    DATA_SIZE = data_section.header[<span class="string">&quot;sh_size&quot;</span>]</span><br><span class="line">    mu.mem_write(DATA_MEM_OFFSET, sodata[DATA_FILE_OFFSET:DATA_FILE_OFFSET+DATA_SIZE])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_emu</span>(<span class="params">offset</span>):</span><br><span class="line">    <span class="keyword">global</span> is_success</span><br><span class="line">    <span class="keyword">global</span> flow</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> offset <span class="keyword">in</span> real_blocks:</span><br><span class="line">        real_blocks.remove(offset)</span><br><span class="line"></span><br><span class="line">    queue = [(offset, <span class="literal">None</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存執行流, 最終patch就是靠它</span></span><br><span class="line">    flow = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    is_success = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(queue) != <span class="number">0</span>:</span><br><span class="line">        env = queue.pop()</span><br><span class="line">        pc = env[<span class="number">0</span>]</span><br><span class="line">        set_context(env[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        item = block_list[pc]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 代表對應的路徑已被記錄, 無需重複</span></span><br><span class="line">        <span class="keyword">if</span> pc <span class="keyword">in</span> flow:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        flow[pc] = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分支, 例如 0x62D6, 0x5FA2</span></span><br><span class="line">        <span class="keyword">if</span> item[<span class="string">&quot;ins_str&quot;</span>].find(<span class="string">&quot;itt&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">            ctx = get_context()</span><br><span class="line"></span><br><span class="line">            p1 = find_path(pc, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> p1 != <span class="literal">None</span>:</span><br><span class="line">                queue.append((p1, get_context()))</span><br><span class="line">                flow[pc].append(p1)</span><br><span class="line">            set_context(ctx)</span><br><span class="line">            p2 = find_path(pc, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> p1 != p2:</span><br><span class="line">                queue.append((p2, get_context()))</span><br><span class="line">                flow[pc].append(p2)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = find_path(pc)</span><br><span class="line">            <span class="keyword">if</span> p != <span class="literal">None</span>:</span><br><span class="line">                queue.append((p, get_context()))</span><br><span class="line"></span><br><span class="line">            flow[pc].append(p)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">offset, end_addr, ret_addr</span>):</span><br><span class="line">    <span class="keyword">global</span> end</span><br><span class="line">    <span class="keyword">global</span> flow</span><br><span class="line"></span><br><span class="line">    end = end_addr</span><br><span class="line"></span><br><span class="line">    collect_blocks(offset = offset, end = end, ret_addr = ret_addr)</span><br><span class="line"></span><br><span class="line">    init_unicorn(<span class="string">&quot;libBlackMamBa.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_emu(offset)</span><br><span class="line"></span><br><span class="line">    start_patch(flow, offset)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    offset_list = [<span class="number">0x584c</span>, <span class="number">0xC90</span>, <span class="number">0x1700</span>, <span class="number">0x2968</span>, <span class="number">0x50A4</span>, <span class="number">0x42DC</span>] <span class="comment"># 0x3CD0</span></span><br><span class="line">    end_list    = [<span class="number">0x6b90</span>, <span class="number">0x16AE</span>, <span class="number">0x2910</span>, <span class="number">0x3C76</span>, <span class="number">0x57BE</span>, <span class="number">0x4D92</span>] <span class="comment"># 0x4280</span></span><br><span class="line">    ret_list    = [<span class="number">0x6B58</span>, <span class="number">0x1666</span>, <span class="number">0x28E0</span>, <span class="number">0x3C3C</span>, <span class="number">0x578E</span>, <span class="number">0x4D54</span>] <span class="comment"># 0x4250</span></span><br><span class="line">    load_file(<span class="string">&quot;libBlackMamBa.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(offset_list)):</span><br><span class="line">        run(offset_list[i], end_list[i], ret_list[i])</span><br><span class="line"></span><br><span class="line">    save_file(<span class="string">&quot;patch3.so&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最後附上一張還原的效果圖，以及上述如果有誤的話還望指出！！</p>
<p><img src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled6.png" alt="Untitled"></p>
<h2 id="參考"><a href="#參考" class="headerlink" title="參考"></a>參考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-252321.htm">https://bbs.kanxue.com/thread-252321.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0355a67b8762">https://www.jianshu.com/p/0355a67b8762</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">NgIokWeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/">https://ngiokweng.github.io/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://ngiokweng.github.io" target="_blank">NgIokWeng's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ollvm/">ollvm</a></div><div class="post_share"><div class="social-share" data-image="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/28/%E8%87%AA%E5%AF%A6%E7%8F%BELinker%E5%8A%A0%E8%BC%89so/"><img class="prev-cover" src="/2024/06/28/%E8%87%AA%E5%AF%A6%E7%8F%BELinker%E5%8A%A0%E8%BC%89so/Untitled.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">自實現Linker加載so</div></div></a></div><div class="next-post pull-right"><a href="/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><img class="next-cover" src="/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">so加載流程分析</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相關推薦</span></div><div class="relatedPosts-list"><div><a href="/2024/05/26/B%E7%AB%99sign%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/" title="B站sign算法分析"><img class="cover" src="/2024/05/26/B%E7%AB%99sign%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-26</div><div class="title">B站sign算法分析</div></div></a></div><div><a href="/2024/05/27/ollvm_bcf_anti/" title="ollvm_bcf_anti"><img class="cover" src="/2024/05/27/ollvm_bcf_anti/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-27</div><div class="title">ollvm_bcf_anti</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/myImg/blogIcon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">NgIokWeng</div><div class="author-info__description">如果你對目前擁有的一切覺得不滿，等到你擁有更多時，也不見得會快樂</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ngiokweng/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%84%E5%8E%9F%E6%80%9D%E8%B7%AF"><span class="toc-number">2.</span> <span class="toc-text">還原思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E9%AB%94%E5%AF%A6%E7%8F%BE"><span class="toc-number">3.</span> <span class="toc-text">具體實現</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#collect-blocks"><span class="toc-number">3.1.</span> <span class="toc-text">collect_blocks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#init-unicorn"><span class="toc-number">3.2.</span> <span class="toc-text">init_unicorn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#start-emu"><span class="toc-number">3.3.</span> <span class="toc-text">start_emu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-path"><span class="toc-number">3.4.</span> <span class="toc-text">find_path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hook-code"><span class="toc-number">3.5.</span> <span class="toc-text">hook_code</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#start-patch"><span class="toc-number">3.6.</span> <span class="toc-text">start_patch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E8%85%B3%E6%9C%AC"><span class="toc-number">4.</span> <span class="toc-text">完整腳本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%83%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">參考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/" title="記一次對某韓遊的反反調試"><img src="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/image.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="記一次對某韓遊的反反調試"/></a><div class="content"><a class="title" href="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/" title="記一次對某韓遊的反反調試">記一次對某韓遊的反反調試</a><time datetime="2025-03-18T13:09:27.000Z" title="發表於 2025-03-18 21:09:27">2025-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/" title="2025吾愛解題領紅包活動(Android題解)"><img src="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025吾愛解題領紅包活動(Android題解)"/></a><div class="content"><a class="title" href="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/" title="2025吾愛解題領紅包活動(Android題解)">2025吾愛解題領紅包活動(Android題解)</a><time datetime="2025-02-13T01:20:48.000Z" title="發表於 2025-02-13 09:20:48">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/" title="2024騰訊遊戲安全大賽安卓決賽(復現)"><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024騰訊遊戲安全大賽安卓決賽(復現)"/></a><div class="content"><a class="title" href="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/" title="2024騰訊遊戲安全大賽安卓決賽(復現)">2024騰訊遊戲安全大賽安卓決賽(復現)</a><time datetime="2025-01-27T09:00:58.000Z" title="發表於 2025-01-27 17:00:58">2025-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/" title="某盾so加固與修復"><img src="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某盾so加固與修復"/></a><div class="content"><a class="title" href="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/" title="某盾so加固與修復">某盾so加固與修復</a><time datetime="2025-01-03T15:37:36.000Z" title="發表於 2025-01-03 23:37:36">2025-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析"><img src="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LIAPP手遊保護分析"/></a><div class="content"><a class="title" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析">LIAPP手遊保護分析</a><time datetime="2024-11-28T11:59:08.000Z" title="發表於 2024-11-28 19:59:08">2024-11-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By NgIokWeng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '213c1281d4936c27991d',
      clientSecret: 'e52f4c4e54b9993a1226672a59463577a9fd73cd',
      repo: 'ngiokweng.github.io',
      owner: 'ngiokweng',
      admin: ['ngiokweng'],
      id: 'a2699c88c76f72c05df314410d9c87bf',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>