<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>so加載流程分析 | NgIokWeng's Blog</title><meta name="keywords" content="so文件,Android逆向"><meta name="author" content="NgIokWeng"><meta name="copyright" content="NgIokWeng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="so加載流程分析">
<meta property="og:type" content="article">
<meta property="og:title" content="so加載流程分析">
<meta property="og:url" content="https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="NgIokWeng&#39;s Blog">
<meta property="og:description" content="so加載流程分析">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png">
<meta property="article:published_time" content="2024-06-01T08:29:14.000Z">
<meta property="article:modified_time" content="2024-06-01T08:29:14.799Z">
<meta property="article:author" content="NgIokWeng">
<meta property="article:tag" content="so文件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png"><link rel="shortcut icon" href="/myImg/blogIcon.png"><link rel="canonical" href="https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="google-site-verification" content="iO5LJpaf7bluC9CxlRdPhowI-XL-OzJ-X6ixOkO3cuk"/><meta name="baidu-site-verification" content="code-ZZyU1mBcxX"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'so加載流程分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-01 16:29:14'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/myCustom.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">載入中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/myImg/blogIcon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">NgIokWeng's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">so加載流程分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2024-06-01T08:29:14.000Z" title="發表於 2024-06-01 16:29:14">2024-06-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2024-06-01T08:29:14.799Z" title="更新於 2024-06-01 16:29:14">2024-06-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E9%80%86%E5%90%91/">Android逆向</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="so加載流程分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>同樣是在研究360加固，對so加載的理解不夠深刻，特此分析記錄完整的so加載流程。</p>
<p>注：分析的AOSP版本是<code>Oreo8.1.0_r33</code>。</p>
<h2 id="So加載流程"><a href="#So加載流程" class="headerlink" title="So加載流程"></a>So加載流程</h2><h3 id="System-loadLibrary與System-load"><a href="#System-loadLibrary與System-load" class="headerlink" title="System.loadLibrary與System.load"></a><code>System.loadLibrary</code>與<code>System.load</code></h3><p><code>loadLibrary</code>：傳入的是一個so的名稱，如<code>libtest.so</code>，這個so通常位於<code>/data/app/&lt;pkg&gt;/lib/&lt;arch&gt;</code>下。</p>
<p><code>load</code>：傳入的是so的絕對地址。</p>
<p>兩者的執行流程其實沒有太大差異，最終都會調用<code>Runtime_nativeLoad</code>，本文以<code>System.load</code>作為起始點，一步一步分析下去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libcore/ojluni/src/main/java/java/lang/System.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libname)</span> &#123;</span><br><span class="line">    Runtime.getRuntime().loadLibrary0(Reflection.getCallerClass(), libname);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">    Runtime.getRuntime().load0(Reflection.getCallerClass(), filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Runtime-load0"><a href="#Runtime-load0" class="headerlink" title="Runtime.load0"></a><code>Runtime.load0</code></h3><p>先判斷傳入的<code>filename</code>是否絕對地址，然後調用<code>nativeLoad</code>。</p>
<p>而<code>nativeLoad</code>是個native函數，表示接下來就要開始分析native層代碼。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libcore/ojluni/src/main/java/java/lang/Runtime.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">load0</span><span class="params">(Class&lt;?&gt; fromClass, String filename)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">new</span> <span class="title class_">File</span>(filename).isAbsolute())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(</span><br><span class="line">            <span class="string">&quot;Expecting an absolute path of the library: &quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (filename == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;filename == null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> nativeLoad(filename, fromClass.getClassLoader(), fromClass);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedLinkError</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">nativeLoad</span><span class="params">(String filename, ClassLoader loader, Class&lt;?&gt; caller)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="nativeLoad"><a href="#nativeLoad" class="headerlink" title="nativeLoad"></a><code>nativeLoad</code></h3><p><code>nativeLoad</code>是個JNI函數，它采用了靜態注冊+動態注冊。</p>
<p>靜態注冊表現為<code>JNIEXPORT jstring JNICALL Runtime_nativeLoad</code>，而動態注冊表現為<code>jniRegisterNativeMethods</code>( 這個函數內會調用<code>RegisterNatives</code>實現動態注冊 )，不太理解為何要靜態+動態注冊，可能是為了靈活性？</p>
<p>之後繼續深入分析<code>JVM_NativeLoad</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libcore/ojluni/src/main/native/Runtime.c</span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Runtime_nativeLoad</span><span class="params">(JNIEnv* env, jclass ignored, jstring javaFilename,</span></span></span><br><span class="line"><span class="params"><span class="function">                   jobject javaLoader, jclass caller)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JVM_NativeLoad</span>(env, javaFilename, javaLoader, caller);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">  <span class="built_in">FAST_NATIVE_METHOD</span>(Runtime, freeMemory, <span class="string">&quot;()J&quot;</span>),</span><br><span class="line">  <span class="built_in">FAST_NATIVE_METHOD</span>(Runtime, totalMemory, <span class="string">&quot;()J&quot;</span>),</span><br><span class="line">  <span class="built_in">FAST_NATIVE_METHOD</span>(Runtime, maxMemory, <span class="string">&quot;()J&quot;</span>),</span><br><span class="line">  <span class="built_in">NATIVE_METHOD</span>(Runtime, nativeGc, <span class="string">&quot;()V&quot;</span>),</span><br><span class="line">  <span class="built_in">NATIVE_METHOD</span>(Runtime, nativeExit, <span class="string">&quot;(I)V&quot;</span>),</span><br><span class="line">  <span class="built_in">NATIVE_METHOD</span>(Runtime, nativeLoad,</span><br><span class="line">                <span class="string">&quot;(Ljava/lang/String;Ljava/lang/ClassLoader;Ljava/lang/Class;)&quot;</span></span><br><span class="line">                    <span class="string">&quot;Ljava/lang/String;&quot;</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">register_java_lang_Runtime</span><span class="params">(JNIEnv* env)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">jniRegisterNativeMethods</span>(env, <span class="string">&quot;java/lang/Runtime&quot;</span>, gMethods, <span class="built_in">NELEM</span>(gMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JVM-NativeLoad"><a href="#JVM-NativeLoad" class="headerlink" title="JVM_NativeLoad"></a><code>JVM_NativeLoad</code></h3><p><code>JVM_NativeLoad</code>調用了<code>LoadNativeLibrary</code>，繼續深入<code>LoadNativeLibrary</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// art/runtime/openjdkjvm/OpenjdkJvm.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring <span class="title">JVM_NativeLoad</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 jstring javaFilename,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 jobject javaLoader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 jclass caller)</span> </span>&#123;</span><br><span class="line">  <span class="function">ScopedUtfChars <span class="title">filename</span><span class="params">(env, javaFilename)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (filename.<span class="built_in">c_str</span>() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  &#123;</span><br><span class="line">    art::JavaVMExt* vm = art::Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetJavaVM</span>();</span><br><span class="line">    <span class="comment">// here</span></span><br><span class="line">    <span class="type">bool</span> success = vm-&gt;<span class="built_in">LoadNativeLibrary</span>(env,</span><br><span class="line">                                         filename.<span class="built_in">c_str</span>(),</span><br><span class="line">                                         javaLoader,</span><br><span class="line">                                         caller,</span><br><span class="line">                                         &amp;error_msg);</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Don&#x27;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span></span><br><span class="line">  env-&gt;<span class="built_in">ExceptionClear</span>();</span><br><span class="line">  <span class="keyword">return</span> env-&gt;<span class="built_in">NewStringUTF</span>(error_msg.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LoadNativeLibrary"><a href="#LoadNativeLibrary" class="headerlink" title="LoadNativeLibrary"></a><code>LoadNativeLibrary</code></h3><p>如下代碼只截取了比較重要的部分。</p>
<p>整個LoadNativeLibrary主要可以分成3部分：</p>
<ol>
<li>在加載so前先判斷so是否已被加載，如果是而且classloader也匹配的話，直接返回successfully，不做任何事情( 這部分的具體邏輯不深究，對分析so加載流程的意義不大 )。</li>
<li>調用<code>OpenNativeLibrary</code>加載so，後續會詳細分析該函數。</li>
<li>成功加載so後，若對應的<code>JNI_OnLoad</code>方法存在，則調用。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// art/runtime/java_vm_ext.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">JavaVMExt::LoadNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> std::string&amp; path,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  jclass caller_class,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  std::string* error_msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 判斷so是否已加載</span></span><br><span class="line">  <span class="comment">// See if we&#x27;ve already loaded this library.  If we have, and the class loader</span></span><br><span class="line">  <span class="comment">// matches, return successfully without doing anything.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> for better results we should canonicalize the pathname (or even compare</span></span><br><span class="line">  <span class="comment">// inodes). This implementation is fine if everybody is using System.loadLibrary.</span></span><br><span class="line">	<span class="comment">// some code here...</span></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// Open the shared library.  Because we&#x27;re using a full path, the system</span></span><br><span class="line">  <span class="comment">// doesn&#x27;t have to search through LD_LIBRARY_PATH.  (It may do so to</span></span><br><span class="line">  <span class="comment">// resolve this library&#x27;s dependencies though.)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Failures here are expected when java.library.path has several entries</span></span><br><span class="line">  <span class="comment">// and we have to hunt for the lib.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Below we dlopen but there is no paired dlclose, this would be necessary if we supported</span></span><br><span class="line">  <span class="comment">// class unloading. Libraries will only be unloaded when the reference count (incremented by</span></span><br><span class="line">  <span class="comment">// dlopen) becomes zero from dlclose.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Retrieve the library path from the classloader, if necessary.</span></span><br><span class="line">  <span class="function">ScopedLocalRef&lt;jstring&gt; <span class="title">library_path</span><span class="params">(env, GetLibrarySearchPath(env, class_loader))</span></span>;</span><br><span class="line"></span><br><span class="line">  Locks::mutator_lock_-&gt;<span class="built_in">AssertNotHeld</span>(self);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* path_str = path.<span class="built_in">empty</span>() ? <span class="literal">nullptr</span> : path.<span class="built_in">c_str</span>();</span><br><span class="line">  <span class="type">bool</span> needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">char</span>* nativeloader_error_msg = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="comment">// 2. 調用OpenNativeLibrary加載so</span></span><br><span class="line">  <span class="type">void</span>* handle = android::<span class="built_in">OpenNativeLibrary</span>(</span><br><span class="line">      env,</span><br><span class="line">      runtime_-&gt;<span class="built_in">GetTargetSdkVersion</span>(),</span><br><span class="line">      path_str,</span><br><span class="line">      class_loader,</span><br><span class="line">      (caller_location.<span class="built_in">empty</span>() ? <span class="literal">nullptr</span> : caller_location.<span class="built_in">c_str</span>()),</span><br><span class="line">      library_path.<span class="built_in">get</span>(),</span><br><span class="line">      &amp;needs_native_bridge,</span><br><span class="line">      &amp;nativeloader_error_msg);</span><br><span class="line">  <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Call to dlopen(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;, RTLD_NOW) returned &quot;</span> &lt;&lt; handle &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *error_msg = nativeloader_error_msg;</span><br><span class="line">    android::<span class="built_in">NativeLoaderFreeErrorMessage</span>(nativeloader_error_msg);</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;dlopen(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;, RTLD_NOW) failed: &quot;</span> &lt;&lt; *error_msg;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (env-&gt;<span class="built_in">ExceptionCheck</span>() == JNI_TRUE) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(ERROR) &lt;&lt; <span class="string">&quot;Unexpected exception:&quot;</span>;</span><br><span class="line">    env-&gt;<span class="built_in">ExceptionDescribe</span>();</span><br><span class="line">    env-&gt;<span class="built_in">ExceptionClear</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Create a new entry.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> move the locking (and more of this logic) into Libraries.</span></span><br><span class="line">  <span class="type">bool</span> created_library = <span class="literal">false</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Create SharedLibrary ahead of taking the libraries lock to maintain lock ordering.</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;SharedLibrary&gt; <span class="title">new_library</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> SharedLibrary(env,</span></span></span><br><span class="line"><span class="params"><span class="function">                          self,</span></span></span><br><span class="line"><span class="params"><span class="function">                          path,</span></span></span><br><span class="line"><span class="params"><span class="function">                          handle,</span></span></span><br><span class="line"><span class="params"><span class="function">                          needs_native_bridge,</span></span></span><br><span class="line"><span class="params"><span class="function">                          class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                          class_loader_allocator))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MutexLock <span class="title">mu</span><span class="params">(self, *Locks::jni_libraries_lock_)</span></span>;</span><br><span class="line">    library = libraries_-&gt;<span class="built_in">Get</span>(path);</span><br><span class="line">    <span class="keyword">if</span> (library == <span class="literal">nullptr</span>) &#123;  <span class="comment">// We won race to get libraries_lock.</span></span><br><span class="line">      library = new_library.<span class="built_in">release</span>();</span><br><span class="line">      libraries_-&gt;<span class="built_in">Put</span>(path, library);</span><br><span class="line">      created_library = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!created_library) &#123;</span><br><span class="line">    <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="string">&quot;WOW: we lost a race to add shared library: &quot;</span></span><br><span class="line">        &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot; ClassLoader=&quot;</span> &lt;&lt; class_loader;</span><br><span class="line">    <span class="keyword">return</span> library-&gt;<span class="built_in">CheckOnLoadResult</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Added shared library \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot; for ClassLoader &quot;</span> &lt;&lt; class_loader &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_successful = <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 若JNI_OnLoad存在, 則調用</span></span><br><span class="line">  <span class="type">void</span>* sym = library-&gt;<span class="built_in">FindSymbol</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>, <span class="literal">nullptr</span>, android::kJNICallTypeRegular);</span><br><span class="line">  <span class="keyword">if</span> (sym == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[No JNI_OnLoad found in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    was_successful = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Call JNI_OnLoad.  We have to override the current class</span></span><br><span class="line">    <span class="comment">// loader, which will always be &quot;null&quot; since the stuff at the</span></span><br><span class="line">    <span class="comment">// top of the stack is around Runtime.loadLibrary().  (See</span></span><br><span class="line">    <span class="comment">// the comments in the JNI FindClass function.)</span></span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; <span class="built_in">old_class_loader</span>(env, env-&gt;<span class="built_in">NewLocalRef</span>(self-&gt;<span class="built_in">GetClassLoaderOverride</span>()));</span><br><span class="line">    self-&gt;<span class="built_in">SetClassLoaderOverride</span>(class_loader);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Calling JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">using</span> JNI_OnLoadFn = <span class="built_in">int</span>(*)(JavaVM*, <span class="type">void</span>*);</span><br><span class="line">    JNI_OnLoadFn jni_on_load = <span class="built_in">reinterpret_cast</span>&lt;JNI_OnLoadFn&gt;(sym);</span><br><span class="line">    <span class="type">int</span> version = (*jni_on_load)(<span class="keyword">this</span>, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  library-&gt;<span class="built_in">SetResult</span>(was_successful);</span><br><span class="line">  <span class="keyword">return</span> was_successful;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OpenNativeLibrary"><a href="#OpenNativeLibrary" class="headerlink" title="OpenNativeLibrary"></a><code>OpenNativeLibrary</code></h3><p>一開始的條件編譯<code>#if defined(__ANDROID__)</code>用於判斷當前代碼是否運行在Android平台上，因此分析的目標就是這條分支。</p>
<p><code>g_namespaces-&gt;FindNamespaceByClassLoader</code>用於在給定的<code>class_loader</code>中查找對應的命名空間( Namespace )。Namespace在Android的作用是實現本地庫的隔離和加載控制，每個命名空間都有自己的本地庫加載路徑和加載策略，<strong>確保在不同的類加載器之間，本地庫的加載是隔離的，不會亙相干擾。</strong></p>
<p>正常來說<code>g_namespaces-&gt;FindNamespaceByClassLoader</code>能順利找到對應的命名空間，並且<code>ns.is_android_namespace()==true</code>，所以接下來繼續分析<code>android_dlopen_ext</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system/core/libnativeloader/native_loader.cpp</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">OpenNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int32_t</span> target_sdk_version,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">char</span>* path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jstring library_path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">bool</span>* needs_native_bridge,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::string* error_msg)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ANDROID__)</span></span><br><span class="line">  <span class="built_in">UNUSED</span>(target_sdk_version);</span><br><span class="line">  <span class="keyword">if</span> (class_loader == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">dlopen</span>(path, RTLD_NOW);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(g_namespaces_mutex)</span></span>;</span><br><span class="line">  NativeLoaderNamespace ns;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!g_namespaces-&gt;<span class="built_in">FindNamespaceByClassLoader</span>(env, class_loader, &amp;ns)) &#123;</span><br><span class="line">    <span class="comment">// This is the case where the classloader was not created by ApplicationLoaders</span></span><br><span class="line">    <span class="comment">// In this case we create an isolated not-shared namespace for it.</span></span><br><span class="line">    <span class="keyword">if</span> (!g_namespaces-&gt;<span class="built_in">Create</span>(env,</span><br><span class="line">                              target_sdk_version,</span><br><span class="line">                              class_loader,</span><br><span class="line">                              <span class="literal">false</span> <span class="comment">/* is_shared */</span>,</span><br><span class="line">                              <span class="literal">false</span> <span class="comment">/* is_for_vendor */</span>,</span><br><span class="line">                              library_path,</span><br><span class="line">                              <span class="literal">nullptr</span>,</span><br><span class="line">                              &amp;ns,</span><br><span class="line">                              error_msg)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ns.<span class="built_in">is_android_namespace</span>()) &#123;</span><br><span class="line">    android_dlextinfo extinfo;</span><br><span class="line">    extinfo.flags = ANDROID_DLEXT_USE_NAMESPACE;</span><br><span class="line">    extinfo.library_namespace = ns.<span class="built_in">get_android_ns</span>();</span><br><span class="line">		<span class="comment">// here</span></span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;extinfo);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error_msg = <span class="built_in">dlerror</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">NativeBridgeLoadLibraryExt</span>(path, RTLD_NOW, ns.<span class="built_in">get_native_bridge_ns</span>());</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error_msg = <span class="built_in">NativeBridgeGetError</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="android-dlopen-ext"><a href="#android-dlopen-ext" class="headerlink" title="android_dlopen_ext"></a><code>android_dlopen_ext</code></h3><p><code>android_dlopen_ext</code>裡調用了<code>__loader_android_dlopen_ext</code>。</p>
<p><code>__attribute__((__weak__, visibility(&quot;default&quot;)))</code>的解釋如下( from GPT )：</p>
<ul>
<li><code>__weak__</code>代表函數是一個弱符號，在鏈接過程中，如何存在多個同名的弱符號定義，那麼它們不同引發重定義錯誤，而是會保留最後一個定義的符號。</li>
<li><code>visibility(&quot;default&quot;)</code>設置函數的可見性為默認級別，可以使函數在鏈接時可見，可被其他模塊引用和調用。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/libdl/libdl.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">android_dlopen_ext</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">int</span> flag, <span class="type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span>* caller_addr = __builtin_return_address(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> __loader_android_dlopen_ext(filename, flag, extinfo, caller_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((__weak__, <span class="built_in">visibility</span>(<span class="string">&quot;default&quot;</span>)))</span><br><span class="line"><span class="type">void</span>* __loader_android_dlopen_ext(<span class="type">const</span> <span class="type">char</span>* filename,</span><br><span class="line">                                  <span class="type">int</span> flag,</span><br><span class="line">                                  <span class="type">const</span> android_dlextinfo* extinfo,</span><br><span class="line">                                  <span class="type">const</span> <span class="type">void</span>* caller_addr);</span><br></pre></td></tr></table></figure>

<p>本想繼續跟<code>__loader_android_dlopen_ext</code>，但卻找不到其具體實現的位置。</p>
<p><img src="/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png" alt="Untitled"></p>
<p>看別人的分析是在<code>dlfcn.cpp</code>中找到<code>__loader_android_dlopen_ext</code>的，我手動定位到該文件只能找到<code>__android_dlopen_ext</code>，但兩者應該是同一個函數？( 只是不清楚它們是如何聯繫起來的 )</p>
<h3 id="android-dlopen-ext-1"><a href="#android-dlopen-ext-1" class="headerlink" title="__android_dlopen_ext"></a><code>__android_dlopen_ext</code></h3><p>注：沒有找到<code>__loader_android_dlopen_ext</code>，只找到一個很相似的<code>__android_dlopen_ext</code>，兩者大概率是同一個函數，所以就從<code>__android_dlopen_ext</code>繼續分析。</p>
<p><code>__android_dlopen_ext</code>調用了<code>dlopen_ext</code>，<code>dlopen_ext</code>中調用了<code>do_dlopen</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/dlfcn.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __android_dlopen_ext(<span class="type">const</span> <span class="type">char</span>* filename,</span><br><span class="line">                           <span class="type">int</span> flags,</span><br><span class="line">                           <span class="type">const</span> android_dlextinfo* extinfo,</span><br><span class="line">                           <span class="type">const</span> <span class="type">void</span>* caller_addr) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">dlopen_ext</span>(filename, flags, extinfo, caller_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">dlopen_ext</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">void</span>* caller_addr)</span> </span>&#123;</span><br><span class="line">  <span class="function">ScopedPthreadMutexLocker <span class="title">locker</span><span class="params">(&amp;g_dl_mutex)</span></span>;</span><br><span class="line">  g_linker_logger.<span class="built_in">ResetState</span>();</span><br><span class="line">  <span class="type">void</span>* result = <span class="built_in">do_dlopen</span>(filename, flags, extinfo, caller_addr);</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    __bionic_format_dlerror(<span class="string">&quot;dlopen failed&quot;</span>, <span class="built_in">linker_get_error_buffer</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="do-dlopen"><a href="#do-dlopen" class="headerlink" title="do_dlopen"></a><code>do_dlopen</code></h3><p><code>do_dlopen</code>函數實現如下，同樣只保留重要部分。</p>
<p>其中有兩個最關鍵部分：</p>
<ol>
<li><code>find_library</code>函數，查找so的並返回<code>soinfo</code>，而<code>soinfo</code>顯然保存著so的所有信息。</li>
<li><code>si-&gt;call_constructors()</code>：調用so的初始化函數，即<code>.init</code>和<code>.init_array</code>( <code>.init</code>先調用 )，通常一些檢測的邏輯很喜歡藏在這裡。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">do_dlopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> <span class="type">void</span>* caller_addr)</span> </span>&#123;</span><br><span class="line">  std::string trace_prefix = std::<span class="built_in">string</span>(<span class="string">&quot;dlopen: &quot;</span>) + (name == <span class="literal">nullptr</span> ? <span class="string">&quot;(nullptr)&quot;</span> : name);</span><br><span class="line">  <span class="function">ScopedTrace <span class="title">trace</span><span class="params">(trace_prefix.c_str())</span></span>;</span><br><span class="line">  <span class="function">ScopedTrace <span class="title">loading_trace</span><span class="params">((trace_prefix + <span class="string">&quot; - loading and linking&quot;</span>).c_str())</span></span>;</span><br><span class="line">  soinfo* <span class="type">const</span> caller = <span class="built_in">find_containing_library</span>(caller_addr);</span><br><span class="line">  <span class="type">android_namespace_t</span>* ns = <span class="built_in">get_caller_namespace</span>(caller);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* translated_name = name;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// (一些ASAN模式的邏輯, 不重要)...</span></span><br><span class="line">	</span><br><span class="line">  ProtectedDataGuard guard;</span><br><span class="line">  <span class="comment">// 關鍵點1: 查找so</span></span><br><span class="line">  soinfo* si = <span class="built_in">find_library</span>(ns, translated_name, flags, extinfo, caller);</span><br><span class="line">  loading_trace.<span class="built_in">End</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (si != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="type">void</span>* handle = si-&gt;<span class="built_in">to_handle</span>();</span><br><span class="line">    <span class="built_in">LD_LOG</span>(kLogDlopen,</span><br><span class="line">           <span class="string">&quot;... dlopen calling constructors: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,</span><br><span class="line">           si-&gt;<span class="built_in">get_realpath</span>(), si-&gt;<span class="built_in">get_soname</span>(), handle);</span><br><span class="line">    <span class="comment">// 關鍵點2: 調用so的初始化函數, 即.init 和 .init_array</span></span><br><span class="line">    si-&gt;<span class="built_in">call_constructors</span>();</span><br><span class="line">    failure_guard.<span class="built_in">Disable</span>();</span><br><span class="line">    <span class="built_in">LD_LOG</span>(kLogDlopen,</span><br><span class="line">           <span class="string">&quot;... dlopen successful: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,</span><br><span class="line">           si-&gt;<span class="built_in">get_realpath</span>(), si-&gt;<span class="built_in">get_soname</span>(), handle);</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>簡單記錄下<code>call_constructors</code>，畢竟不是本文的主線：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker_soinfo.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">soinfo::call_constructors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (constructors_called) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//....</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">// DT_INIT should be called before DT_INIT_ARRAY if both are present.</span></span><br><span class="line">  <span class="comment">// 1. 調用.init</span></span><br><span class="line">  <span class="built_in">call_function</span>(<span class="string">&quot;DT_INIT&quot;</span>, init_func_, <span class="built_in">get_realpath</span>());</span><br><span class="line">  <span class="comment">// 2. 調用.init_array</span></span><br><span class="line">  <span class="built_in">call_array</span>(<span class="string">&quot;DT_INIT_ARRAY&quot;</span>, init_array_, init_array_count_, <span class="literal">false</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_linker</span>()) &#123;</span><br><span class="line">    <span class="built_in">bionic_trace_end</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-library"><a href="#find-library" class="headerlink" title="find_library"></a><code>find_library</code></h3><p><code>find_library</code>中調用了<code>find_libraries</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> soinfo* <span class="title">find_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                            soinfo* needed_by)</span> </span>&#123;</span><br><span class="line">  soinfo* si;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// readers_map is shared across recursive calls to find_libraries.</span></span><br><span class="line">  <span class="comment">// However, the map is not shared across different threads.</span></span><br><span class="line">  std::unordered_map&lt;<span class="type">const</span> soinfo*, ElfReader&gt; readers_map;</span><br><span class="line">  <span class="keyword">if</span> (name == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    si = <span class="built_in">solist_get_somain</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">find_libraries</span>(ns,</span><br><span class="line">                             needed_by,</span><br><span class="line">                             &amp;name,</span><br><span class="line">                             <span class="number">1</span>,</span><br><span class="line">                             &amp;si,</span><br><span class="line">                             <span class="literal">nullptr</span>,</span><br><span class="line">                             <span class="number">0</span>,</span><br><span class="line">                             rtld_flags,</span><br><span class="line">                             extinfo,</span><br><span class="line">                             <span class="literal">false</span> <span class="comment">/* add_as_children */</span>,</span><br><span class="line">                             <span class="literal">true</span> <span class="comment">/* search_linked_namespaces */</span>,</span><br><span class="line">                             readers_map)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  si-&gt;<span class="built_in">increment_ref_count</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> si;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="find-libraries-分成七部分"><a href="#find-libraries-分成七部分" class="headerlink" title="find_libraries ( 分成七部分 )"></a><code>find_libraries</code> ( 分成七部分 )</h3><p>最終來到<code>find_libraries</code>，從源碼自帶的注釋來看，它可分為7個部分，以下是函數的聲明：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// add_as_children - add first-level loaded libraries (i.e. library_names[], but</span></span><br><span class="line"><span class="comment">// not their transitive dependencies) as children of the start_with library.</span></span><br><span class="line"><span class="comment">// This is false when find_libraries is called for dlopen(), when newly loaded</span></span><br><span class="line"><span class="comment">// libraries must form a disjoint tree.</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">find_libraries</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                    soinfo* start_with,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> library_names[],</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">size_t</span> library_names_count,</span></span></span><br><span class="line"><span class="params"><span class="function">                    soinfo* soinfos[],</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::vector&lt;soinfo*&gt;* ld_preloads,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">size_t</span> ld_preloads_count,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">bool</span> add_as_children,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">bool</span> search_linked_namespaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::unordered_map&lt;<span class="type">const</span> soinfo*, ElfReader&gt;&amp; readers_map,</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::vector&lt;<span class="type">android_namespace_t</span>*&gt;* namespaces)</span></span>;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p><strong>Step 0：準備階段</strong></p>
<p><code>library_names_count</code>固定為<code>1</code>，因此開頭的循環只會執行一次，創建了一個<code>LoadTask</code>並push到<code>load_tasks</code>中。</p>
<p>然後會為<code>soinfos</code>分配內存。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 0: prepare.</span></span><br><span class="line">LoadTaskList load_tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; library_names_count; ++i) &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* name = library_names[i];</span><br><span class="line">  load_tasks.<span class="built_in">push_back</span>(LoadTask::<span class="built_in">create</span>(name, start_with, ns, &amp;readers_map));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If soinfos array is null allocate one on stack.</span></span><br><span class="line"><span class="comment">// The array is needed in case of failure; for example</span></span><br><span class="line"><span class="comment">// when library_names[] = &#123;libone.so, libtwo.so&#125; and libone.so</span></span><br><span class="line"><span class="comment">// is loaded correctly but libtwo.so failed for some reason.</span></span><br><span class="line"><span class="comment">// In this case libone.so should be unloaded on return.</span></span><br><span class="line"><span class="comment">// See also implementation of failure_guard below.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (soinfos == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">  <span class="type">size_t</span> soinfos_size = <span class="built_in">sizeof</span>(soinfo*)*library_names_count;</span><br><span class="line">  soinfos = <span class="built_in">reinterpret_cast</span>&lt;soinfo**&gt;(<span class="built_in">alloca</span>(soinfos_size));</span><br><span class="line">  <span class="built_in">memset</span>(soinfos, <span class="number">0</span>, soinfos_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// list of libraries to link - see step 2.</span></span><br><span class="line"><span class="type">size_t</span> soinfos_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定義了2個作用域保護器, 在當前作用域結束時自動執行指定操作(清場)</span></span><br><span class="line"><span class="keyword">auto</span> scope_guard = android::base::<span class="built_in">make_scope_guard</span>([&amp;]() &#123;</span><br><span class="line">  <span class="keyword">for</span> (LoadTask* t : load_tasks) &#123;</span><br><span class="line">    LoadTask::<span class="built_in">deleter</span>(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">auto</span> failure_guard = android::base::<span class="built_in">make_scope_guard</span>([&amp;]() &#123;</span><br><span class="line">  <span class="comment">// Housekeeping</span></span><br><span class="line">  <span class="built_in">soinfo_unload</span>(soinfos, soinfos_count);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">ZipArchiveCache zip_archive_cache;</span><br></pre></td></tr></table></figure>

<p> <strong>Step 1：任務展開，尋找依據庫( so加載關鍵步驟 )</strong></p>
<p>在Step 0中調用了<code>LoadTask::create(name, start_with, ns, &amp;readers_map)</code>來創建任務，然後這裡又獲取了該任務，在創建時傳入了<code>start_with</code>作為task的needed_by，因此這裡的<code>needed_by</code>與<code>start_with</code>相等，而且<code>add_as_children</code>為<code>false</code>，所以<code>is_dt_needed</code>是<code>false</code>。</p>
<p>隨後<code>task</code>調用<code>set_extinfo</code>和<code>set_dt_needed</code>將對應屬性置為<code>extinfo</code>和<code>false</code>。</p>
<p><code>find_library_internal</code>函數是查找so的關鍵函數，留在後面單獨分析。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 1: expand the list of load_tasks to include</span></span><br><span class="line"><span class="comment">// all DT_NEEDED libraries (do not load them just yet)</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i&lt;load_tasks.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">  LoadTask* task = load_tasks[i];</span><br><span class="line">  soinfo* needed_by = task-&gt;<span class="built_in">get_needed_by</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> is_dt_needed = needed_by != <span class="literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);</span><br><span class="line">  task-&gt;<span class="built_in">set_extinfo</span>(is_dt_needed ? <span class="literal">nullptr</span> : extinfo);</span><br><span class="line">  task-&gt;<span class="built_in">set_dt_needed</span>(is_dt_needed);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// try to find the load.</span></span><br><span class="line">  <span class="comment">// Note: start from the namespace that is stored in the LoadTask. This namespace</span></span><br><span class="line">  <span class="comment">// is different from the current namespace when the LoadTask is for a transitive</span></span><br><span class="line">  <span class="comment">// dependency and the lib that created the LoadTask is not found in the</span></span><br><span class="line">  <span class="comment">// current namespace but in one of the linked namespace.</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">find_library_internal</span>(<span class="built_in">const_cast</span>&lt;<span class="type">android_namespace_t</span>*&gt;(task-&gt;<span class="built_in">get_start_from</span>()),</span><br><span class="line">                             task,</span><br><span class="line">                             &amp;zip_archive_cache,</span><br><span class="line">                             &amp;load_tasks,</span><br><span class="line">                             rtld_flags,</span><br><span class="line">                             search_linked_namespaces || is_dt_needed)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_dt_needed) &#123;</span><br><span class="line">    needed_by-&gt;<span class="built_in">add_child</span>(si);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (si-&gt;<span class="built_in">is_linked</span>()) &#123;</span><br><span class="line">      si-&gt;<span class="built_in">increment_ref_count</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When ld_preloads is not null, the first</span></span><br><span class="line">  <span class="comment">// ld_preloads_count libs are in fact ld_preloads.</span></span><br><span class="line">  <span class="keyword">if</span> (ld_preloads != <span class="literal">nullptr</span> &amp;&amp; soinfos_count &lt; ld_preloads_count) &#123;</span><br><span class="line">    ld_preloads-&gt;<span class="built_in">push_back</span>(si);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (soinfos_count &lt; library_names_count) &#123;</span><br><span class="line">    soinfos[soinfos_count++] = si;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 2：亂序加載libraries</strong></p>
<p>這裡的libraries應該是指Step 1中新增的那些依據庫，這裡亂序加載的目的好像是為了防攻擊？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 2: Load libraries in random order (see b/24047022)</span></span><br><span class="line">LoadTaskList load_list;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_tasks) &#123;</span><br><span class="line">  soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line">  <span class="keyword">auto</span> pred = [&amp;](<span class="type">const</span> LoadTask* t) &#123;</span><br><span class="line">    <span class="keyword">return</span> t-&gt;<span class="built_in">get_soinfo</span>() == si;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>() &amp;&amp;</span><br><span class="line">      std::<span class="built_in">find_if</span>(load_list.<span class="built_in">begin</span>(), load_list.<span class="built_in">end</span>(), pred) == load_list.<span class="built_in">end</span>() ) &#123;</span><br><span class="line">    load_list.<span class="built_in">push_back</span>(task);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">shuffle</span>(&amp;load_list);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_list) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!task-&gt;<span class="built_in">load</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 3：按BFS( 廣度優先 )來預鏈接所有共享庫</strong></p>
<p>調用<code>prelink_image</code>來實現預鏈接</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 3: pre-link all DT_NEEDED libraries in breadth first order.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_tasks) &#123;</span><br><span class="line">  soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line">  <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>() &amp;&amp; !si-&gt;<span class="built_in">prelink_image</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>prelink_image</code>函數如下，預鏈接的主要工作是解析<code>.dynamic</code>節。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">soinfo::prelink_image</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* Extract dynamic section */</span></span><br><span class="line">  <span class="built_in">ElfW</span>(Word) dynamic_flags = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">phdr_table_get_dynamic_section</span>(phdr, phnum, load_bias, &amp;dynamic, &amp;dynamic_flags);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We can&#x27;t log anything until the linker is relocated */</span></span><br><span class="line">  <span class="type">bool</span> relocating_linker = (flags_ &amp; FLAG_LINKER) != <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (!relocating_linker) &#123;</span><br><span class="line">    <span class="built_in">INFO</span>(<span class="string">&quot;[ Linking \&quot;%s\&quot; ]&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;si-&gt;base = %p si-&gt;flags = 0x%08x&quot;</span>, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(base), flags_);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dynamic == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!relocating_linker) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;missing PT_DYNAMIC in \&quot;%s\&quot;&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!relocating_linker) &#123;</span><br><span class="line">      <span class="built_in">DEBUG</span>(<span class="string">&quot;dynamic = %p&quot;</span>, dynamic);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 1. 解析.dynamic節</span></span><br><span class="line">  <span class="comment">// Extract useful information from dynamic section.</span></span><br><span class="line">  <span class="comment">// Note that: &quot;Except for the DT_NULL element at the end of the array,</span></span><br><span class="line">  <span class="comment">// and the relative order of DT_NEEDED elements, entries may appear in any order.&quot;</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// source: http://www.sco.com/developers/gabi/1998-04-29/ch5.dynamic.html</span></span><br><span class="line">  <span class="type">uint32_t</span> needed_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">ElfW</span>(Dyn)* d = dynamic; d-&gt;d_tag != DT_NULL; ++d) &#123;</span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;d = %p, d[0](tag) = %p d[1](val) = %p&quot;</span>,</span><br><span class="line">          d, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(d-&gt;d_tag), <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(d-&gt;d_un.d_val));</span><br><span class="line">    <span class="keyword">switch</span> (d-&gt;d_tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> DT_SONAME:</span><br><span class="line">        <span class="comment">// this is parsed after we have strtab initialized (see below).</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_HASH:</span><br><span class="line">        nbucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">0</span>];</span><br><span class="line">        nchain_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">1</span>];</span><br><span class="line">        bucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">8</span>);</span><br><span class="line">        chain_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">8</span> + nbucket_ * <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_GNU_HASH:</span><br><span class="line">        gnu_nbucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// skip symndx</span></span><br><span class="line">        gnu_maskwords_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">2</span>];</span><br><span class="line">        gnu_shift2_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        gnu_bloom_filter_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">16</span>);</span><br><span class="line">        gnu_bucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(gnu_bloom_filter_ + gnu_maskwords_);</span><br><span class="line">        <span class="comment">// amend chain for symndx = header[1]</span></span><br><span class="line">        gnu_chain_ = gnu_bucket_ + gnu_nbucket_ -</span><br><span class="line">            <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">powerof2</span>(gnu_maskwords_)) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid maskwords for gnu_hash = 0x%x, in \&quot;%s\&quot; expecting power to two&quot;</span>,</span><br><span class="line">              gnu_maskwords_, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        --gnu_maskwords_;</span><br><span class="line"></span><br><span class="line">        flags_ |= FLAG_GNU_HASH;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_STRTAB:</span><br><span class="line">        strtab_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_STRSZ:</span><br><span class="line">        strtab_size_ = d-&gt;d_un.d_val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_SYMTAB:</span><br><span class="line">        symtab_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Sym)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_SYMENT:</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Sym))) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid DT_SYMENT: %zd in \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">              <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(d-&gt;d_un.d_val), <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 完整性檢測</span></span><br><span class="line">  <span class="keyword">if</span> (relocating_linker &amp;&amp; needed_count != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;linker cannot have DT_NEEDED dependencies on other libraries&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (nbucket_ == <span class="number">0</span> &amp;&amp; gnu_nbucket_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;empty/missing DT_HASH/DT_GNU_HASH in \&quot;%s\&quot; &quot;</span></span><br><span class="line">        <span class="string">&quot;(new hash type from the future?)&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (strtab_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;empty/missing DT_STRTAB in \&quot;%s\&quot;&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (symtab_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;empty/missing DT_SYMTAB in \&quot;%s\&quot;&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. 根據上述解析好的strtab表來解析DT_SONAME、DT_RUNPATH</span></span><br><span class="line">  <span class="comment">// second pass - parse entries relying on strtab</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">ElfW</span>(Dyn)* d = dynamic; d-&gt;d_tag != DT_NULL; ++d) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (d-&gt;d_tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> DT_SONAME:</span><br><span class="line">        <span class="built_in">set_soname</span>(<span class="built_in">get_string</span>(d-&gt;d_un.d_val));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> DT_RUNPATH:</span><br><span class="line">        <span class="built_in">set_dt_runpath</span>(<span class="built_in">get_string</span>(d-&gt;d_un.d_val));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Step 4：構建global group</strong></p>
<p>global group是一組具有<code>DF_1_GLOBAL</code>標誌的共享庫，這些庫在加載過程中被確定為全局可見的。</p>
<ol>
<li>對於由環境變量<code>LD_PRELOAD</code>指定的庫，將強制設置<code>DF_1_GLOBAL</code>位，確保能夠在全局範圍被訪問。</li>
<li>收集在此次運行中新加載的具有<code>DF_1_GLOBAL</code>標誌的庫，這些庫將成為global group的新成員。</li>
<li>將新的global group成員添加到所有鏈接的命名空間中，具體是將每個<code>new_global_group_members</code>中的成員添加到除了其主要命名空間之外的所有鏈接命名空間。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4: Construct the global group. Note: DF_1_GLOBAL bit of a library is</span></span><br><span class="line"><span class="comment">// determined at step 3.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4-1: DF_1_GLOBAL bit is force set for LD_PRELOADed libs because they</span></span><br><span class="line"><span class="comment">// must be added to the global group</span></span><br><span class="line"><span class="keyword">if</span> (ld_preloads != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; si : *ld_preloads) &#123;</span><br><span class="line">    si-&gt;<span class="built_in">set_dt_flags_1</span>(si-&gt;<span class="built_in">get_dt_flags_1</span>() | DF_1_GLOBAL);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4-2: Gather all DF_1_GLOBAL libs which were newly loaded during this</span></span><br><span class="line"><span class="comment">// run. These will be the new member of the global group</span></span><br><span class="line"><span class="type">soinfo_list_t</span> new_global_group_members;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_tasks) &#123;</span><br><span class="line">  soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line">  <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>() &amp;&amp; (si-&gt;<span class="built_in">get_dt_flags_1</span>() &amp; DF_1_GLOBAL) != <span class="number">0</span>) &#123;</span><br><span class="line">    new_global_group_members.<span class="built_in">push_back</span>(si);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 4-3: Add the new global group members to all the linked namespaces</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> si : new_global_group_members) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> linked_ns : *namespaces) &#123;</span><br><span class="line">    <span class="keyword">if</span> (si-&gt;<span class="built_in">get_primary_namespace</span>() != linked_ns) &#123;</span><br><span class="line">      linked_ns-&gt;<span class="built_in">add_soinfo</span>(si);</span><br><span class="line">      si-&gt;<span class="built_in">add_secondary_namespace</span>(linked_ns);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 5：鏈接那些不屬於當前namespace的庫</strong></p>
<p>通過遞歸調用<code>find_libraries</code>來鏈接那些不屬於當前namespace的庫( 從Step 1中找到的 )</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 5: link libraries that are not destined to this namespace.</span></span><br><span class="line"><span class="comment">// Do this by recursively calling find_libraries on the namespace where the lib</span></span><br><span class="line"><span class="comment">// was found during Step 1.</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_tasks) &#123;</span><br><span class="line">  soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line">  <span class="keyword">if</span> (si-&gt;<span class="built_in">get_primary_namespace</span>() != ns) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name = task-&gt;<span class="built_in">get_name</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">find_libraries</span>(si-&gt;<span class="built_in">get_primary_namespace</span>(), task-&gt;<span class="built_in">get_needed_by</span>(), &amp;name, <span class="number">1</span>,</span><br><span class="line">                       <span class="literal">nullptr</span> <span class="comment">/* soinfos */</span>, <span class="literal">nullptr</span> <span class="comment">/* ld_preloads */</span>, <span class="number">0</span> <span class="comment">/* ld_preload_count */</span>,</span><br><span class="line">                       rtld_flags, <span class="literal">nullptr</span> <span class="comment">/* extinfo */</span>, <span class="literal">false</span> <span class="comment">/* add_as_children */</span>,</span><br><span class="line">                       <span class="literal">false</span> <span class="comment">/* search_linked_namespaces */</span>, readers_map, namespaces)) &#123;</span><br><span class="line">      <span class="comment">// If this lib is directly needed by one of the libs in this namespace,</span></span><br><span class="line">      <span class="comment">// then increment the count</span></span><br><span class="line">      soinfo* needed_by = task-&gt;<span class="built_in">get_needed_by</span>();</span><br><span class="line">      <span class="keyword">if</span> (needed_by != <span class="literal">nullptr</span> &amp;&amp; needed_by-&gt;<span class="built_in">get_primary_namespace</span>() == ns &amp;&amp; si-&gt;<span class="built_in">is_linked</span>()) &#123;</span><br><span class="line">        si-&gt;<span class="built_in">increment_ref_count</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Step 6：鏈接當前namespace的librarie</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 6: link libraries in this namespace</span></span><br><span class="line"><span class="type">soinfo_list_t</span> local_group;</span><br><span class="line"><span class="built_in">walk_dependencies_tree</span>(</span><br><span class="line">    (start_with != <span class="literal">nullptr</span> &amp;&amp; add_as_children) ? &amp;start_with : soinfos,</span><br><span class="line">    (start_with != <span class="literal">nullptr</span> &amp;&amp; add_as_children) ? <span class="number">1</span> : soinfos_count,</span><br><span class="line">    [&amp;] (soinfo* si) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ns-&gt;<span class="built_in">is_accessible</span>(si)) &#123;</span><br><span class="line">    local_group.<span class="built_in">push_back</span>(si);</span><br><span class="line">    <span class="keyword">return</span> kWalkContinue;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> kWalkSkip;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="type">soinfo_list_t</span> global_group = ns-&gt;<span class="built_in">get_global_group</span>();</span><br><span class="line"><span class="type">bool</span> linked = local_group.<span class="built_in">visit</span>([&amp;](soinfo* si) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!si-&gt;<span class="built_in">link_image</span>(global_group, local_group, extinfo) ||</span><br><span class="line">        !<span class="built_in">get_cfi_shadow</span>()-&gt;<span class="built_in">AfterLoad</span>(si, <span class="built_in">solist_get_head</span>())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (linked) &#123;</span><br><span class="line">  local_group.for_each([](soinfo* si) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>()) &#123;</span><br><span class="line">      si-&gt;<span class="built_in">set_linked</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  failure_guard.<span class="built_in">Disable</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> linked;</span><br></pre></td></tr></table></figure>

<h3 id="find-library-internal"><a href="#find-library-internal" class="headerlink" title="find_library_internal"></a><code>find_library_internal</code></h3><p>從上述Step 1中的<code>find_library_internal</code>繼續分析，大致流程如下：</p>
<ol>
<li>調用<code>find_loaded_library_by_soname</code>判斷so是否已被加載。</li>
<li>確認未曾加載過該so後，調用<code>load_library</code>來正式加載。</li>
<li>若在第2步中找不到，則嘗試在linked namespaces裡查找。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">find_library_internal</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  LoadTask* task,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  ZipArchiveCache* zip_archive_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  LoadTaskList* load_tasks,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">bool</span> search_linked_namespaces)</span> </span>&#123;</span><br><span class="line">  soinfo* candidate;</span><br><span class="line">	<span class="comment">// 判斷so是否已被加載</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">find_loaded_library_by_soname</span>(ns, task-&gt;<span class="built_in">get_name</span>(), search_linked_namespaces, &amp;candidate)) &#123;</span><br><span class="line">    task-&gt;<span class="built_in">set_soinfo</span>(candidate);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Library might still be loaded, the accurate detection</span></span><br><span class="line">  <span class="comment">// of this fact is done by load_library.</span></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ \&quot;%s\&quot; find_loaded_library_by_soname failed (*candidate=%s@%p). Trying harder...]&quot;</span>,</span><br><span class="line">      task-&gt;<span class="built_in">get_name</span>(), candidate == <span class="literal">nullptr</span> ? <span class="string">&quot;n/a&quot;</span> : candidate-&gt;<span class="built_in">get_realpath</span>(), candidate);</span><br><span class="line">	<span class="comment">// 關鍵點here</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags, search_linked_namespaces)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 當指定so沒有找到時, 會嘗試在linked namespaces裡查找</span></span><br><span class="line">  <span class="keyword">if</span> (search_linked_namespaces) &#123;</span><br><span class="line">    <span class="comment">// if a library was not found - look into linked namespaces</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; linked_namespace : ns-&gt;<span class="built_in">linked_namespaces</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">find_library_in_linked_namespace</span>(linked_namespace,</span><br><span class="line">                                           task)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (task-&gt;<span class="built_in">get_soinfo</span>() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">          <span class="comment">// try to load the library - once namespace boundary is crossed</span></span><br><span class="line">          <span class="comment">// we need to load a library within separate load_group</span></span><br><span class="line">          <span class="comment">// to avoid using symbols from foreign namespace while.</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// However, actual linking is deferred until when the global group</span></span><br><span class="line">          <span class="comment">// is fully identified and is applied to all namespaces.</span></span><br><span class="line">          <span class="comment">// Otherwise, the libs in the linked namespace won&#x27;t get symbols from</span></span><br><span class="line">          <span class="comment">// the global group.</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">load_library</span>(linked_namespace.<span class="built_in">linked_namespace</span>(), task, zip_archive_cache, load_tasks, rtld_flags, <span class="literal">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// lib was not found in the namespace. Try next linked namespace.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// lib is already loaded</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="load-library"><a href="#load-library" class="headerlink" title="load_library"></a><code>load_library</code></h3><p>繼續深入<code>load_library</code>：</p>
<ol>
<li><code>extinfo-&gt;flags</code>根據上方記錄的調用棧來看是<code>ANDROID_DLEXT_USE_NAMESPACE</code>，而<code>ANDROID_DLEXT_USE_LIBRARY_FD</code>的值如下，兩者<code>&amp;</code>的結果是<code>0</code>，因此不會走if分支。根據大佬的分析，這個if語句存在的意義是提高運行效率，一些底層的庫已被加載過，那麼就沒有必要再打開，搜索一次，直接把library的<code>fd</code>拿過來用就可以了。</li>
<li><code>open_library</code>打開指定so文件，就是在這個函數中調用最基礎的<code>open</code>函數來打開文件，並且返回<code>fd</code>。</li>
<li>調用另一個重載的<code>load_library</code>。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// external/libmojo/base/android/linker/android_dlext.h</span></span><br><span class="line">ANDROID_DLEXT_USE_LIBRARY_FD = <span class="number">0x10</span></span><br><span class="line"><span class="comment">// bionic/libc/include/android/dlext.h</span></span><br><span class="line">ANDROID_DLEXT_USE_NAMESPACE = <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="built_in">load_library</span>(<span class="type">android_namespace_t</span>* ns,</span><br><span class="line">                         LoadTask* task,</span><br><span class="line">                         ZipArchiveCache* zip_archive_cache,</span><br><span class="line">                         LoadTaskList* load_tasks,</span><br><span class="line">                         <span class="type">int</span> rtld_flags,</span><br><span class="line">                         <span class="type">bool</span> search_linked_namespaces) &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* name = task-&gt;<span class="built_in">get_name</span>();</span><br><span class="line">  soinfo* needed_by = task-&gt;<span class="built_in">get_needed_by</span>();</span><br><span class="line">  <span class="type">const</span> android_dlextinfo* extinfo = task-&gt;<span class="built_in">get_extinfo</span>();</span><br><span class="line"></span><br><span class="line">  <span class="type">off64_t</span> file_offset;</span><br><span class="line">  std::string realpath;</span><br><span class="line">  <span class="comment">// 1. 提高運行效率，一些底層的庫已被加載過，那麼就沒有必要再打開，搜索一次，直接把library的fd拿過來用就可以了</span></span><br><span class="line">  <span class="keyword">if</span> (extinfo != <span class="literal">nullptr</span> &amp;&amp; (extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD) != <span class="number">0</span>) &#123;</span><br><span class="line">    file_offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD_OFFSET) != <span class="number">0</span>) &#123;</span><br><span class="line">      file_offset = extinfo-&gt;library_fd_offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">realpath_fd</span>(extinfo-&gt;library_fd, &amp;realpath)) &#123;</span><br><span class="line">      <span class="built_in">PRINT</span>(<span class="string">&quot;warning: unable to get realpath for the library \&quot;%s\&quot; by extinfo-&gt;library_fd. &quot;</span></span><br><span class="line">            <span class="string">&quot;Will use given name.&quot;</span>, name);</span><br><span class="line">      realpath = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    task-&gt;<span class="built_in">set_fd</span>(extinfo-&gt;library_fd, <span class="literal">false</span>);</span><br><span class="line">    task-&gt;<span class="built_in">set_file_offset</span>(file_offset);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">load_library</span>(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 2. 正式打開指定so文件</span></span><br><span class="line">  <span class="comment">// Open the file.</span></span><br><span class="line">  <span class="type">int</span> fd = <span class="built_in">open_library</span>(ns, zip_archive_cache, name, needed_by, &amp;file_offset, &amp;realpath);</span><br><span class="line">  <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;library \&quot;%s\&quot; not found&quot;</span>, name);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  task-&gt;<span class="built_in">set_fd</span>(fd, <span class="literal">true</span>);</span><br><span class="line">  task-&gt;<span class="built_in">set_file_offset</span>(file_offset);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3. 調用另一個重載的load_library</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">load_library</span>(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>open_library</code>函數如下，在這裡會正式調用<code>open</code>來打開文件，並且返回對應的文件描述符</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">open_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ZipArchiveCache* zip_archive_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">char</span>* name, soinfo *needed_by,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">off64_t</span>* file_offset, std::string* realpath)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;[ opening %s at namespace %s]&quot;</span>, name, ns-&gt;<span class="built_in">get_name</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the name contains a slash, we should attempt to open it directly and not search the paths.</span></span><br><span class="line">  <span class="comment">// 1. 判斷name是否包含&#x27;/&#x27;, 是則進入該if分支</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strchr</span>(name, <span class="string">&#x27;/&#x27;</span>) != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// kZipFileSeparator == &quot;!/&quot;, 顯然name中沒有kZipFileSeparator, 因此不會走這條分支</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(name, kZipFileSeparator) != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      fd = <span class="built_in">open_library_in_zipfile</span>(zip_archive_cache, name, file_offset, realpath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">	    <span class="comment">// 2. 正式調用open打開文件</span></span><br><span class="line">      fd = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">open</span>(name, O_RDONLY | O_CLOEXEC));</span><br><span class="line">      <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        *file_offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">realpath_fd</span>(fd, realpath)) &#123;</span><br><span class="line">          <span class="built_in">PRINT</span>(<span class="string">&quot;warning: unable to get realpath for the library \&quot;%s\&quot;. Will use given path.&quot;</span>, name);</span><br><span class="line">          *realpath = name;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 3. 返回文件描述符</span></span><br><span class="line">    <span class="keyword">return</span> fd;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="load-library-重載版本"><a href="#load-library-重載版本" class="headerlink" title="load_library( 重載版本 )"></a><code>load_library</code>( 重載版本 )</h3><p>上述的<code>load_library</code>最後調用了如下重載的<code>load_library</code>，大致執行流程如下：</p>
<ol>
<li>一開始先校驗so文件的各種屬性是否符合規範。</li>
<li><code>extinfo-&gt;flags &amp; ANDROID_DLEXT_FORCE_LOAD</code>的結果是<code>0</code>，會走該if分支。調用<code>find_loaded_library_by_inode</code>在給定的命名空間中查找已加載的庫，並根據不同的條件判斷是否可以直接返回已加載的庫。</li>
<li>正式開始讀取so文件的elf header和一些segment，遍歷<code>.dynamic</code>節讀取<code>DT_RUNPATH</code>( so文件的運行路徑 )、<code>DT_SONAME</code>( so文件名 )、<code>DT_NEEDED</code>( so文件的依據庫 )，通通都會保存在<code>si</code>( <code>soinfo</code>結構體 )中。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bionic/linker/linker.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">load_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTask* task,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTaskList* load_tasks,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">const</span> std::string&amp; realpath,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">bool</span> search_linked_namespaces)</span> </span>&#123;</span><br><span class="line">  <span class="type">off64_t</span> file_offset = task-&gt;<span class="built_in">get_file_offset</span>();</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* name = task-&gt;<span class="built_in">get_name</span>();</span><br><span class="line">  <span class="type">const</span> android_dlextinfo* extinfo = task-&gt;<span class="built_in">get_extinfo</span>();</span><br><span class="line">	<span class="comment">// 1. 校驗so文件的各種屬性是否符合規範</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Check for symlink and other situations where</span></span><br><span class="line">  <span class="comment">// file can have different names, unless ANDROID_DLEXT_FORCE_LOAD is set</span></span><br><span class="line">  <span class="keyword">if</span> (extinfo == <span class="literal">nullptr</span> || (extinfo-&gt;flags &amp; ANDROID_DLEXT_FORCE_LOAD) == <span class="number">0</span>) &#123;</span><br><span class="line">    soinfo* si = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="comment">// 2. 在給定的命名空間中查找已加載的庫，並根據不同的條件判斷是否可以直接返回已加載的庫。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">find_loaded_library_by_inode</span>(ns, file_stat, file_offset, search_linked_namespaces, &amp;si)) &#123;</span><br><span class="line">      <span class="built_in">TRACE</span>(<span class="string">&quot;library \&quot;%s\&quot; is already loaded under different name/path \&quot;%s\&quot; - &quot;</span></span><br><span class="line">            <span class="string">&quot;will return existing soinfo&quot;</span>, name, si-&gt;<span class="built_in">get_realpath</span>());</span><br><span class="line">      task-&gt;<span class="built_in">set_soinfo</span>(si);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  soinfo* si = <span class="built_in">soinfo_alloc</span>(ns, realpath.<span class="built_in">c_str</span>(), &amp;file_stat, file_offset, rtld_flags);</span><br><span class="line">  <span class="keyword">if</span> (si == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  task-&gt;<span class="built_in">set_soinfo</span>(si);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 3. 正式開始讀取so文件</span></span><br><span class="line">  <span class="comment">// Read the ELF header and some of the segments.</span></span><br><span class="line">  <span class="keyword">if</span> (!task-&gt;<span class="built_in">read</span>(realpath.<span class="built_in">c_str</span>(), file_stat.st_size)) &#123;</span><br><span class="line">    <span class="built_in">soinfo_free</span>(si);</span><br><span class="line">    task-&gt;<span class="built_in">set_soinfo</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// find and set DT_RUNPATH and dt_soname</span></span><br><span class="line">  <span class="comment">// Note that these field values are temporary and are</span></span><br><span class="line">  <span class="comment">// going to be overwritten on soinfo::prelink_image</span></span><br><span class="line">  <span class="comment">// with values from PT_LOAD segments.</span></span><br><span class="line">  <span class="type">const</span> ElfReader&amp; elf_reader = task-&gt;<span class="built_in">get_elf_reader</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="built_in">ElfW</span>(Dyn)* d = elf_reader.<span class="built_in">dynamic</span>(); d-&gt;d_tag != DT_NULL; ++d) &#123;</span><br><span class="line">	<span class="comment">// 在.dynamic節找當前so的運行路徑和文件名</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;d_tag == DT_RUNPATH) &#123;</span><br><span class="line">      si-&gt;<span class="built_in">set_dt_runpath</span>(elf_reader.<span class="built_in">get_string</span>(d-&gt;d_un.d_val));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d-&gt;d_tag == DT_SONAME) &#123;</span><br><span class="line">      si-&gt;<span class="built_in">set_soname</span>(elf_reader.<span class="built_in">get_string</span>(d-&gt;d_un.d_val));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 在.dynamic節找所有的依據庫</span></span><br><span class="line">  for_each_dt_needed(task-&gt;<span class="built_in">get_elf_reader</span>(), [&amp;](<span class="type">const</span> <span class="type">char</span>* name) &#123;</span><br><span class="line">    load_tasks-&gt;<span class="built_in">push_back</span>(LoadTask::<span class="built_in">create</span>(name, si, ns, task-&gt;<span class="built_in">get_readers_map</span>()));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="要點記錄"><a href="#要點記錄" class="headerlink" title="要點記錄"></a>要點記錄</h2><p>記錄一些Android逆向要特別關注的點：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- System.loadLibrary()</span><br><span class="line">		- Runtime.loadLibrary()</span><br><span class="line">				- Runtime.doLoad()</span><br><span class="line">			      - Runtime_nativeLoad()</span><br><span class="line">		        - LoadNativeLibrary()</span><br><span class="line">			        - android_dlopen_ext()</span><br><span class="line">	              - do_dlopen()  // 打開動態庫</span><br><span class="line">									- .init()  // 初始化,通常一些反調試、檢測、ollvm字符加解密可能會在這裡</span><br><span class="line">									- .initarray() // 同理</span><br><span class="line">              - dlsym()  // 獲取方法指針( 會獲取JNI_OnLoad的方法指針 )</span><br><span class="line">              - JNI_OnLoad() // 根據從dlsym獲取的方法指針,執行JNI_OnLoad</span><br></pre></td></tr></table></figure>

<ul>
<li><code>System.loadLibrary</code>和<code>System.load</code>都可以用來加載so，區別是<code>loadLibrary</code>可以自動載入依賴庫，而<code>load</code>要指定特定路徑的動態庫</li>
<li>對於<code>loadLibrary</code>會將<code>xxx</code>動態庫的名字轉換為<code>libxxx.so</code>，再從<code>/data/app/[packagename]-1/lib/arm64</code>，<code>/vendor/lib64</code>，<code>/system/lib64</code>等路徑查詢對應的動態庫。</li>
<li>無論哪種方式，最終都會呼叫到<code>LoadNativeLibrary</code>方法，該方法主要操作：<ul>
<li>透過<code>dlopen</code>開啟動態共享庫</li>
<li>透過<code>dlsym</code>取得<code>JNI_OnLoad</code>符號所對應的方法</li>
<li>呼叫該載入庫中的<code>JNI_OnLoad</code>方法</li>
</ul>
</li>
<li>在<code>android_dlopen_ext</code>( android8後叫<code>dlopen_ext</code> )調用完成後，so其實已經加載、初始化完畢</li>
</ul>
<p><code>dlopen</code> 和 <code>dlsym</code> 的簡易例子( only for 理解，非實際例子 )：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//1.打开动态库，拿到一个动态库句柄</span></span><br><span class="line">	<span class="type">void</span>* handle = <span class="built_in">dlopen</span>(LIB_PATH, RTLD_NOW);</span><br><span class="line">  <span class="comment">//2.通过句柄和方法名获取方法指针地址</span></span><br><span class="line">	symAdd = <span class="built_in">dlsym</span>(handle, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">  <span class="comment">//3.将方法地址强制类型转换成方法指针</span></span><br><span class="line">	CACULATE_FUNC addFunc = <span class="built_in">reinterpret_cast</span>(symAdd);</span><br><span class="line">  <span class="comment">//4.调用动态库中的方法</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;1 + 2 = &quot;</span> &lt;&lt; <span class="built_in">addFunc</span>(<span class="number">1</span>, <span class="number">2</span>) &lt;&lt; endl;</span><br><span class="line">  <span class="comment">//5.通过句柄关闭动态库</span></span><br><span class="line">	<span class="built_in">dlclose</span>(handle);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="資料"><a href="#資料" class="headerlink" title="資料"></a>資料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://oacia.dev/android-load-so/">https://oacia.dev/android-load-so/</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1563054">https://cloud.tencent.com/developer/article/1563054</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/runope/p/14789784.html">https://www.cnblogs.com/runope/p/14789784.html</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-255674.htm">https://bbs.kanxue.com/thread-255674.htm</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">NgIokWeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">https://ngiokweng.github.io/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://ngiokweng.github.io" target="_blank">NgIokWeng's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/so%E6%96%87%E4%BB%B6/">so文件</a></div><div class="post_share"><div class="social-share" data-image="/2024/06/01/so%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/Untitled.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/"><img class="prev-cover" src="/2024/06/08/%E5%88%9D%E7%AA%BAARM%E5%B9%B3%E5%9D%A6%E5%8C%96%E9%82%84%E5%8E%9F/Untitled.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">初窺ARM平坦化還原</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/30/elf%E6%96%87%E4%BB%B6%E7%B5%90%E6%A7%8B/"><img class="next-cover" src="/2024/05/30/elf%E6%96%87%E4%BB%B6%E7%B5%90%E6%A7%8B/Untitled.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">elf文件結構</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/myImg/blogIcon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">NgIokWeng</div><div class="author-info__description">如果你對目前擁有的一切覺得不滿，等到你擁有更多時，也不見得會快樂</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ngiokweng/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#So%E5%8A%A0%E8%BC%89%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">So加載流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#System-loadLibrary%E8%88%87System-load"><span class="toc-number">2.1.</span> <span class="toc-text">System.loadLibrary與System.load</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime-load0"><span class="toc-number">2.2.</span> <span class="toc-text">Runtime.load0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nativeLoad"><span class="toc-number">2.3.</span> <span class="toc-text">nativeLoad</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM-NativeLoad"><span class="toc-number">2.4.</span> <span class="toc-text">JVM_NativeLoad</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadNativeLibrary"><span class="toc-number">2.5.</span> <span class="toc-text">LoadNativeLibrary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenNativeLibrary"><span class="toc-number">2.6.</span> <span class="toc-text">OpenNativeLibrary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#android-dlopen-ext"><span class="toc-number">2.7.</span> <span class="toc-text">android_dlopen_ext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#android-dlopen-ext-1"><span class="toc-number">2.8.</span> <span class="toc-text">__android_dlopen_ext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#do-dlopen"><span class="toc-number">2.9.</span> <span class="toc-text">do_dlopen</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-library"><span class="toc-number">2.10.</span> <span class="toc-text">find_library</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-libraries-%E5%88%86%E6%88%90%E4%B8%83%E9%83%A8%E5%88%86"><span class="toc-number">2.11.</span> <span class="toc-text">find_libraries ( 分成七部分 )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#find-library-internal"><span class="toc-number">2.12.</span> <span class="toc-text">find_library_internal</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load-library"><span class="toc-number">2.13.</span> <span class="toc-text">load_library</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load-library-%E9%87%8D%E8%BC%89%E7%89%88%E6%9C%AC"><span class="toc-number">2.14.</span> <span class="toc-text">load_library( 重載版本 )</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A6%81%E9%BB%9E%E8%A8%98%E9%8C%84"><span class="toc-number">3.</span> <span class="toc-text">要點記錄</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B3%87%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">資料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析"><img src="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LIAPP手遊保護分析"/></a><div class="content"><a class="title" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析">LIAPP手遊保護分析</a><time datetime="2024-11-28T11:59:08.000Z" title="發表於 2024-11-28 19:59:08">2024-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/20/so%E5%8A%A0%E8%BC%89%E2%80%94relocate%E7%AF%87/" title="so加載—relocate篇"><img src="/2024/11/20/so%E5%8A%A0%E8%BC%89%E2%80%94relocate%E7%AF%87/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="so加載—relocate篇"/></a><div class="content"><a class="title" href="/2024/11/20/so%E5%8A%A0%E8%BC%89%E2%80%94relocate%E7%AF%87/" title="so加載—relocate篇">so加載—relocate篇</a><time datetime="2024-11-20T12:07:14.000Z" title="發表於 2024-11-20 20:07:14">2024-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/10/%E3%80%90N1CTF2024%E3%80%91ezapk/" title="【N1CTF2024】ezapk"><img src="/2024/11/10/%E3%80%90N1CTF2024%E3%80%91ezapk/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【N1CTF2024】ezapk"/></a><div class="content"><a class="title" href="/2024/11/10/%E3%80%90N1CTF2024%E3%80%91ezapk/" title="【N1CTF2024】ezapk">【N1CTF2024】ezapk</a><time datetime="2024-11-10T11:24:24.000Z" title="發表於 2024-11-10 19:24:24">2024-11-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/05/%E6%B7%BA%E8%AB%87Cocos2djs%E9%80%86%E5%90%91/" title="淺談Cocos2djs逆向"><img src="/2024/09/05/%E6%B7%BA%E8%AB%87Cocos2djs%E9%80%86%E5%90%91/image14.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="淺談Cocos2djs逆向"/></a><div class="content"><a class="title" href="/2024/09/05/%E6%B7%BA%E8%AB%87Cocos2djs%E9%80%86%E5%90%91/" title="淺談Cocos2djs逆向">淺談Cocos2djs逆向</a><time datetime="2024-09-05T13:55:18.000Z" title="發表於 2024-09-05 21:55:18">2024-09-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/28/%E8%87%AA%E5%AF%A6%E7%8F%BELinker%E5%8A%A0%E8%BC%89so/" title="自實現Linker加載so"><img src="/2024/06/28/%E8%87%AA%E5%AF%A6%E7%8F%BELinker%E5%8A%A0%E8%BC%89so/Untitled.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="自實現Linker加載so"/></a><div class="content"><a class="title" href="/2024/06/28/%E8%87%AA%E5%AF%A6%E7%8F%BELinker%E5%8A%A0%E8%BC%89so/" title="自實現Linker加載so">自實現Linker加載so</a><time datetime="2024-06-28T09:21:58.000Z" title="發表於 2024-06-28 17:21:58">2024-06-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By NgIokWeng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '213c1281d4936c27991d',
      clientSecret: 'e52f4c4e54b9993a1226672a59463577a9fd73cd',
      repo: 'ngiokweng.github.io',
      owner: 'ngiokweng',
      admin: ['ngiokweng'],
      id: 'a228d2bfdb085a01e213671f8dd507d5',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>