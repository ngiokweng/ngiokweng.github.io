<!DOCTYPE html><html lang="zh-TW" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>2024騰訊遊戲安全大賽安卓決賽(復現) | NgIokWeng's Blog</title><meta name="keywords" content="UE4,騰訊遊戲安全大賽"><meta name="author" content="NgIokWeng"><meta name="copyright" content="NgIokWeng"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="2024騰訊遊戲安全大賽安卓決賽">
<meta property="og:type" content="article">
<meta property="og:title" content="2024騰訊遊戲安全大賽安卓決賽(復現)">
<meta property="og:url" content="https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/index.html">
<meta property="og:site_name" content="NgIokWeng&#39;s Blog">
<meta property="og:description" content="2024騰訊遊戲安全大賽安卓決賽">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png">
<meta property="article:published_time" content="2025-01-27T09:00:58.000Z">
<meta property="article:modified_time" content="2025-01-27T09:01:30.000Z">
<meta property="article:author" content="NgIokWeng">
<meta property="article:tag" content="Android逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png"><link rel="shortcut icon" href="/myImg/blogIcon.png"><link rel="canonical" href="https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="google-site-verification" content="iO5LJpaf7bluC9CxlRdPhowI-XL-OzJ-X6ixOkO3cuk"/><meta name="baidu-site-verification" content="code-ZZyU1mBcxX"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '複製成功',
    error: '複製錯誤',
    noSupport: '瀏覽器不支援'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '剛剛',
    min: '分鐘前',
    hour: '小時前',
    day: '天前',
    month: '個月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2024騰訊遊戲安全大賽安卓決賽(復現)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-01-27 17:01:30'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/myCustom.css"><meta name="generator" content="Hexo 5.4.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">載入中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/myImg/blogIcon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">NgIokWeng's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友鏈</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">2024騰訊遊戲安全大賽安卓決賽(復現)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">發表於</span><time class="post-meta-date-created" datetime="2025-01-27T09:00:58.000Z" title="發表於 2025-01-27 17:00:58">2025-01-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新於</span><time class="post-meta-date-updated" datetime="2025-01-27T09:01:30.000Z" title="更新於 2025-01-27 17:01:30">2025-01-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E9%80%86%E5%90%91/">Android逆向</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="2024騰訊遊戲安全大賽安卓決賽(復現)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">閱讀量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很少接觸UE4逆向，借這個比賽的題目來學習下UE4逆向和vm虛擬機。</p>
<p>主要參考這兩篇文章來復現：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0">「[原创] 2024腾讯游戏安全大赛-安卓赛道决赛VM分析与还原」</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281463.htm">「[原创] 腾讯游戏安全技术竞赛2024决赛 安卓方向解题报告」</a></li>
</ul>
<h2 id="Dump-SDK"><a href="#Dump-SDK" class="headerlink" title="Dump SDK"></a>Dump SDK</h2><p>UE4逆向的第一步基本都要先Dump SDK，否則根本無從下手。</p>
<h3 id="UE4三件套"><a href="#UE4三件套" class="headerlink" title="UE4三件套"></a>UE4三件套</h3><p>按常規方法靜態定位三件套。</p>
<p>GName：<code>0x4E2EC00</code></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image.png" alt="image.png"></p>
<p>GWorld：<code>0x4F5C0D0</code></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image1.png" alt="image.png"></p>
<p>GObject：<code>0x4E533AC</code></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image2.png" alt="image.png"></p>
<p>嘗試用ue4dumper來dump sdk，但失敗了。失敗的原因很有可能是<code>GWorld</code>的結構被魔改了。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image3.png" alt="image.png"></p>
<p>用frida驗證下GNmae字符串算法是否被魔改。</p>
<p>根據UE4.27源碼的<code>FNmae::ToString()</code>函數，可以得出32位程序的字符串算法如下。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getName32</span>(<span class="params">GName, idx</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ComparisonIndex</span> = idx;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FNameEntryAllocator</span> = <span class="title class_">GName</span>.<span class="title function_">add</span>(<span class="number">0x28</span>); <span class="comment">// 32位的FNameEntryAllocator偏移為0x28</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FNameBlockOffsetBits</span> = <span class="number">16</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FNameBlockOffsets</span> = <span class="number">65536</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Block</span> = <span class="title class_">ComparisonIndex</span> &gt;&gt; <span class="title class_">FNameBlockOffsetBits</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Offset</span> = <span class="title class_">ComparisonIndex</span> &amp; (<span class="title class_">FNameBlockOffsets</span> - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Blocks</span>_Offset = <span class="number">0x8</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Blocks</span> = <span class="title class_">FNameEntryAllocator</span>.<span class="title function_">add</span>(<span class="title class_">Blocks</span>_Offset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FNameEntry</span> = <span class="title class_">Blocks</span>.<span class="title function_">add</span>(<span class="title class_">Block</span> * <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>().<span class="title function_">add</span>(<span class="title class_">Offset</span> * <span class="number">2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FNameEntryHeader</span> = <span class="title class_">FNameEntry</span>.<span class="title function_">readU16</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&quot;FNameEntry: &quot;, hexdump(FNameEntry));</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isWide = <span class="title class_">FNameEntryHeader</span> &amp; <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Len</span> = <span class="title class_">FNameEntryHeader</span> &gt;&gt; <span class="number">6</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// console.log(&quot;len: &quot;, Len)</span></span><br><span class="line">    <span class="comment">// console.log(hexdump(FNameEntry))</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == isWide) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`\x1b[32m[+] <span class="subst">$&#123;FNameEntry.add(<span class="number">2</span>).readCString(Len)&#125;</span>\x1b[0m`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// base == libUE4.so base</span></span><br><span class="line"><span class="title function_">getName32</span>(base.<span class="title function_">add</span>(<span class="number">0x4E2EC00</span>), <span class="number">0</span>)</span><br><span class="line"><span class="title function_">getName32</span>(base.<span class="title function_">add</span>(<span class="number">0x4E2EC00</span>), <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>打印出前2個字符串如下，符合預期，代表<code>GName</code>地址是正確的且字符串算法大概率沒有被魔改。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image4.png" alt="image.png"></p>
<h3 id="結構修復"><a href="#結構修復" class="headerlink" title="結構修復"></a>結構修復</h3><p>通過CE觀察內存的方式來修復結構。</p>
<p>總結，要修改的offset如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// jni\Offsets.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// add to: patchCustom_32()</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">isTencentGamematch2024final</span>()) &#123;</span><br><span class="line">    <span class="comment">//Class: UObject</span></span><br><span class="line">    <span class="comment">// UObjectToInternalIndex = 0x8;</span></span><br><span class="line">    UObjectToClassPrivate = <span class="number">0x14</span>;</span><br><span class="line">    UObjectToFNameIndex = <span class="number">0x18</span>;</span><br><span class="line">    UObjectToOuterPrivate = <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: UStruct</span></span><br><span class="line">    UStructToSuperStruct = <span class="number">0x40</span>;</span><br><span class="line"></span><br><span class="line">    UStructToChildren = <span class="number">0x6c</span>;</span><br><span class="line">    UStructToChildProperties = <span class="number">0x44</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: UWorld</span></span><br><span class="line">    UWorldToPersistentLevel = <span class="number">0x58</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: ULevel</span></span><br><span class="line">    ULevelToAActors = <span class="number">0x9C</span>;</span><br><span class="line">    ULevelToAActorsCount = <span class="number">0xA0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: UFunction</span></span><br><span class="line">    UFunctionToFunc = <span class="number">0xA4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: UField</span></span><br><span class="line">    UFieldToNext = <span class="number">0x2C</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: FUObjectArray</span></span><br><span class="line">    <span class="comment">// FUObjectArrayToTUObjectArray = 0x10;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Class: TUObjectArray</span></span><br><span class="line">    TUObjectArrayToNumElements = <span class="number">0xC</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Global</span></span><br><span class="line">    FUObjectItemPadd = <span class="number">0x4</span>;</span><br><span class="line">    FUObjectItemSize = <span class="number">0x14</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新編譯修改Offset後的<code>ue4dumper</code>，再次嘗試dump sdk，這次成功了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ue4dumper_ext --sdku --newue+ --gname 0x4E2EC00 --guobj 0x4E533AC --package com.tencent.ace.gamematch2024final</span><br></pre></td></tr></table></figure>

<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image5.png" alt="image.png"></p>
<h2 id="基礎保護"><a href="#基礎保護" class="headerlink" title="基礎保護"></a>基礎保護</h2><p>簡單看看程序的一些保護，詳細分析可看：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0">https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0</a></p>
<h3 id="hook-svc"><a href="#hook-svc" class="headerlink" title="hook svc"></a>hook svc</h3><p>hook <code>openat</code>系統調用：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image6.png" alt="image.png"></p>
<p>hook <code>access</code>系統調用：檢測了root、magisk、riru、sandhook、frida等</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image7.png" alt="image.png"></p>
<p>除此之外還有CRC校驗代碼段，frida hook會改變代碼段，從而被檢測到。</p>
<h3 id="bypass思路1"><a href="#bypass思路1" class="headerlink" title="bypass思路1"></a>bypass思路1</h3><p>嘗試hook <code>pthread_create</code>，但檢測代碼貌似不在這。</p>
<p>查了查UE4的定時器，發現<code>SetTimer</code>函數：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetTimer</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    FTimerHandle &amp; InOutHandle,</span></span></span><br><span class="line"><span class="params"><span class="function">    UserClass * InObj,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">typename</span> FTimerDelegate::TUObjectMethodDelegate_Const&lt; UserClass &gt;::FMethodPtr InTimerMethod,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">float</span> InRate,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> InbLoop,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">float</span> InFirstDelay</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br></pre></td></tr></table></figure>

<p>在SDK裡搜，看到<code>K2_SetTimer</code>。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image8.png" alt="image.png"></p>
<p>根據官網對<code>SetTimer</code>的描述，hook <code>K2_SetTimer</code>並將<code>InRate</code>置為負數，成功讓程序在過一會後仍不會閃退。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image9.png" alt="image.png"></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(base.<span class="title function_">add</span>(<span class="number">0x37AD990</span>),&#123;</span><br><span class="line">    <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">        args[<span class="number">3</span>] = <span class="title function_">ptr</span>(-<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="bypass思路2"><a href="#bypass思路2" class="headerlink" title="bypass思路2"></a>bypass思路2</h3><p>在SDK裡可以看到<code>start1</code>、<code>start2</code>函數，十分可疑。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image10.png" alt="image.png"></p>
<p>嘗試直接patch掉，同樣不再閃退。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch_anti</span>(<span class="params">base</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> targetAddress2 = base.<span class="title function_">add</span>(<span class="number">0x223c534</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress2, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, []));</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">var</span> targetAddress3 = base.<span class="title function_">add</span>(<span class="number">0x223c544</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(targetAddress3, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, <span class="string">&#x27;int&#x27;</span>, []));</span><br><span class="line">     </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="初見登錄邏輯"><a href="#初見登錄邏輯" class="headerlink" title="初見登錄邏輯"></a>初見登錄邏輯</h2><p>在Dump下來的SDK裡搜尋相關的關鍵字，找到<code>CheckPassWordInc</code>。</p>
<p>用frida hook該函數的中轉地址<code>0x19f63a4</code>，的確每次點擊登錄按鈕時都會觸發。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image11.png" alt="image.png"></p>
<p>將<code>libUE4.so</code>拉入IDA分析，發現具體的check邏輯在<code>sub_19F4304</code>裡進行，一開始先判斷了輸入的長度是否為<code>32</code>。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image12.png" alt="image.png"></p>
<p>繼續向下看，發現只有<code>sub_46CFDDC</code>這個函數被混淆得特別嚴重。</p>
<p>hook看看該函數的參數，<code>args[0]</code>是32字節的輸入，<code>args[1]</code>一開始是空，在函數leave時同樣保存著32字節的數據，應該是加密結果，即該函數就是具體的加密函數。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image13.png" alt="image.png"></p>
<p>加密函數被混淆成這樣根本無從分析，接下來先用Unicorn來解混淆。</p>
<h2 id="Unicorn模擬執行解混淆"><a href="#Unicorn模擬執行解混淆" class="headerlink" title="Unicorn模擬執行解混淆"></a>Unicorn模擬執行解混淆</h2><p>主要有以下兩種混淆，都可以算是間接跳轉：</p>
<ol>
<li><code>it.cc</code> + <code>mov pc</code>的組合。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:046D1C60                 CMP             R0, #0</span><br><span class="line">.text:046D1C62                 IT NE</span><br><span class="line">.text:046D1C64                 MOVNE           R1, #8</span><br><span class="line">.text:046D1C66                 LDR             R0, [R4,#0x14]</span><br><span class="line">.text:046D1C68                 MOV             R2, R9</span><br><span class="line">.text:046D1C6A                 ADD             R0, R9</span><br><span class="line">.text:046D1C6C                 LDR             R0, [R0,R1]</span><br><span class="line">.text:046D1C6E                 ADD             R0, R6</span><br><span class="line">.text:046D1C70                 MOV             PC, R0</span><br></pre></td></tr></table></figure>

<p>IDA F5會像這樣：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image14.png" alt="image.png"></p>
<p>注：可能會存在這種只有<code>it.cc</code>沒有<code>mov pc, &lt;reg&gt;</code>的，要注意。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:046D2834                 IT CC</span><br><span class="line">.text:046D2836                 MOVCC           R0, #1</span><br><span class="line">.text:046D2838                 STRD.W          R6, R5, [R1,#0x44]</span><br><span class="line">.text:046D283C                 STRD.W          R0, R2, [R1,#0x4C]</span><br><span class="line">.text:046D2840                 POP.W           &#123;R11&#125;</span><br><span class="line">.text:046D2844                 POP             &#123;R4-R7,PC&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><code>blx &#123;register&#125;</code>間接跳轉。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:046CFDF6                 LDRD.W          R1, R0, [R6]</span><br><span class="line">.text:046CFDFA                 LDR             R2, [R6,#(off_4D89E98 - 0x4D89E90)]</span><br><span class="line">.text:046CFDFC                 ADD             R0, R4</span><br><span class="line">.text:046CFDFE                 MOV             R9, R5</span><br><span class="line">.text:046CFE00                 LDR             R1, [R1,R4]</span><br><span class="line">.text:046CFE02                 ADDS            R3, R1, R5</span><br><span class="line">.text:046CFE04                 ADDS            R1, R2, R4</span><br><span class="line">.text:046CFE06                 ADDS            R1, #0x19</span><br><span class="line">.text:046CFE08                 BLX             R3      ; sub_46D2DCC</span><br></pre></td></tr></table></figure>

<p>IDA F5會像這樣：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image15.png" alt="image.png"></p>
<h3 id="解混淆思路"><a href="#解混淆思路" class="headerlink" title="解混淆思路"></a>解混淆思路</h3><p>解混淆的思路 &amp; 腳本來源於：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281463.htm">https://bbs.kanxue.com/thread-281463.htm</a>。</p>
<p>簡單說下上面這篇文章的解混淆思路。</p>
<p><code>it.cc</code> + <code>mov pc &lt;reg&gt;</code>這種組合可以直接轉換成<code>b.cc &lt;branch1&gt;</code> + <code>b &lt;branch2&gt;</code>這套條件分支指令，前提是要知道2個分支的具體地址，因此解混淆的目的就是想辦法獲取具體的分支地址。</p>
<ol>
<li>先執行一次目標函數，目的是獲取這些信息：<code>it.cc</code>所在地址( 也就是待patch的地址 )、<code>it.cc</code>所在位置的context( 用於之後模擬執行另一個分支 )、<code>mov pc &lt;reg&gt;</code>執行後的地址( 第1個分支 )。</li>
<li>以BFS的方式遍歷上述獲取的信息，恢復到<code>it.cc</code>位置的狀態，然後修改CPSR標誌寄存器，從而執行另一條分支。</li>
<li>不斷重複第2步，盡可能覆蓋多一點路徑。</li>
</ol>
<p>在其基礎上我添加了<code>hook_blx_reg</code>用來處理<code>blx</code>間接跳轉，具體邏輯和上面差不多：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hook_blx_reg</span>(<span class="params">emu: Uc, addr, size, user_data</span>):</span><br><span class="line">    <span class="keyword">global</span> do_blx_reg</span><br><span class="line">    <span class="keyword">global</span> prev_blx_addr</span><br><span class="line">    <span class="keyword">global</span> blx_config</span><br><span class="line">    <span class="keyword">global</span> disasm_history_blx</span><br><span class="line">    <span class="keyword">global</span> prev_ins_size</span><br><span class="line">    <span class="keyword">global</span> prev_blx_prev_ins_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 限制一下, 否則每次都disasm會非常慢</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> do_blx_reg:</span><br><span class="line">        <span class="keyword">if</span> addr <span class="keyword">in</span> disasm_history_blx:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    disasm_history_blx[addr] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    disasm = get_disasm(emu, addr, size)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> disasm:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    offset = addr - libUE4_base</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 判斷是否 blx reg, 是就代表間接跳轉, 記錄下blx的地址</span></span><br><span class="line">    <span class="keyword">if</span> disasm.mnemonic == <span class="string">&quot;blx&quot;</span> <span class="keyword">and</span> disasm.operands[<span class="number">0</span>].reg &gt;= UC_ARM_REG_R0 <span class="keyword">and</span> disasm.operands[<span class="number">0</span>].reg &lt;= UC_ARM_REG_R12:</span><br><span class="line">        do_blx_reg = <span class="literal">True</span></span><br><span class="line">        prev_blx_addr = offset</span><br><span class="line">        <span class="comment"># prev_ins = get_disasm(emu, addr - prev_ins_size, prev_ins_size)</span></span><br><span class="line">        <span class="comment"># print(hex((addr - prev_ins_size - libUE4_base)) + &#x27;\t&#x27; + prev_ins.mnemonic + &#x27;\t&#x27; + prev_ins.op_str + &#x27;\t&#x27; + str(prev_ins_size))</span></span><br><span class="line">        prev_blx_prev_ins_size = prev_ins_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> do_blx_reg:</span><br><span class="line">        <span class="keyword">if</span> prev_blx_addr <span class="keyword">in</span> blx_config <span class="keyword">and</span> blx_config[prev_blx_addr].blx_addr != offset:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(prev_blx_addr)&#125;</span>: blx有多個目標地址?&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 只接受libUE4.so裡的地址, 其他系統函數的地址不處理</span></span><br><span class="line">        <span class="keyword">if</span> addr &gt; libUE4_base <span class="keyword">and</span> addr &lt; libUE4_end:</span><br><span class="line">            blx_config[prev_blx_addr] = BlxConfig(prev_blx_addr, offset, prev_blx_prev_ins_size)</span><br><span class="line"></span><br><span class="line">        do_blx_reg = <span class="literal">False</span></span><br><span class="line">        prev_blx_addr = <span class="literal">None</span></span><br><span class="line">        prev_blx_prev_ins_size = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    prev_ins_size = size</span><br></pre></td></tr></table></figure>

<h3 id="一些不足之處"><a href="#一些不足之處" class="headerlink" title="一些不足之處"></a>一些不足之處</h3><ol>
<li>針對<code>blx</code>間接跳轉的解混淆，會導致第0個參數被覆蓋</li>
</ol>
<p>原本是這樣的：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image16.png" alt="image.png"></p>
<p>腳本Patch後是這樣的：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image17.png" alt="image.png"></p>
<p>可以看到<code>mov r0, r10</code>這句被覆蓋了，而這句正是<code>get_bit</code>函數的第0個參數的賦值指令。</p>
<ol>
<li>針對<code>it.cc</code>間接跳轉的解混淆，會導致一些上下文缺失</li>
</ol>
<p>紅框那部份代碼除了在計算間接跳轉的地址外，還包含一些後續需要的上下文，但本腳本的patch選擇直接從藍框那裡跳轉，導致缺失了紅框中的一些上下文。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image18.png" alt="image.png"></p>
<p>最終會影響IDA F5的分析：這個<code>0x60</code>應該是<code>vm_ctx[b4]</code>才對。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image19.png" alt="image.png"></p>
<ol>
<li>IDA跳轉地址解析出錯</li>
</ol>
<p><code>0x46d0792</code>這個地址的指令理應是<code>beq 0x46d0f16</code>才對，但IDA解析成了另一個地址，暫時不知原因。( 就算手動Keypatch為<code>beq 0x46d0f16</code>也是顯示<code>beq.w loc_47A16AA+2</code> )</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image20.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image21.png" alt="image.png"></p>
<p>解決方案：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 計算: <span class="number">0x47A16AA</span> + <span class="number">2</span> - <span class="number">0x46d0f16</span> = <span class="number">0xD0796</span></span><br><span class="line"><span class="number">2.</span> <span class="number">0x46d0f16</span> - <span class="number">0xD0796</span> = <span class="number">0x4600780</span></span><br><span class="line"><span class="number">3.</span> 改為 beq <span class="number">0x4600780</span></span><br></pre></td></tr></table></figure>

<p>然後IDA就會顯示為預期的<code>beq 0x46d0f16</code></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image22.png" alt="image.png"></p>
<aside>
💡

<p>綜上不足之處，IDA的F5偽代碼只能作為參考，分析時一定要結合( 原so的 )匯編來一起看。</p>
</aside>

<h2 id="Section0：登錄邏輯分析"><a href="#Section0：登錄邏輯分析" class="headerlink" title="Section0：登錄邏輯分析"></a>Section0：登錄邏輯分析</h2><p>在解混淆以及對部份函數手動重新解析後，可以在IDA的F5視圖裡看到登錄的密文為：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image23.png" alt="image.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x3D</span>, <span class="number">0xF2</span>, <span class="number">0x2C</span>, <span class="number">0xF8</span>, <span class="number">0x8F</span>, <span class="number">0xFB</span>, <span class="number">0x47</span>, <span class="number">0x5B</span>, <span class="number">0x49</span>, <span class="number">0x04</span>, <span class="number">0x78</span>, <span class="number">0xD9</span>, <span class="number">0x4E</span>, <span class="number">0x31</span>, <span class="number">0xEF</span>, <span class="number">0x3E</span>, <span class="number">0xA1</span>, <span class="number">0xA7</span>, <span class="number">0xAA</span>, <span class="number">0x7B</span>, <span class="number">0xCF</span>, <span class="number">0x72</span>, <span class="number">0xA8</span>, <span class="number">0xBC</span>, <span class="number">0x53</span>, <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x00</span>, <span class="number">0xB2</span>, <span class="number">0xB0</span>, <span class="number">0x32</span>, <span class="number">0xFA</span></span><br></pre></td></tr></table></figure>

<p>而<code>sub_46CFDDC</code>這個被嚴重混淆的函數，主要做了3件事：</p>
<ol>
<li>解密opcodes。</li>
<li>調用<code>vm_init</code>初始化vm虛擬機。</li>
<li>調用<code>vm_start</code>啟動vm虛擬機，在其中執行加密邏輯。</li>
</ol>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image24.png" alt="image.png"></p>
<h3 id="vm初始化"><a href="#vm初始化" class="headerlink" title="vm初始化"></a>vm初始化</h3><p>一開始先調用<code>sub_46D2754</code>來解密opcodes，然後初始化<code>vm_ctx</code>，它類似於arm32的寄存器。</p>
<p>在<code>vm_ctx</code>初始化後打印看看其中的值，可以初步確定以下幾個的含義：</p>
<ul>
<li><code>vm_ctx[0]</code>：字符串<code>&quot;tencentgamesecfs&quot;</code>，大概率就是key。</li>
<li><code>vm_ctx[1]</code>：16，key的長度。</li>
<li><code>vm_ctx[2]</code>：input。</li>
<li><code>vm_ctx[3]</code>：一片空的內存空間，大概是用來存放output的。</li>
</ul>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image25.png" alt="image.png"></p>
<p><code>sub_46D2754</code>解密的opcodes最終會保存在<code>vm_ctx[21]</code>指向的地址，大小為<code>0x323C</code>個字節。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image26.png" alt="image.png"></p>
<p>在<code>vm_init</code>的leave時機dump opcodes。</p>
<p><code>swap32</code>函數用來翻轉字節，因為在之後的vm中也是會對每個opcode執行該操作，這裡提前預處理下。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">function</span> <span class="title function_">hook_vm_init</span>(<span class="params">base</span>) &#123;</span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">swap32</span>(<span class="params">val</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> ((val &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>)</span><br><span class="line">                 | ((val &amp; <span class="number">0xFF00</span>) &lt;&lt; <span class="number">8</span>)</span><br><span class="line">                 | ((val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span>)</span><br><span class="line">                 | ((val &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">dump_opcode</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> opcodes = [];</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x323C</span>; i += <span class="number">4</span>) &#123;</span><br><span class="line">              <span class="keyword">let</span> opcode = <span class="title function_">ptr</span>(<span class="title function_">swap32</span>(addr.<span class="title function_">add</span>(i).<span class="title function_">readU32</span>()));</span><br><span class="line">              opcodes.<span class="title function_">push</span>(opcode);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(opcodes.<span class="title function_">join</span>(<span class="string">&quot;,&quot;</span>))</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// vm_init</span></span><br><span class="line">      <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(base.<span class="title function_">add</span>(<span class="number">0x46CFEAC</span>).<span class="title function_">add</span>(<span class="number">1</span>),&#123;</span><br><span class="line">          <span class="title function_">onEnter</span>(<span class="params">args</span>)&#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">vm_ctx</span> = args[<span class="number">1</span>];</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="title function_">onLeave</span>(<span class="params">retval</span>)&#123;</span><br><span class="line">              <span class="keyword">let</span> opcodes_addr = <span class="variable language_">this</span>.<span class="property">vm_ctx</span>.<span class="title function_">add</span>(<span class="number">4</span>*<span class="number">21</span>).<span class="title function_">readPointer</span>()</span><br><span class="line">              <span class="title function_">dump_opcode</span>(opcodes_addr)</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="vm分析"><a href="#vm分析" class="headerlink" title="vm分析"></a>vm分析</h3><p><code>vm_start</code>開頭的代碼如下，<code>v22</code>明顯是<code>opcode</code>，而<code>v22</code>是<code>*v18</code>字節翻轉而來，<code>v18=vm_ctx[15]</code>，即<code>vm_ctx[15]</code>相當於pc寄存器( 指向下一條要執行的指令 )。</p>
<p>從 <code>*v15 += 8</code>也能確定<code>vm_ctx[15]</code>就代表pc。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image27.png" alt="image.png"></p>
<p>向下看那個大switch，每個case都對應了不同的handler，而基本上每個handler裡都有調用<code>get_bit</code>函數。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image28.png" alt="image.png"></p>
<p><code>get_bit</code>函數如下，其實就是在取<code>a2</code>的<code>a3 ~ a4</code>位，而<code>a2</code>固定是opcode。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image29.png" alt="image.png"></p>
<p>每個handler在最後都有將<code>pc -= 4</code>的操作，記得在上面曾將<code>pc += 8</code>，因此這時的pc正好指向下一條指令 ( 每個opcode占4字節 )。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image30.png" alt="image.png"></p>
<p>接著從匯編視圖分析<code>JUMPOUT(0x46D156A)</code>，發現當下一條指令不為0時，則會跳回<code>bswap32</code>上面，繼續執行下一條指令。( 跳轉指令除外 )</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image31.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image32.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image33.png" alt="image.png"></p>
<p>簡單總結下該vm虛擬機的執行流程：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 從pc取opcode</span><br><span class="line"><span class="number">2.</span> 調用bswap翻轉opcode</span><br><span class="line"><span class="number">3.</span> pc += <span class="number">8</span></span><br><span class="line"><span class="number">4.</span> <span class="keyword">switch</span> handler</span><br><span class="line"><span class="number">5.</span> on handler end: pc -= <span class="number">4</span></span><br><span class="line"><span class="number">6.</span> (跳轉指令除外) 判斷pc指向的下一個opcode是否為<span class="number">0</span>, 若是則<span class="keyword">return</span>, 否則回到【<span class="number">1</span>】</span><br></pre></td></tr></table></figure>

<p>接下來就是分析每個handler，從而還原vm。</p>
<h3 id="vm-handler分析"><a href="#vm-handler分析" class="headerlink" title="vm handler分析"></a>vm handler分析</h3><p>從上面的分析可知，<code>vm_ctx[15]</code>對應<code>pc</code>，<code>vm_ctx[0 ~ 3]</code>對應<code>r0 ~ r3</code>。</p>
<p>再看handler1、handler2，明顯是入棧、出棧的操作，<code>vm_ctx[13]</code>就是<code>sp</code>，同樣對應arm的<code>r13</code>( sp )。</p>
<p>由此可以推斷，每個handler都能轉換成與其等價( 或差不多 )的arm匯編指令。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image34.png" alt="image.png"></p>
<p>handler1、handler2對應的arm匯編指令是<code>push</code>、<code>pop</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler1_push</span>(<span class="params">opcode</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;push &#123;r4-r7, lr&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler2_pop</span>(<span class="params">opcode</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;pop &#123;r4-r7, pc&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>下面再簡單記錄幾個handler的分析過程( 主要是一些分析技巧和一些我很少見的arm指令 )。</p>
<p><strong>handler3分析：</strong></p>
<p>IDA F5的偽代碼只能作為參考，實際分析時要結合匯編來看。</p>
<p>先用frida stalker打印匯編執行流，記為<code>trace.log</code>。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(baseAddr.<span class="title function_">add</span>(<span class="number">0x46CFFAC</span>).<span class="title function_">add</span>(<span class="number">1</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[call 46CFFAC]&quot;</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tid</span> = <span class="title class_">Process</span>.<span class="title function_">getCurrentThreadId</span>();</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">follow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>, &#123;</span><br><span class="line">            <span class="attr">transform</span>: <span class="keyword">function</span>(<span class="params">iterator</span>) &#123;</span><br><span class="line">                <span class="keyword">let</span> instruction = iterator.<span class="title function_">next</span>();</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="comment">// 限制為當前模塊的指令</span></span><br><span class="line">                    <span class="keyword">if</span>(instruction.<span class="property">address</span> &gt;= baseAddr &amp;&amp; instruction.<span class="property">address</span> &lt;= baseAddr.<span class="title function_">add</span>(baseInfo.<span class="property">size</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;ptr(instruction.address - baseAddr)&#125;</span>: <span class="subst">$&#123;instruction.mnemonic&#125;</span> <span class="subst">$&#123;instruction.opStr&#125;</span>`</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                  </span><br><span class="line">                    iterator.<span class="title function_">keep</span>();</span><br><span class="line">                &#125; <span class="keyword">while</span>((instruction = iterator.<span class="title function_">next</span>()) != <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Stalker</span>.<span class="title function_">unfollow</span>(<span class="variable language_">this</span>.<span class="property">tid</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>從<code>trace.log</code>一路向上跟，會發現<code>vm_ctx_1</code>就是<code>vm_start</code>的args[1]，即<code>vm_ctx</code>。</p>
<p>這無法從F5的偽代碼中直接看出。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image35.png" alt="image.png"></p>
<p>找不到<code>v12</code>初始化的地址，但發現有個<code>get_bit</code>沒有接收其返回值，猜測其實它的返回值被保存在<code>v12</code>中。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image36.png" alt="image.png"></p>
<p>同樣用frida stalker來驗證，直接打印寄存器( <code>r0</code>是<code>get_bit</code>的返回值，<code>r8</code>是<code>v12</code> )</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title class_">Number</span>(instruction.<span class="property">address</span>) == baseAddr.<span class="title function_">add</span>(<span class="number">0x46D103E</span>)) &#123;</span><br><span class="line">    iterator.<span class="title function_">putCallout</span>(<span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;r8: &quot;</span>, context.<span class="property">r8</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title class_">Number</span>(instruction.<span class="property">address</span>) == baseAddr.<span class="title function_">add</span>(<span class="number">0x46D0D72</span>)) &#123;</span><br><span class="line">    iterator.<span class="title function_">putCallout</span>(<span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;r0: &quot;</span>, context.<span class="property">r0</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>發現兩者一致，成功驗證想法。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image37.png" alt="image.png"></p>
<p>handler3是加法操作，對應的arm匯編指令是<code>add</code>，根據<code>get_bit</code>的不同分為寄存器、立即數、左移等情況，還原代碼如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler3_add</span>(<span class="params">opcode</span>):</span><br><span class="line">    b1 = get_bit(<span class="number">0</span>, opcode, <span class="number">25</span>, <span class="number">27</span>)</span><br><span class="line">    out = get_bit(<span class="number">0</span>, opcode, <span class="number">20</span>, <span class="number">25</span>)</span><br><span class="line">    <span class="keyword">if</span> out == <span class="number">15</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;handler3_add 1&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    in1 = get_bit(<span class="number">0</span>, opcode, <span class="number">15</span>, <span class="number">20</span>)</span><br><span class="line">    <span class="keyword">if</span> b1:</span><br><span class="line">        <span class="keyword">if</span> b1 == <span class="number">1</span>:</span><br><span class="line">            in2 = get_bit(<span class="number">0</span>, opcode, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">            asm_str = <span class="string">f&quot;add r<span class="subst">&#123;out&#125;</span>, r<span class="subst">&#123;in1&#125;</span>, r<span class="subst">&#123;in2&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> b1 != <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">&quot;handler3_add 2&quot;</span>)</span><br><span class="line">            in2 = get_bit(<span class="number">0</span>, opcode, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">            lsl = get_bit(<span class="number">0</span>, opcode, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">            asm_str = <span class="string">f&quot;add r<span class="subst">&#123;out&#125;</span>, r<span class="subst">&#123;in1&#125;</span>, r<span class="subst">&#123;in2&#125;</span>, lsl #<span class="subst">&#123;lsl&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        in2 = get_bit(<span class="number">0</span>, opcode, <span class="number">0</span>, <span class="number">15</span>)</span><br><span class="line">        asm_str = <span class="string">f&quot;add r<span class="subst">&#123;out&#125;</span>, r<span class="subst">&#123;in1&#125;</span>, <span class="subst">&#123;in2&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> asm_str</span><br></pre></td></tr></table></figure>

<p><strong>handler10分析：</strong></p>
<p><code>vm_ctx[17~20]</code>剛好可以對應arm的CPSR狀態寄存器的<code>Z</code>、<code>N</code>、<code>C</code>、<code>V</code>位。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image38.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image39.png" alt="image.png"></p>
<p>因此handler10對應的arm匯編指令就是<code>cmp</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler10_cmp</span>(<span class="params">opcode</span>):</span><br><span class="line">    v190 = get_bit(<span class="number">0</span>, opcode, <span class="number">26</span>, <span class="number">27</span>)</span><br><span class="line"></span><br><span class="line">    b = get_bit(<span class="number">0</span>, opcode, <span class="number">21</span>, <span class="number">26</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v190:</span><br><span class="line">        v143 = get_bit(<span class="number">0</span>, opcode, <span class="number">16</span>, <span class="number">21</span>)</span><br><span class="line"></span><br><span class="line">        asm_str = <span class="string">f&quot;cmp r<span class="subst">&#123;b&#125;</span>, r<span class="subst">&#123;v143&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        v143 = get_bit(<span class="number">0</span>, opcode, <span class="number">0</span>, <span class="number">21</span>)</span><br><span class="line"></span><br><span class="line">        asm_str = <span class="string">f&quot;cmp r<span class="subst">&#123;v190&#125;</span>, <span class="subst">&#123;v143&#125;</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> asm_str</span><br></pre></td></tr></table></figure>

<p><strong>handler11分析：</strong></p>
<p>根據CPSR那4個標誌位進行條件跳轉。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image40.png" alt="image.png"></p>
<p>對應arm的<code>beq</code>、<code>bne</code>、<code>bcc</code>等不同的條件跳轉指令。</p>
<p>注：可能還原得不太正確，但基本能用就不管了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler11_bcc</span>(<span class="params">opcode</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> branchs</span><br><span class="line">    <span class="keyword">global</span> branch_maps</span><br><span class="line">    v182 = get_bit(<span class="number">0</span>, opcode, <span class="number">23</span>, <span class="number">27</span>)</span><br><span class="line"></span><br><span class="line">    b_reg = <span class="literal">None</span></span><br><span class="line">    b_addr = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> get_bit(<span class="number">0</span>, opcode, <span class="number">22</span>, <span class="number">23</span>):</span><br><span class="line">        b_reg = get_bit(<span class="number">0</span>, opcode, <span class="number">17</span>, <span class="number">22</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        b_addr = get_bit(<span class="number">0</span>, opcode, <span class="number">0</span>, <span class="number">22</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b_addr <span class="keyword">and</span> b_addr <span class="keyword">not</span> <span class="keyword">in</span> branch_maps:</span><br><span class="line">        branchs.append(b_addr)</span><br><span class="line">        branch_maps[b_addr] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#17: CPSR_Z</span></span><br><span class="line"><span class="comment">#18: CPSR_N</span></span><br><span class="line"><span class="comment">#19: CPSR_C</span></span><br><span class="line"><span class="comment">#20: CPSR_V</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b_reg:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;bx r<span class="subst">&#123;b_reg&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> v182 == <span class="number">0</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;b <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">1</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;beq <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">2</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bne <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">3</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bcc <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">4</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bcs <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">5</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bcc <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">6</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;beq <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">7</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bge <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">8</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;blt <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">9</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;bgt <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> v182 == <span class="number">10</span>:</span><br><span class="line">        asm_str = <span class="string">f&quot;ble <span class="subst">&#123;<span class="built_in">hex</span>(b_addr)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;Error&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> asm_str</span><br></pre></td></tr></table></figure>

<p><strong>handler13分析：</strong></p>
<p>等價於arm的<code>ubfx</code>指令。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image41.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler13_ubfx</span>(<span class="params">opcode</span>):</span><br><span class="line">    <span class="comment"># UBFX  Wd, Wn, #lsb, #width    ; 32-bit general registers</span></span><br><span class="line">    <span class="comment"># 解釋: 從Wn的第lsb位開始提取width位到Wd (https://blog.csdn.net/LQMIKU/article/details/104361219)</span></span><br><span class="line">    </span><br><span class="line">    v182 = get_bit(<span class="number">0</span>, opcode, <span class="number">22</span>, <span class="number">27</span>)</span><br><span class="line">    v168 = get_bit(<span class="number">0</span>, opcode, <span class="number">17</span>, <span class="number">22</span>)</span><br><span class="line">    v134 = get_bit(<span class="number">0</span>, opcode, <span class="number">8</span>, <span class="number">17</span>)</span><br><span class="line">    v135 = get_bit(<span class="number">0</span>, opcode, <span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    asm_str = <span class="string">f&quot;ubfx r<span class="subst">&#123;v182&#125;</span>, r<span class="subst">&#123;v168&#125;</span>, #<span class="subst">&#123;v134&#125;</span>, #<span class="subst">&#123;v135&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> asm_str</span><br></pre></td></tr></table></figure>

<p><strong>handler18分析：</strong></p>
<p>等價於arm的<code>rev</code>指令( 與<code>bswap32</code>功能一樣都是字節翻轉 )。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image42.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler18_rev</span>(<span class="params">opcode</span>):</span><br><span class="line"></span><br><span class="line">    b1 = get_bit(<span class="number">0</span>, opcode, <span class="number">22</span>, <span class="number">27</span>)</span><br><span class="line">    b2 = get_bit(<span class="number">0</span>, opcode, <span class="number">17</span>, <span class="number">22</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b1 == <span class="number">15</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;handler18_rev TODO&quot;</span>)</span><br><span class="line">    asm_str = <span class="string">f&quot;rev r<span class="subst">&#123;b1&#125;</span>, r<span class="subst">&#123;b2&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> asm_str</span><br></pre></td></tr></table></figure>

<p><strong>handler20：</strong></p>
<p>等價於arm的<code>rsb</code>指令。</p>
<p>指令例子：<code>rsb r0, r1, #10</code> == <code>r0 = 10 - r1</code></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image43.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">handler20_rsb</span>(<span class="params">opcode</span>):</span><br><span class="line">    <span class="keyword">global</span> vm_ctx</span><br><span class="line"></span><br><span class="line">    b1 = get_bit(<span class="number">0</span>, opcode , <span class="number">22</span>, <span class="number">27</span>)</span><br><span class="line">    b2 = get_bit(<span class="number">0</span>, opcode , <span class="number">17</span>, <span class="number">22</span>)</span><br><span class="line">    b3 = get_bit(<span class="number">0</span>, opcode , <span class="number">0</span>, <span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> b1 == <span class="number">15</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;handler20_rsb TODO&quot;</span>)</span><br><span class="line"></span><br><span class="line">    asm_str = <span class="string">f&quot;rsb r<span class="subst">&#123;b1&#125;</span>, r<span class="subst">&#123;b2&#125;</span>, #<span class="subst">&#123;b3&#125;</span>&quot;</span></span><br><span class="line">    vm_ctx[b1] = b3 - vm_ctx[b2]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(asm_str)</span><br></pre></td></tr></table></figure>

<h3 id="vm指令還原"><a href="#vm指令還原" class="headerlink" title="vm指令還原"></a>vm指令還原</h3><p>分析完所有handler後，就可以將所有的opcode都還原成arm指令( 4字節的opcode → 4字節的arm指令 )。</p>
<p>以BFS的方式遍歷所有遇到的分支：從<code>0xE50</code>( <code>opcodes[0xE50/4]</code> )開始執行，調用<code>start</code>函數進行指令解析，在<code>start</code>裡會將遇到的所有分支入隊。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image44.png" alt="image.png"></p>
<p><code>start</code>函數如下：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image45.png" alt="image.png"></p>
<p>注：arm沒有<code>r16</code>，但我的<code>asm_str</code>裡會出現<code>r16</code>，因此要將<code>r16</code>替換為其他不用的寄存器，這裡選擇<code>lr</code>。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image46.png" alt="image.png"></p>
<p>還原後的文件記為<code>vm_code</code>，能被IDA順利解析：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image47.png" alt="image.png"></p>
<h2 id="Section0：登錄算法還原"><a href="#Section0：登錄算法還原" class="headerlink" title="Section0：登錄算法還原"></a>Section0：登錄算法還原</h2><p>用Findcrypt插件分析，發現AES算法的特徵。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image48.png" alt="image.png"></p>
<p>與<a target="_blank" rel="noopener" href="https://github.com/manvelmk/AES-Rijndael-Encryption/tree/master">網上找的AES腳本</a>對比，可以看出整體加密結構是一致的，但<code>Sub_Bytes</code>、<code>Shift_Rows</code>等函數的實現就有所不同。</p>
<p>原版AES：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Encrypt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j,round=<span class="number">0</span>;</span><br><span class="line">	<span class="comment">// Copy plaintext to state array</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			state[j][i] = plaintext[i * <span class="number">4</span> + j];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add the first round key to the state before starting the rounds</span></span><br><span class="line">	<span class="built_in">Add_Round_Key</span>(<span class="number">0</span>); </span><br><span class="line">	<span class="comment">// The first rounds-1 rounds are the same</span></span><br><span class="line">	<span class="keyword">for</span> (round = <span class="number">1</span>; round &lt; rounds; round++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Sub_Bytes</span>();</span><br><span class="line">		<span class="built_in">Shift_Rows</span>();</span><br><span class="line">		<span class="built_in">Mix_Columns</span>();</span><br><span class="line">		<span class="built_in">Add_Round_Key</span>(round);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Last round has no Mix_Columns()</span></span><br><span class="line">	<span class="built_in">Sub_Bytes</span>();</span><br><span class="line">	<span class="built_in">Shift_Rows</span>();</span><br><span class="line">	<span class="built_in">Add_Round_Key</span>(rounds);</span><br><span class="line">	<span class="comment">// Copy the state array to output</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">		&#123;</span><br><span class="line">			encrypted[i * <span class="number">4</span> + j] = state[j][i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vm_code</code> IDA偽代碼：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image49.png" alt="image.png"></p>
<p>將一些函數按原版AES重命名後：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image50.png" alt="image.png"></p>
<p>在正式開始算法還原前，需從真實環境提取一組的input、output數據，作為之後測試算法是否正確的依據：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input: <span class="number">01230123012301230123012301230123</span></span><br><span class="line"></span><br><span class="line">res:             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line">c0889100  d5 <span class="number">1</span>d <span class="number">78</span> a3 <span class="number">4f</span> <span class="number">12</span> <span class="number">05</span> <span class="number">88</span> <span class="number">18</span> a2 f8 d5 <span class="number">44</span> <span class="number">56</span> a7 d2  ..x.O.......DV..</span><br><span class="line">c0889110  d5 <span class="number">1</span>d <span class="number">78</span> a3 <span class="number">4f</span> <span class="number">12</span> <span class="number">05</span> <span class="number">88</span> <span class="number">18</span> a2 f8 d5 <span class="number">44</span> <span class="number">56</span> a7 d2  ..x.O.......DV..</span><br></pre></td></tr></table></figure>

<p>接下來是我進行算法還原的思路，僅供參考。</p>
<p>先將IDA的偽代碼扣下來，看看加密結果與真實環境中的是否一致。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image51.png" alt="image.png"></p>
<p>不出所料，果然不一樣，原因可能是vm指令還原那部份出了錯，又或者是IDA的問題，都有可能。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image52.png" alt="image.png"></p>
<p>到底哪裡出了錯暫時不知，先假設vm指令還原那部份沒有出錯，即<code>vm_code</code>的arm匯編指令是正確的，然後調試看看。</p>
<p>如何調試？對於vm指令還原後的程序，應該不存在一種直接調試的手段，我想到的一種思路是借助Unicorn來間接地調試。</p>
<p><strong>注：這裡的調試並非傳統意義上的打斷點 → 單步執行調試，而是偏向於在某條匯編指令執行後，打印某寄存器、hexdump某內存地址，看看數據是否符合預期。</strong></p>
<h3 id="Unicorn輔助調試算法出錯的原因"><a href="#Unicorn輔助調試算法出錯的原因" class="headerlink" title="Unicorn輔助調試算法出錯的原因"></a>Unicorn輔助調試算法出錯的原因</h3><p>先看看Unicorn模擬執行的結果是否與真實環境一致( 沿用上面解混淆的Unicorn代碼 )。</p>
<p>可以看到完全一樣，即模擬執行的環境沒有任何問題。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image53.png" alt="image.png"></p>
<p>定義一些輔助函數，方便調試觀察。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read_vm_reg</span>(<span class="params">emu:Uc, idx</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> g_vmctx:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&quot;g_vmctx == None&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(emu.mem_read(g_vmctx + <span class="number">4</span> * idx, <span class="number">0x4</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hexdump</span>(<span class="params">emu:Uc, addr, <span class="built_in">len</span></span>):</span><br><span class="line">    res = emu.mem_read(addr, <span class="built_in">len</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(res[i])[<span class="number">2</span>:].rjust(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>), end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (i+<span class="number">1</span>) % <span class="number">16</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot; |  <span class="subst">&#123;res[i-<span class="number">15</span>: i+<span class="number">1</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex2str</span>(<span class="params">hexstr: <span class="built_in">str</span></span>):</span><br><span class="line">    hexstr = hexstr.replace(<span class="string">&quot;0x&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>.fromhex(hexstr).decode()[::-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>具體調試思路如下：</p>
<ol>
<li>添加一個<code>UC_HOOK_CODE</code>來hook每條執行的匯編指令，在合適的時機保存<code>vm_ctx</code>。 在<code>bl bswap32_0</code>的下一條匯編這個時機調用<code>on_opcode</code>，這時可以監控執行過程的每個opcode。 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">g_vmctx = <span class="literal">None</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook_code</span>(<span class="params">emu: Uc, addr, size, user_data</span>):</span><br><span class="line">    <span class="keyword">global</span> g_vmctx</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> addr == libUE4_base + <span class="number">0x46CFFBC</span>:</span><br><span class="line">        g_vmctx = emu.reg_read(UC_ARM_REG_R10)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> addr == libUE4_base + <span class="number">0x46D002C</span>:</span><br><span class="line">        on_opcode(emu)</span><br></pre></td></tr></table></figure>
</li>
<li>opcode基本上都會重複，因此要調試<code>vm_code</code>某地址的匯編指令時，要通過2個opcode才能確定。 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">count = -<span class="number">1</span> <span class="comment"># 代表在opcodeA後的第&#123;count&#125;條指令時打印</span></span><br><span class="line">g_addr = <span class="literal">None</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_opcode</span>(<span class="params">emu: Uc</span>):</span><br><span class="line">    <span class="keyword">global</span> count</span><br><span class="line">    <span class="keyword">global</span> g_addr</span><br><span class="line">    opcode = emu.reg_read(UC_ARM_REG_R0)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> count != -<span class="number">1</span>:</span><br><span class="line">        count -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> opcode == <span class="number">0x1ac7b000</span>:</span><br><span class="line">        count = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> count == <span class="number">0</span> <span class="keyword">and</span> opcode == <span class="number">0x38d58300</span>:</span><br><span class="line">        r3 = read_vm_reg(emu, <span class="number">3</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;r3: &quot;</span>, <span class="built_in">hex</span>(r3))</span><br></pre></td></tr></table></figure>
 例子：目標是<code>vm_code</code>裡<code>0x7DC</code>這條匯編指令。 <img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image54.png" alt="image.png"> <code>0x7DC</code>上一條指令對應的opcode為<code>opcodes[0x7D8/4]</code> = <code>0x1ac7b000</code>。 <code>0x7DC</code>對應的opcode為<code>opcodes[0x7DC/4]</code> = <code>0x38d58300</code>。 <img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image55.png" alt="image.png"> 利用<code>0x1ac7b000</code>、<code>0x38d58300</code>這2個opcode就基本能確定是<code>vm_code</code>的<code>0x7DC</code>。</li>
</ol>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image56.png" alt="image.png"></p>
<p>接下來就是找不同的過程，先看<code>aes_key_schedule</code>的結果與本地是否不同。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image57.png" alt="image.png"></p>
<p>按上述調試思路，打印<code>aes_key_schedule</code>的返回值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">on_opcode</span>(<span class="params">emu: Uc</span>):</span><br><span class="line">    <span class="keyword">global</span> count</span><br><span class="line">    <span class="keyword">global</span> g_addr</span><br><span class="line">    opcode = emu.reg_read(UC_ARM_REG_R0)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> count != -<span class="number">1</span>:</span><br><span class="line">        count -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print 0x6F0 return ( save in args[2] )</span></span><br><span class="line">    <span class="keyword">if</span> count == <span class="number">0</span> <span class="keyword">and</span> opcode == <span class="number">0x58000798</span>:</span><br><span class="line">        count = -<span class="number">1</span></span><br><span class="line">        r1 = read_vm_reg(emu, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> g_addr:</span><br><span class="line">            g_addr = r1</span><br><span class="line">    <span class="keyword">if</span> opcode == <span class="number">0x40002000</span>:</span><br><span class="line">        count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> opcode == <span class="number">0x10008800</span>:</span><br><span class="line">        <span class="keyword">if</span> g_addr:</span><br><span class="line">            hexdump(emu, g_addr, <span class="number">0x160</span>)</span><br></pre></td></tr></table></figure>

<p>輸出如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">63</span> 6e <span class="number">65</span> <span class="number">74</span> <span class="number">67</span> <span class="number">74</span> 6e <span class="number">65</span> <span class="number">73</span> <span class="number">65</span> 6d <span class="number">61</span> <span class="number">73</span> <span class="number">66</span> <span class="number">63</span> <span class="number">65</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;cnetgtnesemasfce&#x27;</span>)</span><br><span class="line">2e e1 <span class="number">56</span> 8e <span class="number">49</span> <span class="number">95</span> <span class="number">38</span> eb 3a f0 <span class="number">55</span> 8a <span class="number">49</span> <span class="number">96</span> <span class="number">36</span> ef  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;.\xe1V\x8eI\x958\xeb:\xf0U\x8aI\x966\xef&#x27;</span>)</span><br><span class="line">f1 da c6 <span class="number">89</span> b8 4f fe <span class="number">62</span> <span class="number">82</span> bf ab e8 cb <span class="number">29</span> 9d 07  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\xf1\xda\xc6\x89\xb8O\xfeb\x82\xbf\xab\xe8\xcb)\x9d\x07&#x27;</span>)</span><br><span class="line"><span class="number">34</span> c5 <span class="number">63</span> d3 8c 8a 9d b1 0e <span class="number">35</span> <span class="number">36</span> <span class="number">59</span> c5 1c ab 5e  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;4\xc5c\xd3\x8c\x8a\x9d\xb1\x0e56Y\xc5\x1c\xab^&#x27;</span>)</span><br><span class="line">6c <span class="number">63</span> ff b9 e0 e9 <span class="number">62</span> 08 ee dc <span class="number">54</span> <span class="number">51</span> 2b c0 ff 0f  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;lc\xff\xb9\xe0\xe9b\x08\xee\xdcTQ+\xc0\xff\x0f&#x27;</span>)</span><br><span class="line">1a <span class="number">92</span> <span class="number">45</span> bf fa 7b <span class="number">27</span> b7 <span class="number">14</span> a7 <span class="number">73</span> e6 3f <span class="number">67</span> 8c e9  |  <span class="built_in">bytearray</span>(<span class="string">b&quot;\x1a\x92E\xbf\xfa&#123;\&#x27;\xb7\x14\xa7s\xe6?g\x8c\xe9&quot;</span>)</span><br><span class="line">04 e7 c0 fb fe 9c e7 4c ea 3b <span class="number">94</span> aa d5 5c <span class="number">18</span> <span class="number">43</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x04\xe7\xc0\xfb\xfe\x9c\xe7L\xea;\x94\xaa\xd5\\\x18C&#x27;</span>)</span><br><span class="line">1e e4 8a <span class="number">16</span> e0 <span class="number">78</span> 6d 5a 0a <span class="number">43</span> f9 f0 df 1f e1 b3  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x1e\xe4\x8a\x16\xe0xmZ\nC\xf9\xf0\xdf\x1f\xe1\xb3&#x27;</span>)</span><br><span class="line"><span class="number">73</span> 7a 4a 6e <span class="number">93</span> 02 <span class="number">27</span> <span class="number">34</span> <span class="number">99</span> <span class="number">41</span> de c4 <span class="number">46</span> 5e 3f <span class="number">77</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&quot;szJn\x93\x02\&#x27;4\x99A\xde\xc4F^?w&quot;</span>)</span><br><span class="line"><span class="number">86</span> <span class="number">20</span> <span class="number">12</span> <span class="number">00</span> <span class="number">15</span> <span class="number">22</span> <span class="number">35</span> <span class="number">34</span> 8c <span class="number">63</span> eb f0 ca 3d d4 <span class="number">87</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x86 \x12\x00\x15&quot;54\x8cc\xeb\xf0\xca=\xd4\x87&#x27;</span>)</span><br><span class="line"><span class="number">91</span> <span class="number">54</span> <span class="number">35</span> 7e <span class="number">84</span> <span class="number">76</span> <span class="number">00</span> 4a 08 <span class="number">15</span> eb ba c2 <span class="number">28</span> 3f 3d  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x91T5~\x84v\x00J\x08\x15\xeb\xba\xc2(?=&#x27;</span>)</span><br><span class="line"><span class="number">91</span> <span class="number">54</span> <span class="number">35</span> 7e <span class="number">84</span> <span class="number">76</span> <span class="number">00</span> 4a 08 <span class="number">15</span> eb ba c2 <span class="number">28</span> 3f 3d  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x91T5~\x84v\x00J\x08\x15\xeb\xba\xc2(?=&#x27;</span>)</span><br><span class="line"><span class="number">86</span> <span class="number">20</span> <span class="number">12</span> <span class="number">00</span> <span class="number">15</span> <span class="number">22</span> <span class="number">35</span> <span class="number">34</span> 8c <span class="number">63</span> eb f0 ca 3d d4 <span class="number">87</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x86 \x12\x00\x15&quot;54\x8cc\xeb\xf0\xca=\xd4\x87&#x27;</span>)</span><br><span class="line"><span class="number">73</span> 7a 4a 6e <span class="number">93</span> 02 <span class="number">27</span> <span class="number">34</span> <span class="number">99</span> <span class="number">41</span> de c4 <span class="number">46</span> 5e 3f <span class="number">77</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&quot;szJn\x93\x02\&#x27;4\x99A\xde\xc4F^?w&quot;</span>)</span><br><span class="line">1e e4 8a <span class="number">16</span> e0 <span class="number">78</span> 6d 5a 0a <span class="number">43</span> f9 f0 df 1f e1 b3  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x1e\xe4\x8a\x16\xe0xmZ\nC\xf9\xf0\xdf\x1f\xe1\xb3&#x27;</span>)</span><br><span class="line">04 e7 c0 fb fe 9c e7 4c ea 3b <span class="number">94</span> aa d5 5c <span class="number">18</span> <span class="number">43</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\x04\xe7\xc0\xfb\xfe\x9c\xe7L\xea;\x94\xaa\xd5\\\x18C&#x27;</span>)</span><br><span class="line">1a <span class="number">92</span> <span class="number">45</span> bf fa 7b <span class="number">27</span> b7 <span class="number">14</span> a7 <span class="number">73</span> e6 3f <span class="number">67</span> 8c e9  |  <span class="built_in">bytearray</span>(<span class="string">b&quot;\x1a\x92E\xbf\xfa&#123;\&#x27;\xb7\x14\xa7s\xe6?g\x8c\xe9&quot;</span>)</span><br><span class="line">6c <span class="number">63</span> ff b9 e0 e9 <span class="number">62</span> 08 ee dc <span class="number">54</span> <span class="number">51</span> 2b c0 ff 0f  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;lc\xff\xb9\xe0\xe9b\x08\xee\xdcTQ+\xc0\xff\x0f&#x27;</span>)</span><br><span class="line"><span class="number">34</span> c5 <span class="number">63</span> d3 8c 8a 9d b1 0e <span class="number">35</span> <span class="number">36</span> <span class="number">59</span> c5 1c ab 5e  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;4\xc5c\xd3\x8c\x8a\x9d\xb1\x0e56Y\xc5\x1c\xab^&#x27;</span>)</span><br><span class="line">f1 da c6 <span class="number">89</span> b8 4f fe <span class="number">62</span> <span class="number">82</span> bf ab e8 cb <span class="number">29</span> 9d 07  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;\xf1\xda\xc6\x89\xb8O\xfeb\x82\xbf\xab\xe8\xcb)\x9d\x07&#x27;</span>)</span><br><span class="line">2e e1 <span class="number">56</span> 8e <span class="number">49</span> <span class="number">95</span> <span class="number">38</span> eb 3a f0 <span class="number">55</span> 8a <span class="number">49</span> <span class="number">96</span> <span class="number">36</span> ef  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;.\xe1V\x8eI\x958\xeb:\xf0U\x8aI\x966\xef&#x27;</span>)</span><br><span class="line"><span class="number">63</span> 6e <span class="number">65</span> <span class="number">74</span> <span class="number">67</span> <span class="number">74</span> 6e <span class="number">65</span> <span class="number">73</span> <span class="number">65</span> 6d <span class="number">61</span> <span class="number">73</span> <span class="number">66</span> <span class="number">63</span> <span class="number">65</span>  |  <span class="built_in">bytearray</span>(<span class="string">b&#x27;cnetgtnesemasfce&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>再看本地運算的結果，從第2行開始就不一樣了，由此確定本地的<code>aes_key_schedule</code>實現有問題。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image58.png" alt="image.png"></p>
<p>然後就是漫長地重複上述的調試過程，嘗試找出那個不符合預期的地方。</p>
<p>看了好幾處運算的地方，本地結果與真實環境中都一樣，直到我看到<code>HIBYTE</code>，讓我回想起之前同樣在進行算法還原時，就是被<code>HIBYTE</code>坑了很久，IDA偽代碼中的<code>HIBYTE</code>實際上是<code>BYTE3</code>才對。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image59.png" alt="image.png"></p>
<p>嘗試將所有<code>HIBYTE</code>都改成<code>BYTE3</code>，結果就正確了。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image60.png" alt="image.png"></p>
<h3 id="反推解密算法"><a href="#反推解密算法" class="headerlink" title="反推解密算法"></a>反推解密算法</h3><p>上一小節中成功修復了IDA扣下來的魔改AES加密算法，以此作為根據 + 參考原版AES解密邏輯 + 問GPT很容易可以得出解密算法。</p>
<p>先簡單分析每個函數，看看需不需要改成逆函數用於解密。</p>
<ol>
<li><code>aes_key_schedule</code>：密鑰擴展，不需要改。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">aes_key_schedule</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span>* output)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> m; <span class="comment">// [sp+0h] [bp-28h]</span></span><br><span class="line">    <span class="type">int</span> k; <span class="comment">// [sp+4h] [bp-24h]</span></span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [sp+8h] [bp-20h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+Ch] [bp-1Ch]</span></span><br><span class="line">    <span class="type">int</span>* v8; <span class="comment">// [sp+10h] [bp-18h]</span></span><br><span class="line">    <span class="type">int</span>* v9; <span class="comment">// [sp+14h] [bp-14h]</span></span><br><span class="line">    <span class="type">int</span>* v10; <span class="comment">// [sp+14h] [bp-14h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!a1 || !output)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (a2 != <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    v9 = output;</span><br><span class="line">    v8 = output + <span class="number">44</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">        output[i] = <span class="built_in">bswap32</span>(*(<span class="type">int</span>*)(a1 + <span class="number">4</span> * i));</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">10</span>; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        v9[<span class="number">4</span>] = *v9 ^ ((RijnDael_AES_LONG_3000[(<span class="type">unsigned</span> __int8)<span class="built_in">BYTE2</span>(v9[<span class="number">3</span>])] &lt;&lt; <span class="number">24</span>) | (RijnDael_AES_LONG_3000[<span class="built_in">BYTE1</span>(v9[<span class="number">3</span>])] &lt;&lt; <span class="number">16</span>) | (RijnDael_AES_LONG_3000[(<span class="type">unsigned</span> __int8)v9[<span class="number">3</span>]] &lt;&lt; <span class="number">8</span>) | RijnDael_AES_LONG_3000[<span class="built_in">BYTE3</span>(v9[<span class="number">3</span>])]) ^ dword_1388[j];</span><br><span class="line">        v9[<span class="number">5</span>] = v9[<span class="number">1</span>] ^ v9[<span class="number">4</span>];</span><br><span class="line">        v9[<span class="number">6</span>] = v9[<span class="number">2</span>] ^ v9[<span class="number">5</span>];</span><br><span class="line">        v9[<span class="number">7</span>] = v9[<span class="number">3</span>] ^ v9[<span class="number">6</span>];</span><br><span class="line">        v9 += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = output + <span class="number">40</span>;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">11</span>; ++k)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (m = <span class="number">0</span>; m &lt; <span class="number">4</span>; ++m)</span><br><span class="line">            v8[m] = v10[m];</span><br><span class="line">        v10 -= <span class="number">4</span>;</span><br><span class="line">        v8 += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><code>transpose</code>：只是將輸入轉置一下，不需要改。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">transpose</span><span class="params">(<span class="type">int</span> a1, _BYTE* a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _BYTE* v2; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [sp+0h] [bp-10h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+4h] [bp-Ch]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            v2 = a2++;</span><br><span class="line">            *(_BYTE*)(a1 + <span class="number">4</span> * j + i) = *v2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><code>Add_Round_Key</code>：input異或輪密鑰，不需要改，但傳入的輪密鑰順序要由後→前。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">Add_Round_Key</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span>  <span class="comment">// Add_Round_Key</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [sp+0h] [bp-20h]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+4h] [bp-1Ch]</span></span><br><span class="line">    _DWORD v5[<span class="number">4</span>]; <span class="comment">// [sp+8h] [bp-18h] BYREF</span></span><br><span class="line">    <span class="type">int</span> v6; <span class="comment">// [sp+18h] [bp-8h]</span></span><br><span class="line">    <span class="type">int</span> v7; <span class="comment">// [sp+1Ch] [bp-4h]</span></span><br><span class="line"></span><br><span class="line">    v7 = a1;</span><br><span class="line">    v6 = a2;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            *((_BYTE*)&amp;v5[i] + j) = *(_DWORD*)(v6 + <span class="number">4</span> * j) &gt;&gt; (<span class="number">8</span> * (<span class="number">3</span> - i));</span><br><span class="line">            *(_BYTE*)(v7 + <span class="number">4</span> * i + j) ^= *((_BYTE*)&amp;v5[i] + j);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><code>Sub_Bytes</code>：加密時查詢的是逆S盒，解密時要改成S盒。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">Sub_Bytes</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [sp+0h] [bp-Ch]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+4h] [bp-8h]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">            *(_BYTE*)(a1 + <span class="number">4</span> * i + j) = RijnDael_AES_LONG_inv_3100[*(<span class="type">unsigned</span> __int8*)(j + a1 + <span class="number">4</span> * i)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><code>Shift_Rows</code>：<code>__ROR4__(v3[i], 8 * i)</code>是可逆的，解密時要改成<code>__ROR4__(v3[i], 32 - 8 * i)</code>。 <code>__ROR4__(val, n)</code>解析：將<code>val</code>右移的<code>n</code>位保存下來，然後在<code>val</code>右移後拼到<code>val</code>的高位。 Encrypt：<code>__ROR4__(0xfd84a748, 8)</code>   = <code>0x48fd84a7</code>。 Decrypt：<code>__ROR4__(0x48fd84a7, 24)</code> = <code>0xfd84a748</code>。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">Shift_Rows</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+0h] [bp-18h]</span></span><br><span class="line">    _DWORD v3[<span class="number">4</span>]; <span class="comment">// [sp+4h] [bp-14h] BYREF</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// [sp+14h] [bp-4h]</span></span><br><span class="line"></span><br><span class="line">    v4 = a1;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        v3[i] = <span class="built_in">bswap32</span>(*(_DWORD*)(v4 + <span class="number">4</span> * i));</span><br><span class="line">        v3[i] = __ROR4__(v3[i], <span class="number">8</span> * i);</span><br><span class="line">        *(_BYTE*)(v4 + <span class="number">4</span> * i) = <span class="built_in">BYTE3</span>(v3[i]);  <span class="comment">// nglog: HIBYTE -&gt; BYTE3</span></span><br><span class="line">        *(_BYTE*)(v4 + <span class="number">4</span> * i + <span class="number">1</span>) = <span class="built_in">HIWORD</span>(v3[i]);</span><br><span class="line">        *(_BYTE*)(v4 + <span class="number">4</span> * i + <span class="number">2</span>) = <span class="built_in">BYTE1</span>(v3[i]);</span><br><span class="line">        *(_BYTE*)(v4 + <span class="number">4</span> * i + <span class="number">3</span>) = v3[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><code>Mix_Columns</code>：對矩陣的列進行線性轉換，直接問GPT取得其逆函數。 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">Mix_Columns</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> v1; <span class="comment">// r0</span></span><br><span class="line">    <span class="type">int</span> v3; <span class="comment">// [sp+0h] [bp-48h]</span></span><br><span class="line">    <span class="type">int</span> v4; <span class="comment">// [sp+4h] [bp-44h]</span></span><br><span class="line">    <span class="type">int</span> v5; <span class="comment">// [sp+8h] [bp-40h]</span></span><br><span class="line">    <span class="type">int</span> m; <span class="comment">// [sp+14h] [bp-34h]</span></span><br><span class="line">    <span class="type">int</span> k; <span class="comment">// [sp+18h] [bp-30h]</span></span><br><span class="line">    <span class="type">int</span> j; <span class="comment">// [sp+1Ch] [bp-2Ch]</span></span><br><span class="line">    <span class="type">int</span> i; <span class="comment">// [sp+20h] [bp-28h]</span></span><br><span class="line">    <span class="type">char</span> v10[<span class="number">32</span>]; <span class="comment">// [sp+24h] [bp-24h] BYREF</span></span><br><span class="line">    <span class="type">int</span> v11; <span class="comment">// [sp+44h] [bp-4h]</span></span><br><span class="line"></span><br><span class="line">    v11 = a1;</span><br><span class="line">    v10[<span class="number">0</span>] = <span class="number">2</span>;</span><br><span class="line">    v10[<span class="number">1</span>] = <span class="number">3</span>;</span><br><span class="line">    v10[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">4</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">5</span>] = <span class="number">2</span>;</span><br><span class="line">    v10[<span class="number">6</span>] = <span class="number">3</span>;</span><br><span class="line">    v10[<span class="number">7</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">8</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">9</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">10</span>] = <span class="number">2</span>;</span><br><span class="line">    v10[<span class="number">11</span>] = <span class="number">3</span>;</span><br><span class="line">    v10[<span class="number">12</span>] = <span class="number">3</span>;</span><br><span class="line">    v10[<span class="number">13</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">14</span>] = <span class="number">1</span>;</span><br><span class="line">    v10[<span class="number">15</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j)</span><br><span class="line">            v10[<span class="number">4</span> * i + <span class="number">16</span> + j] = *(_BYTE*)(j + v11 + <span class="number">4</span> * i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">4</span>; ++k)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (m = <span class="number">0</span>; m &lt; <span class="number">4</span>; ++m)</span><br><span class="line">        &#123;</span><br><span class="line">            v5 = <span class="built_in">sub_B64</span>(v10[<span class="number">4</span> * k], v10[m + <span class="number">16</span>]);</span><br><span class="line">            v4 = v5 ^ <span class="built_in">sub_B64</span>(v10[<span class="number">4</span> * k + <span class="number">1</span>], v10[m + <span class="number">20</span>]);</span><br><span class="line">            v3 = v4 ^ <span class="built_in">sub_B64</span>(v10[<span class="number">4</span> * k + <span class="number">2</span>], v10[m + <span class="number">24</span>]);</span><br><span class="line">            v1 = <span class="built_in">sub_B64</span>(v10[<span class="number">4</span> * k + <span class="number">3</span>], v10[m + <span class="number">28</span>]);</span><br><span class="line">            *(_BYTE*)(v11 + <span class="number">4</span> * k + m) = v3 ^ v1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然後嘗試解密登錄的密文，得出結果為<code>dde8cdf098e8434b93f04f86085a88f9</code>。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png" alt="image.png"></p>
<p>輸入後成功進入遊戲。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image62.png" alt="image.png"></p>
<h2 id="Section1：透視和自瞄"><a href="#Section1：透視和自瞄" class="headerlink" title="Section1：透視和自瞄"></a>Section1：透視和自瞄</h2><p>UE4的大體框架如下，實現透視、自瞄所需的變量大致都列了出來。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image63.png" alt="image.png"></p>
<p>圖片來源：<a target="_blank" rel="noopener" href="https://renyili.org/post/game_cheat2/">https://renyili.org/post/game_cheat2/</a></p>
<h3 id="繪圖函數"><a href="#繪圖函數" class="headerlink" title="繪圖函數"></a>繪圖函數</h3><p>繪圖函數用於輸出透視的結果，<code>K2_DrawLine</code>是UE4自帶的繪圖函數，是<code>UCanvas</code>的成員函數。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image64.png" alt="image.png"></p>
<p>用ue4dumper將遊戲所有對象dump下來，記為<code>Objects.txt</code>，在其中搜Canvas，看到有一個<code>DebugCanvasObject</code>。</p>
<p>這代表通過GObject能遍歷到該對象，然後就可以通過它來調用<code>K2_DrawLine</code>。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image65.png" alt="image.png"></p>
<p>只調用一次<code>K2_DrawLine</code>繪制的東西無法長久保留在屏幕上，因此要在一個合適的時機不斷調用<code>K2_DrawLine</code>，這樣繪制的東西才不會立即被刷走。</p>
<p>在SDK裡看到<code>ReceiveDrawHUD</code>函數，hook後發現它會不斷被某處調用，大概每次繪製遊戲屏幕上的信息時會觸發，在這時機調用<code>K2_DrawLine</code>繪制透視信息簡直再合適不過。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image66.png" alt="image.png"></p>
<h3 id="第一種透視思路"><a href="#第一種透視思路" class="headerlink" title="第一種透視思路"></a>第一種透視思路</h3><p>在<code>Objects.txt</code>裡可以看到有兩類的YellowBall，一種是會動的，另一種是固定不動的。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image67.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image68.png" alt="image.png"></p>
<p><code>Sphere4_Blueprint_C</code>類下有<code>Speed</code>屬性，因此它應該就是會動的YellowBall的類。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image69.png" alt="image.png"></p>
<p>無論哪一種，都繼承於<code>AActor</code>，而<code>AActor</code> → <code>RootComponent</code> → <code>RelativeLocation</code>裡保存著座標信息( 世界座標 )。</p>
<p>注：屬性的Offset可以參考SDK裡的，若被魔改過則需要用CE分析看看。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 獲取指定actor座標</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getActorLocation</span>(<span class="params">actor</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">RootComponent</span> = <span class="title function_">ptr</span>(actor).<span class="title function_">add</span>(<span class="title class_">Offset</span>.<span class="property">AActorToRootComponent</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">RelativeLocation</span> = <span class="title class_">RootComponent</span>.<span class="title function_">add</span>(<span class="title class_">Offset</span>.<span class="property">USceneComponentToRelativeLocation</span>);</span><br><span class="line">    <span class="keyword">let</span> x = <span class="title class_">RelativeLocation</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> y = <span class="title class_">RelativeLocation</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> z = <span class="title class_">RelativeLocation</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;x&quot;</span>: x,</span><br><span class="line">        <span class="string">&quot;y&quot;</span>: y,</span><br><span class="line">        <span class="string">&quot;z&quot;</span>: z,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>獲取到目標的世界座標後，要轉換為屏幕座標，第一種轉換方式是借助UE4的透視投影矩陣。</p>
<p>注：透視投影使用透視矩陣將3D場景中的物件轉換到2D屏幕座標系。這個矩陣是透過相機位置和朝向信息計算出來的。</p>
<p>這個矩陣保存在<code>UCanvas</code>的<code>ViewProjectionMatrix</code>，<code>FMatrix</code>是一個4*4的矩陣。</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image70.png" alt="image.png"></p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image71.png" alt="image.png"></p>
<p>用frida或ue4dumper獲取<code>DebugCanvasObject</code>的地址( 假設是0xc0402580 )，然後用CE查看其內存，切換為float類型以便觀察。</p>
<p>當遊戲鏡頭角度發生變化時，紅框的數據也會隨之變化，因此這裡大概就是<code>ViewProjectionMatrix</code>，偏移為0xC0402790 - 0xC0402580 = 0x210</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image72.png" alt="image.png"></p>
<p>知道了偏移後，就能用frida提取<code>ViewProjectionMatrix</code>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 獲取透視投影矩陣, 用於轉換世界座標</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getViewProjectionMatrix</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">DebugCanvasObject</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">ViewProjectionMatrix</span> = <span class="title class_">DebugCanvasObject</span>.<span class="title function_">add</span>(<span class="title class_">Offset</span>.<span class="property">UCanvasToViewProjectionMatrix</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InX</span> = <span class="title class_">ViewProjectionMatrix</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InX</span>_x = <span class="title class_">InX</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InX</span>_y = <span class="title class_">InX</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InX</span>_z = <span class="title class_">InX</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InX</span>_tran = <span class="title class_">InX</span>.<span class="title function_">add</span>(<span class="number">3</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InY</span> = <span class="title class_">ViewProjectionMatrix</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InY</span>_x = <span class="title class_">InY</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InY</span>_y = <span class="title class_">InY</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InY</span>_z = <span class="title class_">InY</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InY</span>_tran = <span class="title class_">InY</span>.<span class="title function_">add</span>(<span class="number">3</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InZ</span> = <span class="title class_">ViewProjectionMatrix</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InZ</span>_x = <span class="title class_">InZ</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InZ</span>_y = <span class="title class_">InZ</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InZ</span>_z = <span class="title class_">InZ</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InZ</span>_tran = <span class="title class_">InZ</span>.<span class="title function_">add</span>(<span class="number">3</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InW</span> = <span class="title class_">ViewProjectionMatrix</span>.<span class="title function_">add</span>(<span class="number">3</span> * <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InW</span>_x = <span class="title class_">InW</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InW</span>_y = <span class="title class_">InW</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InW</span>_z = <span class="title class_">InW</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">InW</span>_tran = <span class="title class_">InW</span>.<span class="title function_">add</span>(<span class="number">3</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        [<span class="title class_">InX</span>_x, <span class="title class_">InX</span>_y, <span class="title class_">InX</span>_z, <span class="title class_">InX</span>_tran],</span><br><span class="line">        [<span class="title class_">InY</span>_x, <span class="title class_">InY</span>_y, <span class="title class_">InY</span>_z, <span class="title class_">InY</span>_tran],</span><br><span class="line">        [<span class="title class_">InZ</span>_x, <span class="title class_">InZ</span>_y, <span class="title class_">InZ</span>_z, <span class="title class_">InZ</span>_tran],</span><br><span class="line">        [<span class="title class_">InW</span>_x, <span class="title class_">InW</span>_y, <span class="title class_">InW</span>_z, <span class="title class_">InW</span>_tran]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>世界座標 → 屏幕座標：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">W2S</span>(<span class="params">W</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> viewProjectionMatrix = <span class="title function_">getViewProjectionMatrix</span>();</span><br><span class="line">    <span class="keyword">if</span>(!viewProjectionMatrix)<span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = [</span><br><span class="line">        viewProjectionMatrix[<span class="number">0</span>][<span class="number">0</span>] * W.<span class="property">x</span> + viewProjectionMatrix[<span class="number">1</span>][<span class="number">0</span>] * W.<span class="property">y</span> + viewProjectionMatrix[<span class="number">2</span>][<span class="number">0</span>] * W.<span class="property">z</span> + viewProjectionMatrix[<span class="number">3</span>][<span class="number">0</span>],</span><br><span class="line">        viewProjectionMatrix[<span class="number">0</span>][<span class="number">1</span>] * W.<span class="property">x</span> + viewProjectionMatrix[<span class="number">1</span>][<span class="number">1</span>] * W.<span class="property">y</span> + viewProjectionMatrix[<span class="number">2</span>][<span class="number">1</span>] * W.<span class="property">z</span> + viewProjectionMatrix[<span class="number">3</span>][<span class="number">1</span>],</span><br><span class="line">        viewProjectionMatrix[<span class="number">0</span>][<span class="number">2</span>] * W.<span class="property">x</span> + viewProjectionMatrix[<span class="number">1</span>][<span class="number">2</span>] * W.<span class="property">y</span> + viewProjectionMatrix[<span class="number">2</span>][<span class="number">2</span>] * W.<span class="property">z</span> + viewProjectionMatrix[<span class="number">3</span>][<span class="number">2</span>],</span><br><span class="line">        viewProjectionMatrix[<span class="number">0</span>][<span class="number">3</span>] * W.<span class="property">x</span> + viewProjectionMatrix[<span class="number">1</span>][<span class="number">3</span>] * W.<span class="property">y</span> + viewProjectionMatrix[<span class="number">2</span>][<span class="number">3</span>] * W.<span class="property">z</span> + viewProjectionMatrix[<span class="number">3</span>][<span class="number">3</span>],</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> r = res[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> rhw = <span class="number">1</span> / r;</span><br><span class="line">        <span class="keyword">let</span> inOutPosition = [];</span><br><span class="line">        inOutPosition[<span class="number">0</span>] = (((res[<span class="number">0</span>] * rhw) / <span class="number">2.0</span>) + <span class="number">0.5</span>) * <span class="number">1280</span>; <span class="comment">// 1280: 通過DrawLine測試出來的寬度</span></span><br><span class="line">        inOutPosition[<span class="number">1</span>] = (<span class="number">0.5</span> - ((res[<span class="number">1</span>] * rhw) / <span class="number">2.0</span>)) * <span class="number">760</span>;  <span class="comment">// 760 : 通過DrawLine測試出來的高度</span></span><br><span class="line">        inOutPosition[<span class="number">2</span>] = r;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inOutPosition;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="第二種透視思路"><a href="#第二種透視思路" class="headerlink" title="第二種透視思路"></a>第二種透視思路</h3><p>用UE4本身的函數<code>ProjectWorldLocationToScreen</code>來實現世界座標 → 屏幕座標。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第2種：世界座標 -&gt; 屏幕座標</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">W2S_2</span>(<span class="params">W</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">ProjectWorldLocationToScreen</span> = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(base.<span class="title function_">add</span>(<span class="number">0x39B8820</span>), <span class="string">&quot;int&quot;</span>, [<span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;float&quot;</span>, <span class="string">&quot;pointer&quot;</span>, <span class="string">&quot;int&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> out = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> res = <span class="title class_">ProjectWorldLocationToScreen</span>(<span class="title class_">PlayerController</span>, W.<span class="property">x</span>, W.<span class="property">y</span>, W.<span class="property">z</span>, out, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="keyword">let</span> x = out.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">        <span class="keyword">let</span> y = out.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line">        <span class="keyword">let</span> z = out.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">readFloat</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [x, y, z]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這種方法轉換後的座標還需進行一些處理才能使用，具體處理參考：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0">https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0</a></p>
<h3 id="自瞄思路"><a href="#自瞄思路" class="headerlink" title="自瞄思路"></a>自瞄思路</h3><p>原理：獲取目標座標與本地座標，利用三角函數計算出兩者間的水平夾角、垂直夾角，然後設置人物相機的<code>ControlRotation</code>為該值即可實現自瞄的效果。</p>
<p>Player對象：<code>PlayerController</code> → <code>AcknowledgedPawn</code>( 它也是繼承於AActor )。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getPlayerLocation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">PlayerController</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">AcknowledgedPawn</span> = <span class="title class_">PlayerController</span>.<span class="title function_">add</span>(<span class="title class_">Offset</span>.<span class="property">APlayerControllerToAcknowledgedPawn</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getActorLocation</span>(<span class="title class_">AcknowledgedPawn</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Player朝向信息：<code>PlayerController</code> → <code>ControlRotation</code>。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 設置相機(人物)角度信息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCameraRotation</span>(<span class="params">loc</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">ControlRotation</span> = <span class="title class_">PlayerController</span>.<span class="title function_">add</span>(<span class="title class_">Offset</span>.<span class="property">AControllerToControlRotation</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setCameraRotation:&quot;</span>, loc)</span><br><span class="line">    <span class="title class_">ControlRotation</span>.<span class="title function_">add</span>(<span class="number">0</span> * <span class="number">4</span>).<span class="title function_">writeFloat</span>(loc[<span class="number">0</span>])   <span class="comment">// 垂直</span></span><br><span class="line">    <span class="title class_">ControlRotation</span>.<span class="title function_">add</span>(<span class="number">1</span> * <span class="number">4</span>).<span class="title function_">writeFloat</span>(loc[<span class="number">1</span>])   <span class="comment">// 水平</span></span><br><span class="line">    <span class="title class_">ControlRotation</span>.<span class="title function_">add</span>(<span class="number">2</span> * <span class="number">4</span>).<span class="title function_">writeFloat</span>(loc[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>自瞄實現：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自瞄實現</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">aimbot</span>(<span class="params">targetLoc</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calcTargetOffset</span>(<span class="params">targetLoc, cameraLoc</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> x = targetLoc.<span class="property">x</span> - cameraLoc.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> y = targetLoc.<span class="property">y</span> - cameraLoc.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">let</span> z = targetLoc.<span class="property">z</span> - cameraLoc.<span class="property">z</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> angleX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> angleY = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) angleX = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) angleX = <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>(y / x)) / <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) angleX = <span class="number">90</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) angleX = <span class="number">90</span> + <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>(x / y)) / <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y == <span class="number">0</span>) angleX = <span class="number">180</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) angleX = <span class="number">180</span> + <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>(y / x)) / <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (x == <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) angleX = <span class="number">270</span>;</span><br><span class="line">        <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) angleX = <span class="number">270</span> + <span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="title class_">Math</span>.<span class="title function_">atan</span>(x / y)) / <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (angleX &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            angleX += <span class="number">360</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (angleX &gt; <span class="number">360</span>) &#123;</span><br><span class="line">            angleX -= <span class="number">360</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        angleY = <span class="title class_">Math</span>.<span class="title function_">atan</span>(z / <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(x * x + y * y)) / <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="number">180</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (angleY &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            angleY += <span class="number">360</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [angleY, angleX, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calcTargetOffset2</span>(<span class="params">targetLoc, cameraLoc</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> dx = targetLoc.<span class="property">x</span> - cameraLoc.<span class="property">x</span>;</span><br><span class="line">        <span class="keyword">let</span> dy = targetLoc.<span class="property">y</span> - cameraLoc.<span class="property">y</span>;</span><br><span class="line">        <span class="keyword">let</span> dz = targetLoc.<span class="property">z</span> - cameraLoc.<span class="property">z</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pi_2 = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">let</span> pitch_range = <span class="number">90.0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> pitch = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(dz, <span class="title class_">Math</span>.<span class="title function_">sqrt</span>(dx * dx + dy * dy)) * (pitch_range / pi_2);</span><br><span class="line">        <span class="keyword">if</span> (pitch &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            pitch += <span class="number">360</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> yaw_range = <span class="number">360</span>;</span><br><span class="line">        <span class="keyword">let</span> yaw = <span class="title class_">Math</span>.<span class="title function_">atan2</span>(dy, dx) * yaw_range / <span class="number">4</span> / pi_2;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (yaw &lt; <span class="number">0.0</span>)&#123;</span><br><span class="line">            yaw += <span class="number">360.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [pitch, yaw, <span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> playerLoc = <span class="title function_">getPlayerLoccation</span>();</span><br><span class="line">    <span class="keyword">let</span> loc = <span class="title function_">calcTargetOffset2</span>(targetLoc, playerLoc);</span><br><span class="line">    <span class="title function_">setCameraRotation</span>(loc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果圖：</p>
<p><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/show2.gif" alt="show2.gif"></p>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0">https://bbs.kanxue.com/thread-281464-1.htm#msg_header_h1_0</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281463.htm">https://bbs.kanxue.com/thread-281463.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-282857.htm">https://bbs.kanxue.com/thread-282857.htm</a></li>
<li><a target="_blank" rel="noopener" href="https://renyili.org/post/game_cheat2/">https://renyili.org/post/game_cheat2/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1930752-1-1.html">https://www.52pojie.cn/thread-1930752-1-1.html</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">NgIokWeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章連結: </span><span class="post-copyright-info"><a href="https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/">https://ngiokweng.github.io/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版權聲明: </span><span class="post-copyright-info">本部落格所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 許可協議。轉載請註明來自 <a href="https://ngiokweng.github.io" target="_blank">NgIokWeng's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android%E9%80%86%E5%90%91/">Android逆向</a></div><div class="post_share"><div class="social-share" data-image="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/"><img class="prev-cover" src="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/image1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">2025吾愛解題領紅包活動(Android題解)</div></div></a></div><div class="next-post pull-right"><a href="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/"><img class="next-cover" src="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/1.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">某盾so加固與修復</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相關推薦</span></div><div class="relatedPosts-list"><div><a href="/2024/05/26/B%E7%AB%99sign%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/" title="B站sign算法分析"><img class="cover" src="/2024/05/26/B%E7%AB%99sign%E7%AE%97%E6%B3%95%E5%88%86%E6%9E%90/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-26</div><div class="title">B站sign算法分析</div></div></a></div><div><a href="/2024/11/20/so%E5%8A%A0%E8%BC%89%E2%80%94relocate%E7%AF%87/" title="so加載—relocate篇"><img class="cover" src="/2024/11/20/so%E5%8A%A0%E8%BC%89%E2%80%94relocate%E7%AF%87/image1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-20</div><div class="title">so加載—relocate篇</div></div></a></div><div><a href="/2024/05/13/bilibili(Frida%E6%AA%A2%E6%B8%AC)/" title="bilibili(Frida檢測)"><img class="cover" src="/2024/05/13/bilibili(Frida%E6%AA%A2%E6%B8%AC)/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-13</div><div class="title">bilibili(Frida檢測)</div></div></a></div><div><a href="/2024/05/27/ollvm_bcf_anti/" title="ollvm_bcf_anti"><img class="cover" src="/2024/05/27/ollvm_bcf_anti/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-27</div><div class="title">ollvm_bcf_anti</div></div></a></div><div><a href="/2024/11/10/%E3%80%90N1CTF2024%E3%80%91ezapk/" title="【N1CTF2024】ezapk"><img class="cover" src="/2024/11/10/%E3%80%90N1CTF2024%E3%80%91ezapk/image1.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-10</div><div class="title">【N1CTF2024】ezapk</div></div></a></div><div><a href="/2024/05/16/%E3%80%90Unity+lua%E6%89%8B%E9%81%8A%E9%80%86%E5%90%91%E3%80%91%E9%81%93%E5%8F%8B%E6%8E%9B%E6%A9%9F%E5%97%8E/" title="【Unity+lua手遊逆向】道友掛機嗎"><img class="cover" src="/2024/05/16/%E3%80%90Unity+lua%E6%89%8B%E9%81%8A%E9%80%86%E5%90%91%E3%80%91%E9%81%93%E5%8F%8B%E6%8E%9B%E6%A9%9F%E5%97%8E/Untitled.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-16</div><div class="title">【Unity+lua手遊逆向】道友掛機嗎</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 評論</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/myImg/blogIcon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">NgIokWeng</div><div class="author-info__description">如果你對目前擁有的一切覺得不滿，等到你擁有更多時，也不見得會快樂</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">標籤</div><div class="length-num">20</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分類</div><div class="length-num">9</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ngiokweng/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目錄</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dump-SDK"><span class="toc-number">2.</span> <span class="toc-text">Dump SDK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UE4%E4%B8%89%E4%BB%B6%E5%A5%97"><span class="toc-number">2.1.</span> <span class="toc-text">UE4三件套</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B5%90%E6%A7%8B%E4%BF%AE%E5%BE%A9"><span class="toc-number">2.2.</span> <span class="toc-text">結構修復</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A4%8E%E4%BF%9D%E8%AD%B7"><span class="toc-number">3.</span> <span class="toc-text">基礎保護</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hook-svc"><span class="toc-number">3.1.</span> <span class="toc-text">hook svc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass%E6%80%9D%E8%B7%AF1"><span class="toc-number">3.2.</span> <span class="toc-text">bypass思路1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass%E6%80%9D%E8%B7%AF2"><span class="toc-number">3.3.</span> <span class="toc-text">bypass思路2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E8%A6%8B%E7%99%BB%E9%8C%84%E9%82%8F%E8%BC%AF"><span class="toc-number">4.</span> <span class="toc-text">初見登錄邏輯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unicorn%E6%A8%A1%E6%93%AC%E5%9F%B7%E8%A1%8C%E8%A7%A3%E6%B7%B7%E6%B7%86"><span class="toc-number">5.</span> <span class="toc-text">Unicorn模擬執行解混淆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B7%B7%E6%B7%86%E6%80%9D%E8%B7%AF"><span class="toc-number">5.1.</span> <span class="toc-text">解混淆思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%B8%8D%E8%B6%B3%E4%B9%8B%E8%99%95"><span class="toc-number">5.2.</span> <span class="toc-text">一些不足之處</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Section0%EF%BC%9A%E7%99%BB%E9%8C%84%E9%82%8F%E8%BC%AF%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">Section0：登錄邏輯分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vm%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.1.</span> <span class="toc-text">vm初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vm%E5%88%86%E6%9E%90"><span class="toc-number">6.2.</span> <span class="toc-text">vm分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vm-handler%E5%88%86%E6%9E%90"><span class="toc-number">6.3.</span> <span class="toc-text">vm handler分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vm%E6%8C%87%E4%BB%A4%E9%82%84%E5%8E%9F"><span class="toc-number">6.4.</span> <span class="toc-text">vm指令還原</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Section0%EF%BC%9A%E7%99%BB%E9%8C%84%E7%AE%97%E6%B3%95%E9%82%84%E5%8E%9F"><span class="toc-number">7.</span> <span class="toc-text">Section0：登錄算法還原</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unicorn%E8%BC%94%E5%8A%A9%E8%AA%BF%E8%A9%A6%E7%AE%97%E6%B3%95%E5%87%BA%E9%8C%AF%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">7.1.</span> <span class="toc-text">Unicorn輔助調試算法出錯的原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E6%8E%A8%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">反推解密算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Section1%EF%BC%9A%E9%80%8F%E8%A6%96%E5%92%8C%E8%87%AA%E7%9E%84"><span class="toc-number">8.</span> <span class="toc-text">Section1：透視和自瞄</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B9%AA%E5%9C%96%E5%87%BD%E6%95%B8"><span class="toc-number">8.1.</span> <span class="toc-text">繪圖函數</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A8%AE%E9%80%8F%E8%A6%96%E6%80%9D%E8%B7%AF"><span class="toc-number">8.2.</span> <span class="toc-text">第一種透視思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A8%AE%E9%80%8F%E8%A6%96%E6%80%9D%E8%B7%AF"><span class="toc-number">8.3.</span> <span class="toc-text">第二種透視思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E7%9E%84%E6%80%9D%E8%B7%AF"><span class="toc-number">8.4.</span> <span class="toc-text">自瞄思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="toc-number">9.</span> <span class="toc-text">參考資料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/" title="記一次對某韓遊的反反調試"><img src="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/image.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="記一次對某韓遊的反反調試"/></a><div class="content"><a class="title" href="/2025/03/18/%E8%A8%98%E4%B8%80%E6%AC%A1%E5%B0%8D%E6%9F%90%E9%9F%93%E9%81%8A%E7%9A%84%E5%8F%8D%E5%8F%8D%E8%AA%BF%E8%A9%A6/" title="記一次對某韓遊的反反調試">記一次對某韓遊的反反調試</a><time datetime="2025-03-18T13:09:27.000Z" title="發表於 2025-03-18 21:09:27">2025-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/" title="2025吾愛解題領紅包活動(Android題解)"><img src="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2025吾愛解題領紅包活動(Android題解)"/></a><div class="content"><a class="title" href="/2025/02/13/2025%E5%90%BE%E6%84%9B%E8%A7%A3%E9%A1%8C%E9%A0%98%E7%B4%85%E5%8C%85%E6%B4%BB%E5%8B%95(Android%E9%A1%8C%E8%A7%A3)/" title="2025吾愛解題領紅包活動(Android題解)">2025吾愛解題領紅包活動(Android題解)</a><time datetime="2025-02-13T01:20:48.000Z" title="發表於 2025-02-13 09:20:48">2025-02-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/" title="2024騰訊遊戲安全大賽安卓決賽(復現)"><img src="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/image61.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="2024騰訊遊戲安全大賽安卓決賽(復現)"/></a><div class="content"><a class="title" href="/2025/01/27/2024%E9%A8%B0%E8%A8%8A%E9%81%8A%E6%88%B2%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B3%BD%E5%AE%89%E5%8D%93%E6%B1%BA%E8%B3%BD(%E5%BE%A9%E7%8F%BE)/" title="2024騰訊遊戲安全大賽安卓決賽(復現)">2024騰訊遊戲安全大賽安卓決賽(復現)</a><time datetime="2025-01-27T09:00:58.000Z" title="發表於 2025-01-27 17:00:58">2025-01-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/" title="某盾so加固與修復"><img src="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="某盾so加固與修復"/></a><div class="content"><a class="title" href="/2025/01/03/%E6%9F%90%E7%9B%BEso%E5%8A%A0%E5%9B%BA%E8%88%87%E4%BF%AE%E5%BE%A9/" title="某盾so加固與修復">某盾so加固與修復</a><time datetime="2025-01-03T15:37:36.000Z" title="發表於 2025-01-03 23:37:36">2025-01-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析"><img src="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/image1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LIAPP手遊保護分析"/></a><div class="content"><a class="title" href="/2024/11/28/LIAPP%E6%89%8B%E9%81%8A%E4%BF%9D%E8%AD%B7%E5%88%86%E6%9E%90/" title="LIAPP手遊保護分析">LIAPP手遊保護分析</a><time datetime="2024-11-28T11:59:08.000Z" title="發表於 2024-11-28 19:59:08">2024-11-28</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By NgIokWeng</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主題 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="閱讀模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="淺色和深色模式轉換"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="單欄和雙欄切換"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="設定"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目錄"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直達評論"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到頂部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '213c1281d4936c27991d',
      clientSecret: 'e52f4c4e54b9993a1226672a59463577a9fd73cd',
      repo: 'ngiokweng.github.io',
      owner: 'ngiokweng',
      admin: ['ngiokweng'],
      id: 'a5951d779c7620180a03ce6fcd96baec',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>